% \iffalse meta-comment
% -*- TeX:DTX -*-
% $Id: microtype.dtx,v 1.1 2004-09-21 22:50:27+02 schlicht Exp schlicht $
% -----------------------------------------------------------------------------
%                      The `microtype' package
%       An interface to the micro-typographic extensions of pdfTeX
%            Copyright (c) 2004 R Schlicht <w.m.l@gmx.net>
%
% This work  may be  distributed and/or modified  under the conditions of
% the LaTeX Project Public License, either version 1.3 of this license or
% (at your option) any later version.  The latest version of this license
% is in:  http://www.latex-project.org/lppl.txt, and version 1.3 or later
% is part of all distributions of LaTeX version 2003/12/01 or later.
%
% This work has the LPPL maintenance status `author-maintained'.
%
% This work consists of the files microtype.dtx and microtype.ins and the
% derived file microtype.sty.
%
% -----------------------------------------------------------------------------
%
%<*driver>
\ProvidesFile{microtype.dtx}%
%</driver>
%<package>\ProvidesPackage{microtype}%
%<*package|driver>
      [2004/09/21 v1.1 Micro-typography with pdfTeX (RS)]
%</package|driver>
%<*config>
%<m-t>\ProvidesFile{microtype.cfg}
%<m-t>         [2004/09/21 v1.1 microtype configuration file (RS)]
%<cmr>\ProvidesFile{mt-cmr.cfg}
%<cmr>         [2004/09/21 v1.1 microtype config. file: Computer Modern (RS)]
%<pad>\ProvidesFile{mt-pad.cfg}
%<pad>         [2004/09/21 v1.1 microtype config. file: Adobe Garamond (RS)]
%<ppl>\ProvidesFile{mt-ppl.cfg}
%<ppl>         [2004/09/21 v1.1 microtype config. file: Palatino (RS)]
%<ptm>\ProvidesFile{mt-ptm.cfg}
%<ptm>         [2004/09/21 v1.1 microtype config. file: Times (RS)]
%<pmn>\ProvidesFile{mt-pmn.cfg}
%<pmn>         [2004/09/15 v1.1 microtype config. file: Adobe Minion (HH)]
%</config>
%
%<*driver>
\documentclass[11pt,a4paper]{ltxdoc}
\usepackage[ansinew]{inputenc}
\usepackage{textcomp}
\usepackage{array}
\IfFileExists{booktabs.sty}{\usepackage{booktabs}}{}
\IfFileExists{url.sty}{\usepackage{url}}{\def\url##1{\texttt{##1}}}
% Let's abolish CM! We use Charter and Letter Gothic
% (for the pre-built documentation on CTAN):
%\def\rmdefault{bch}
%\def\ttdefault{blg}
%\usepackage[T1]{fontenc}
\makeatletter
\def\Describe#1#2#3{%
   \noindent\csname Describe#1\endcsname{#2}{\ttfamily#3\\*[.25\baselineskip]}}
\def\DescribeOption{\leavevmode\@bsphack
   \begingroup\MakePrivateLetters\Describe@Option}
\def\Describe@Option#1{\endgroup
   \marginpar{\raggedleft\PrintDescribeOption{#1}}%
   \SpecialOptionIndex{#1}\@esphack\ignorespaces}
\def\SpecialOptionIndex#1{\@bsphack
   \index{#1\actualchar{\protect\ttfamily#1} (option)\encapchar usage}%
   \index{\quotechar!User Options
      \actualchar{\protect\indexspace\protect\bfseries User Options:}%
      \levelchar{\protect\ttfamily#1}\encapchar usage}%
   \@esphack}
\def\SpecialUsageIndex#1{\@bsphack % index macro descriptions separately, too
   {\index{\quotechar!User Commands
      \actualchar{\protect\bfseries User Commands:}%
      \levelchar\expandafter\@gobble\string#1\actualchar\string\verb
         \quotechar*\verbatimchar\string#1\verbatimchar\encapchar usage}%
    \let\special@index\index\SpecialIndex@{#1}{\encapchar usage}}%
    \@esphack}
\def\PrintDescribeOption#1{\strut \MacroFont\color{theblue}\string #1}
\def\PrintDescribeMacro#1{\strut \MacroFont\color{thegreen}\string #1}
\def\MacroFont{\ttfamily\small}% will be set to \footnotesize before `Implementation'
\def\AltMacroFont{\ttfamily\itshape\footnotesize}
\def\Option#1{{\color{thered}\ttfamily\itshape\small#1}}
\def\OptionV#1{{\color{thered}\rmfamily\itshape\normalsize$\langle$#1$\rangle$}}
\def\Default#1{\underline{#1}}
\def\theCodelineNo{\reset@font\color{thegrey}\scriptsize\arabic{CodelineNo}}
\def\@tempa{bch}
\ifx\rmdefault\@tempa
   \def\pkg#1{\texttt{#1}}
   \def\bfdefault{b}
   \def\Module#1{{\rmfamily\itshape\color{theblue}$\langle$#1$\rangle$}}
   \def\match{\large\raisebox{-.15em}{\textbullet}}
\else
   \def\pkg#1{\textsf{#1}}
   \def\match{\textbullet}
\fi
\def\@biblabel#1{}
\renewcommand{\descriptionlabel}[1]{\hspace\labelsep\normalfont#1}
\long\def\@makecaption#1#2{%
  \vskip\abovecaptionskip
  \sbox\@tempboxa{\small\itshape #1: #2}%
  \hb@xt@\hsize{\hfil\box\@tempboxa\hfil}%
  \vskip\belowcaptionskip}
\makeatother
\frenchspacing
\setlength\hfuzz{25pt}
\setcounter{IndexColumns}{2}
\def\IndexMin{13\baselineskip}
\settowidth\MacroIndent{\scriptsize 000\ }
\def\MacroTopsep{0pt}
\def\MacrocodeTopsep{3pt}
\hyphenation{Har-ders}
% fancy PDF document
\let\pdftrue\empty % \newif doesn't work here
\ifx\pdfoutput\undefined\else\ifx\pdfoutput\relax\else
   \ifcase\pdfoutput\else\let\pdftrue\relax\fi\fi\fi
\ifx\pdftrue\relax
   \usepackage{color}
   \usepackage[
      bookmarks=true,
      colorlinks=true,
      linkcolor=linkcolor,
      urlcolor=linkcolor,
      citecolor=linkcolor,
      hyperindex=false,
      pdfauthor={R Schlicht <w.m.l@gmx.net>},
      pdftitle={The microtype package},
      pdfsubject={An interface to the micro-typographic extension of pdfTeX},
      pdfkeywords={TeX, LaTeX, pdftex, typography, micro-typography,
                   font expansion, character protrusion, margin kerning}
     ]{hyperref}
   \def\usage#1{\textbf{\textit{\hyperpage{#1}}}}% for indexing of \DescribeMacro
   \def\ctanurl#1{\href{http://www.tex.ac.uk/tex-archive#1}{\texttt{#1}}}
   \def\mailto#1{\href{mailto:#1}{\texttt{#1}}}
   \def\mailtoRS{\href{mailto:<w.m.l@gmx.net> R Schlicht?subject=microtype \fileversion}{\texttt{w.m.l@gmx.net}}}
   \definecolor{thegrey}{gray}{0.45}
   \definecolor{thered}{rgb}{0.75,0.00,0.00}
   \definecolor{theblue}{rgb}{0.16,0.24,0.64}
   \definecolor{thegreen}{rgb}{0.18,0.58,0.08}
   \definecolor{linkcolor}{rgb}{0,0,0.42}
\else
   \def\color#1{}
   \def\ctanurl#1{\url{#1}}
   \def\mailto#1{\texttt{#1}}
   \def\mailtoRS{\texttt{w.m.l@gmx.net}}
   \def\texorpdfstring#1#2{#1}
\fi
% some abbreviations
\def\pdftex{pdf\kern.05em\TeX}
\def\thanh{H\`an Th\^e\llap{\raise 0.5ex\hbox{\'{}}} Th\`anh} % the `official' notation
\def\pdf{{\small PDF}}
\def\dvi{{\small DVI}}
\def\nfss{{\small NFSS}}
\def\ctan{{\small CTAN}}
\def\tOne{{\small T1}}
\def\otOne{{\small OT1}}
\def\lyOne{{\small LY1}}
\def\tsOne{{\small TS1}}
\CodelineIndex
%\RecordChanges
\begin{document}
   \DocInput{microtype.dtx}
\end{document}
%</driver>
% \fi
%
% ^^A -------------------------------------------------------------------------
% \changes{v1.0}{2004/09/11}{Initial version.}
% ^^A -------------------------------------------------------------------------
%
%\newif\ifnobooktabs
%\IfFileExists{booktabs.sty}{}{\nobooktabstrue}
%\newcolumntype{L}[1]{p{#1}<{\raggedright}}
%
% \GetFileInfo{microtype.dtx}
% \title{The \pkg{microtype} package\\[.25\baselineskip]\large
%        An interface to the micro-typographic extensions of \pdftex}
% \author{R Schlicht\\\mailtoRS}
% \date{\fileversion\ -- \filedate}
%
% \maketitle
%
%\begin{abstract}
% \noindent The \pkg{microtype} package provides a \LaTeX\ interface to the
% micro-typographic extensions of \pdftex: character protrusion and font
% expansion. It allows to restrict font expansion and/or character protrusion to
% a certain set of fonts, and to configure micro-typographic aspects of the
% fonts in a straight-forward and flexible way. Settings for various fonts are
% provided.\footnote{
% Currently, this package provides settings for: Computer Modern Roman,
% Palatino, Times, Adobe Garamond and Minion as well as some generic settings
% for unknown fonts.}
%
% Note that font expansion and character protrusion does only work with \pdftex,
% at least version 0.14f, resp.\ version 1.20a for automatic font expansion.
%\end{abstract}
%
% \tableofcontents
% \listoftables
%
% \newpage
% \section{Micro-Typography with \texorpdfstring{\pdftex}{pdfTeX}}\label{sec:Micro-Type}
% \pdftex, the \TeX\ extension written by \thanh, introduces two features
% that make it the tool of choice not only for the creation of electronic
% documents but also of works of outstanding time-honoured typography:
% \textit{character protrusion} (also known as margin kerning) and
% \textit{font expansion}. Quoting \thanh's thesis:
%
%\begin{quote}\small
%   \hspace{-.25ex}`Margin kerning is the adjustments of the characters at the
%   margins of a typeset text. A simplified employment of margin kerning is
%   hanging punctuation. Margin kerning is needed for optical alignment of the
%   margins of a typeset text, because mechanical justification of the margins
%   makes them look rather ragged. Some characters can make a line appear
%   shorter to the human eye than others. Shifting such characters by an
%   appropriate amount into the margins would greatly improve the appearance of
%   a typeset text.
%
%   Composing with font expansion is the method to use a wider or narrower
%   variant of a font to make interword spacing more even. A font in a loose
%   line can be substituted by a wider variant so the interword spaces are
%   stretched by a smaller amount. Similarly, a font in a tight line can be
%   replaced by a narrower variant to reduce the amount that the interword
%   spaces are shrunk by. There is certainly a potential danger of font
%   distortion when using such manipulations, thus they must be used with
%   extreme care. The potentiality to adjust a line width by font expansion
%   can be taken into consideration while a paragraph is being broken into
%   lines, in order to choose better breakpoints.' \cite[323]{ThanhThesis}
%\end{quote}
%
% Both these features have been lacking a simple \LaTeX\ user interface for
% quite some time. Then, the \pkg{pdfcprot} package was published
% \cite{pdfcprot}, which allowed \LaTeX\ users to employ character protrusion
% without having to mess much with the internals.
%
% Font expansion, however, was still most difficult to utilize, since it
% required that the font metrics be available in all levels of expansion.
% Therefore, anybody who wanted to use this feature had to create multiple
% instances of the fonts in advance. Shell scripts to somewhat relieve the user
% from this burden were available~-- however, it remained a cumbersome task.
% Furthermore, all fonts were still being physically created, thus wasting
% compilation time and disk space.
%
% In the summer of 2004, \thanh\ implemented a feature that can be expected to
% prove as a major facilitation for \TeX\ and \LaTeX\ users: Font expansion
% can now take place automatically. That is, \pdftex\ no longer needs the
% expanded font metrics but will calculate them at compile-time, and completely
% in memory.
%
% This package provides a simple interface to both font expansion and character
% protrusion.\footnote{ Therefore, it is an alternative, not a supplement, to
% the \pkg{pdfcprot} package. I have decided to include an interface to
% character protrusion in this package, too, because both features are closely
% related, and should not be split over two packages; also, the \pkg{pdfcprot}
% is no longer maintained by its author.} It should be straightforward to
% customize all relevant micro-typographic aspects to your taste and needs. The
% next chapters will present a survey of all options and customization
% possibilities.
%
%
% \section{Invoking the Package}
% There is nothing surprising in loading this package:
%\begin{verbatim}
%\usepackage{microtype}
%\end{verbatim}
%
% Another commonality with many other \LaTeX\ packages is that you can pass
% options to the package in the optional argument to \cs{usepackage}, using the
% well known |key=value| syntax. Multiple values, where allowed, must be
% enclosed in braces.
%
% In the following, I will describe all {\color{theblue}|keys|} and their
% possible \Option{\normalsize values} (the \Option{\normalsize\Default{underlined}}
% value may be omitted in the options list).
% Some values are \mbox{\OptionV{placeholders}}.
%
%
% \subsection{Global Options}
%\Describe{Option}{protrusion}
%   {\Default{\Option{true}}, \Option{false}, \Option{compatibility},
%    \Default{\Option{nocompatibility}}, \OptionV{font set name}}
%\DescribeOption{expansion}
% Both character protrusion and font expansion are \emph{enabled} by default.
% They may be disabled separately from each other by setting the respective key
% to |false|.
%\DescribeOption{activate}
% The |activate| option is a shortcut for setting both |expansion| and
% |protrusion| at the same time. Therefore, the following lines all have
% the same effect:
%\begin{verbatim}
%\usepackage[protrusion=true,expansion=true]{microtype}
%\end{verbatim}
%\begin{verbatim}
%\usepackage[protrusion,expansion]{microtype}
%\end{verbatim}
%\begin{verbatim}
%\usepackage[activate={nocompatibility,true}]{microtype}
%\end{verbatim}
%\begin{verbatim}
%\usepackage{microtype}
%\end{verbatim}
%
% When \pdftex\ employs font expansion and character protrusion, line breaks
% may turn out differently. If that is not desired, you may pass the value
% |compatibility| to the protrusion and/or expansion options.
%
% Finally, you may also specify the name of a font set to which character
% protrusion and/or font expansion should be restricted. See
% chapter~\ref{sec:Sets-Fonts} for a detailed discussion.
%
%\newpage
%\Describe{Option}{DVIoutput}{\Default{\Option{true}}, \Option{false}}
% \pdftex\ is not only able to generate \pdf\ output but can also spit out
% \dvi\ files. The latter behaviour can be ordered by the option |DVIoutput|.
% If you've previously set \cs{pdfoutput} to zero, |DVIoutput| will also be set
% to true.
%
% When producing \dvi\ files, automatic font expansion will not work because
% dvips (resp.\ the \dvi\ viewer) is not able to generate the expanded fonts on
% the fly.
%
%\bigskip
%\Describe{Option}{verbose}{\Default{\Option{true}}, \Option{false}}
% You can get information in the log file on each font being set up, if you
% enable the |verbose| option, which is disabled by default.
%
%\bigskip
%\noindent\Describe{Option}{draft}{\Default{\Option{true}}, \Option{false}}
% If the |draft| option is passed to the package~-- which may also originate
% from the class options~--, font expansion and character protrusion will be
% turned off.
%
% \subsection{Options for Font Expansion}
%\Describe{Option}{auto}{\Default{\Option{true}}, \Option{false}}
% As noted in chapter~\ref{sec:Micro-Type}, font expansion may take place
% automatically. This option is true by default, if \pdftex's version is found
% to be 1.20a or higher. If |auto| is set to false, the fonts for all steps of
% expansion must exist in your \TeX\ installation.
%
%\iffalse ^^A is this true? Buggy!
% Note that if |auto| is true, but expanded fonts do actually exist (with files
% called \meta{font~name}|[+-]|\meta{expansion factor}, e.\,g. |cmr12+10.tfm|
% etc., as described by Thành \cite{ThanhThesis,ThanhTUG}), these fonts
% \emph{will} be used -- only any missing ones will be calculated on the fly.
%\fi
%
%\bigskip
%\Describe{Option}{stretch}{\OptionV{number} (\Default{20})}
%\DescribeOption{shrink}
% You may specify the stretchability and shrinkability of a font, i.\,e.\ the
% maximum amount that a font may stretch or shrink. The \OptionV{number}s will
% be divided by 1000, so that a stretch factor of 10 means that the font may
% expand by up to 1\%.
%
% The default stretch factor is 20. The shrink factor will by default be the
% same as the stretch factor. Therefore, the following lines are equivalent:
%\begin{verbatim}
%\usepackage[stretch=20,shrink=20]{microtype}
%\end{verbatim}
%\begin{verbatim}
%\usepackage[stretch=20]{microtype}
%\end{verbatim}
%\begin{verbatim}
%\usepackage{microtype}
%\end{verbatim}
%
%\medskip
%\Describe{Option}{step}
%   {\OptionV{number} \textrm{(\Default{min(|stretch|,|shrink|)/10})}}
% Font expansion will be applied in discrete steps. For example, if |step| is
% set to~2 (which it is by default), \pdftex\ will try up to ten different
% expansion levels of a font. If you set |stretch| or |shrink| to something
% other than their default value but don't specify |step|, it will be set to
% 1/10th of the smaller value of the two.
%
% \section{User Command}
%\Describe{Macro}{\microtypesetup}{\{\OptionV{key = value list}\}}
% This command may be used anywhere in the document to change the general
% settings of the micro-typographic extensions. It accepts the keys:
% |expansion|, |protrusion| and |activate|, which in turn may receive the
% values |true|, |false|, |compatibility| or |nocompatibility| (but not the
% name of a font set). Thus, you could temporarily disable font expansion by
% saying:
%\begin{verbatim}
%\microtypesetup{expansion=false}
%\end{verbatim}
%
%
% \section{Configuration}
% \subsection{Declaring Font Sets}\label{sec:Sets-Fonts}
% By default, all text fonts that are being used in the document will be subject
% to protrusion and a basic set of fonts to expansion. You may want to
% customize the set of fonts which should get the benefit of micro-typographic
% treatment. This can be achieved by specifying attributes of the font that
% have to be matched for them to be taken into account.
%
%\bigskip
%\Describe{Macro}{\DeclareMicroTypeSet}
%   {[\Option{protrusion}\textbar\Option{expansion}]
%    \{\OptionV{set name}\} \{\OptionV{set of fonts}\}}
%\DescribeMacro{\DeclareMicroTypeSet*}
% This macro declares a new set of fonts to which font expansion or character
% protrusion (or, if no optional argument is given, both) should be applied.
% This set can then be activated by calling:
%\begin{tabbing}\MacroFont
%|\UseMicroTypeSet[|\Option{protrusion}\textbar\Option{expansion}|]{|\OptionV{set name}|}|
%\end{tabbing}
% or by passing the name to the |expansion| resp.\ |protrusion| option when
% loading the package; e.\,g.:
%
%\begin{verbatim}
%\usepackage[protrusion=alltext,expansion=basictext]{microtype}
%\end{verbatim}
%
% The starred version of the command declares \emph{and} activates the font
% set at the same time.
%
% \paragraph{The set of fonts} is specified by assigning values to the \nfss\
% font attributes: encoding, family, series, shape, and size (cf.~\cite{fntguide}).
% Let's start with an example. This package defines a font set called
% `|basictext|' in the configuration file as follows:
%\begin{verbatim}
%\DeclareMicroTypeSet{basictext}
%   { encoding = {T1,OT1,LY1},
%     family   = {rm*,sf*},
%     series   = {m},
%     shape    = {},
%     size     = {normalsize,footnotesize,small,large}
%   }
%\end{verbatim}
% If you now call
%\begin{verbatim}
%\UseMicroTypeSet[expansion]{basictext}
%\end{verbatim}
% in your document's preamble, only fonts in the text encodings \tOne, \otOne\
% or \lyOne, roman or sans serif families, in the normal (or `medium') series,
% and in font sizes called by \cs{normalsize}, \cs{footnotesize}, \cs{small} or
% \cs{large}, will be expanded. Math fonts, on the other hand, will not, since
% they are in a different encoding. Neither will fonts in bold face, or huge
% fonts. Etc. (This font set will be activated for font expansion, if you don't
% activate a different one.)
%
% If an attribute list is left empty -- be it by saying something like
% `|shape={}|', as in the above example, or by not specifying it at all --, it
% does not constitute a restriction. I.\,e., this is equivalent to specifying
% \emph{all} possible values for that attribute.
%
% Therefore, the predefined set `|alltext|', declared like this:
%\begin{verbatim}
%\DeclareMicroTypeSet{alltext}
%   { encoding = {T1,OT1,LY1,TS1} }
%\end{verbatim}
% is far less restrictive. Here, the only condition is the encoding. (This is
% the default font set for character protrusion.)
%
% If a value is followed by an asterisk (like `|rm*|' and `|sf*|' in the example
% above), it does not designate a \nfss\ code, but will expand to the current
% |\|\meta{value}|default|, e.\,g. |\rmdefault|.\footnote{ Note that this
% expansion will take place immediately, so you should make all relevant
% changes \emph{before} loading this package.} For example, if you want to
% include the bold font, too, you should say `|bf*|' instead of `|b|'
% (|\bfdefault| for Computer Modern is `|bx|', while for other fonts, it might
% be `|sb|'). A single asterisk means |\|\meta{characteristic}|default|,
% e.\,g.\ \cs{encodingdefault}, respectively \cs{normalsize} for the size axis.
% Sizes may be either specified as a dimension (|10| or |10pt|), or as a size
% selection command \emph{without} the backslash.
%
% Table~\ref{tab:predefined-font-sets} shows an overview of all predefined
% font sets.
%
%\begin{table}\small
%\begin{tabular}{@{}L{40pt}L{30pt}L{60pt}L{70pt}L{100pt}}
%\ifnobooktabs\hline\else\addlinespace\toprule\addlinespace\fi
%         &|all|& |alltext|      & |basictext|                     & |normalfont|\\
%\ifnobooktabs\hline\else
%     \cmidrule(lr){2-2}\cmidrule(lr){3-3}\cmidrule(lr){4-4}\cmidrule(l){5-5}\fi
% encoding & -- &\tOne, \otOne, \lyOne, \tsOne&\tOne, \otOne, \lyOne&\cs{encodingdefault} \\
% family   & -- & --             & \cs{rmdefault}, \cs{sfdefault}  & \cs{familydefault}   \\
% series   & -- & --             & m                               & \cs{seriesdefault}   \\
% shape    & -- & --             & --                              & \cs{shapedefault}    \\
% size     & -- & --             & \cs{normalsize}, \cs{footnotesize},
%                                  \cs{small}, \cs{large}          & \cs{normalsize}      \\
%\ifnobooktabs\hline\else\bottomrule\fi
%\end{tabular}
%\caption{Predefined font sets}\label{tab:predefined-font-sets}
%\end{table}
%
%\bigskip
%\Describe{Macro}{\UseMicroTypeSet}
%   {[\Option{protrusion}\textbar\Option{expansion}] \{\OptionV{set name}\}}
% Activates a font set defined by \cs{DeclareMicroTypeSet}. By specifying the
% optional argument, you can limit the application of the set to protrusion or
% expansion only.
%
%\bigskip\noindent
% The commands \cs{DeclareMicroTypeSet} and \cs{UseMicroTypeSet} may only be
% used in the preamble or in the main configuration file (cf.\
% chapter~\ref{sub:Config-File}).
%
%
%\newpage
% \subsection{Micro Fine Tuning}
% For typographic reasons, not all characters should be protruded or expanded by
% the same amount. Therefore, you can specify this amount for each character.
% Furthermore, since every font looks different, you will want to be able to do
% this for each font or set of fonts separately.
%
% \subsubsection{Character Protrusion}
%\Describe{Macro}{\SetProtrusion}
%   {[\OptionV{options}] \{\OptionV{set of fonts}\} \{\OptionV{character list}\}}
% Using this macro, you can set the protrusion factors for each character of a
% font or a set of fonts.
%
% A very simple-minded example would be the following:
%
%\begin{verbatim}
%\SetExpansion
%   { encoding = T1,
%     family   = cmr }
%   {  A             = {50,50},
%     \textquoteleft = {700, }  }
%\end{verbatim}
% which would result in the character A being protruded by 5\% on both sides,
% and the left quote character by 70\% into the left margin. This would
% apply to all font shapes, series and sizes of the Computer Modern Roman
% family in encoding~\tOne.
%
% \paragraph{The character list} may contain a number of \meta{character}~=
% \meta{protrusion factors} pairs. Characters can be specified either as a
% single character (`|A|'), as a command that has been defined by
% \cs{DeclareTextSymbol} (`\cs{textquoteleft}'), or as a slot number: three
% digits for decimal notation, prefixed with~|"| for hexadecimal, with~|'| for
% octal (e.\,g.:~|092|, |"5C|, |'134|). \mbox{8-bit} characters may be entered
% directly or in the \LaTeX\ \mbox{7-bit} way of defining them: both |Ä| and
% |\"A| are valid, provided the character is actually included in the encoding.
% You also have the possibility to declare sets of characters which may inherit
% protrusion or expansion factors (see section~\ref{sub:Inherit})
%
% The numbers designate the amount that a character should be protruded into the
% left margin (first value) respectively into the right margin (second value),
% where 1000 means that the character should be kerned fully into the margin,
% while, for example, a value of 50 means that it should be protruded by 5\% of
% its width. Negative values are allowed, as well as numbers larger than 1000.
% You can omit either number, if the character should not be protruded on that
% side, but must not drop the separating comma.
%
% \paragraph{The set of fonts} should be declared using the same syntax of
% \meta{font axis}~|=| \meta{value list} pairs as in the command
% \cs{DeclareMicroTypeSet}.
%
% To determine whether a given font matches the specified set, all combinations
% of font family, series and shape will be tested. The font size will only be
% taken into account if all other criteria match as well. The encoding must
% always match.
%
% Table~\ref{tab:test-order} shows the order in which the combinations of font
% characteristics will be tested.
%
%\begin{table}\centering\small
%\begin{tabular}{@{}l*{8}l@{}}
%\ifnobooktabs\hline\else\addlinespace\toprule\addlinespace\fi
%                 & 1.  & 2.  & 3.  & 4.  & 5.  & 6.  & 7.  & 8. \\
%\ifnobooktabs\hline\else
%   \cmidrule(r){2-2}\cmidrule(r){3-3}\cmidrule(r){4-4}\cmidrule(r){5-5}
%   \cmidrule(r){6-6}\cmidrule(r){7-7}\cmidrule(r){8-8}\cmidrule{9-9}\fi
% encoding & \match & \match & \match & \match & \match & \match & \match & \match\\
% family   & \match & \match & \match & \match & \match & --     & --     & --   \\
% series   & \match & \match & \match & --     & --     & \match & --     & --   \\
% shape    & \match & \match & --     & \match & --     & --     & \match & --   \\
% size     & \match & --     & --     & --     & --     & --     & --     & --   \\
%\ifnobooktabs\hline\else\bottomrule\fi
%\end{tabular}
%\caption{Order for matching font attributes}\label{tab:test-order}
%\end{table}
%
% \paragraph{Optional options:}
%\begin{description}
%   \item[|name|] You may assign a name to the protrusion settings, so that you
%        are able to load it by another set.
%   \item[|load|] You can load another list (provided, you previously assigned
%        a name to it), before the current list will be loaded, so that the
%        fonts will inherit the values from the loaded list.
%\end{description}
% Using this mechanism, you can for instance create a default list for a font;
% settings for other shapes or series can then load these settings, and
% overwrite or extend them (since the value that comes last will take
% precedence). Font settings will be loaded recursively.
%
%
%\newpage
% \subsubsection{Font Expansion}
%\Describe{Macro}{\SetExpansion}
%   {[\OptionV{options}] \{\OptionV{set of fonts}\} \{\OptionV{character list}\}}
% The macro for setting up a font for selected expansion works in a similar way,
% therefore I will only describe the differences to \cs{SetProtrusion} here:
%
% You can only specify one number for each character, which determines the
% amount that a character may be expanded. This parameter can be used to
% restrict expansion of certain characters that are more sensitive to
% deformation.
%
% While the default value for character protrusion is~0~-- that is, if you
% didn't specify any characters, none would be protruded~--, the default value
% for expansion is 1000, which means that all characters would be expanded by
% the same amount.
% The numbers denominate thousandth of the full expansion.
% For example, if you set the expansion factor for the character `O' to 500,
% it will only be expanded or shrunk by one half of the amount that the rest
% of the characters will be expanded or shrunk.
%
%\paragraph{Options}
% Additionally to |name| and |load|, the optional first argument accepts the
% following options: |stretch|, |shrink|, |step|, |auto|.
%
% Using these, you may override the global settings specified in the package
% options. Note that if you don't specify either one of |stretch|, |shrink| and
% |step|, their respective global value will be used (that is, no calculation
% will take place). You could for instance take advantage of these options
% in the following way:
%\begin{verbatim}
%\SetExpansion
%   [ load    = T1-default,
%     stretch = 10 ]
%   { series  = bf*,
%     encoding= T1  }
%   { }
%\end{verbatim}
% This would use the settings for the characters as defined in the list
% |T1-default|, but expand the bold font by a smaller value (compared to the
% default stretch factor of~20).\footnote{ Note, however, that \pdftex\ does
% not allow different expansion limits or steps within one paragraph.}
%
%\bigskip\noindent
% If settings for a font don't exist, font expansion will not be applied to this
% font at all. Should you want all characters to be expanded or shrunk by the
% same amount, declare an empty list for this font, e.\,g.:
%\begin{verbatim}
%\SetExpansion
%   { encoding = T1,
%     family = {pkpx,pkpj}, }
%   { }
%\end{verbatim}
%
%
% \subsection{Character Inheritance}\label{sub:Inherit}
% \Describe{Macro}{\DeclareCharacterInheritance}
%           {\hspace{1em}[\Option{protrusion}\textbar\Option{expansion}]
%           \{\OptionV{font set}\} \{\OptionV{inheritance list}\}}
% In most cases, accented characters should inherit the protrusion resp.\
% expansion factors from the respective base character. For example, all of the
% characters \`A, \'A, \^A, \~A, \"A, \r{A} and \u{A} should probably be
% protruded by the same amount as the character A. Using the command
% \cs{DeclareCharacterInheritance}, you may declare such lists of characters,
% so that you then only have to set up the base characters. Using the optional
% argument, you may confine the scope of the list to protrusion resp.\
% expansion. The font set can be declared in the usual way, with the only
% exception that you must specify exactly one encoding. The inheritance lists
% are to be declared as pairs of \meta{base character} |=| \meta{list of
% inheriting characters}.
%
%\bigskip\noindent
% See the configuration file |microtype.cfg| and the other font-specific files
% for examples of all these commands.
%
% \subsection{Configuration Files}\label{sub:Config-File}
%
% The default configuration will be loaded from the file |microtype.cfg|. You
% may extend this file with custom settings.
%
% However, if you want to create new expansion and protrusion settings for a
% different font family, you should put them into a separate file, whose name
% must be: `|mt-|\meta{font family}|.cfg|', (e.\,g.\ `|mt-pad.cfg|'), and may
% contain \cs{SetProtrusion} and \cs{SetExpansion} commands. These files will
% only be loaded if you are actually using the respective fonts. If the font
% name consists of four characters, the package will also try to find the file
% for the base font family by removing the suffix denoting the sub-family, so
% that you may put settings for the fonts |padx| (expert set), |padj| (oldstyle
% numerals) and |pad| (normal) into one and the same file.
%
% This package ships with configuration files for Computer Modern Roman
% (|mt-cmr.cfg|), Palatino (|mt-ppl.cfg|), the inescapable Times
% (|mt-ptm.cfg|), for Adobe Garamond (|mt-pad.cfg|) and Minion\footnote{
% Courtesy of Harald Harders (\mailto{h.harders@tu-bs.de}).} (|mt-pmn.cfg|).
% If you have created a file for another font and you are willing to share,
% don't hesitate to send it to me so that it can be included in future releases
% of this package.
%
%\bigskip
%\Describe{Macro}{\DeclareMicroTypeAlias}
%    {\{\OptionV{font name}\} \{\OptionV{alias font}\}}
% You may use this command for fonts that are very similar, or actually the
% same (for instance if you did not stick to the Berry naming scheme when
% installing the font). An example would be the Latin Modern fonts which are
% clones of the Computer Modern fonts, so that you probably don't want to
% create new settings for them -- you could say:
%\begin{verbatim}
%\DeclareMicroTypeAlias{lmr}{cmr}
%\end{verbatim}
% which would make the package, whenever it encounters the font |lmr|, pretend
% that it actually found the font |cmr|. In fact, you will find this very line
% in the default configuration file.
%
%
% \section{Caveats}
% \paragraph{Use settings that match your font.} Although the default settings
% do give reasonable results for most fonts, the particular font you happen to
% be using may have different character shapes that necessitate more or less
% protrusion or expansion. In particular italic letter shapes may differ wildly
% in different fonts, hence I have decided against providing default protrusion
% settings for them.
%
% The file |test-microtype.tex| might be of some help when adjusting the
% protrusion settings for a font.
%
% \paragraph{Don't use too large a value for expansion.} Font expansion is a
% feature that is supposed to enhance the typographic quality of your document
% by producing a more uniform greyness of the text block. When expanding or
% shrinking a font too much, the effect will be turned into its opposite.
% Expanding the font by more than 2\%, i.\,e.\ setting a |stretch| factor of
% more than 20, should be justified by a typographically trained eye. If you
% are so lucky as to be in the possession of multiple instances of a Multiple
% Master font, you may set expansion limits to up to 4\%.
%
% \paragraph{Load the \pkg{microtype} package as early as possible.} The
% package will only see fonts the first time they are selected. If a font has
% been called before this package is loaded, it will not be set up for
% protrusion or expansion. (This does not apply to the default font, though.)
%
% \paragraph{Don't use font expansion for web documents.} Because each instance
% of the font will be embedded in the \pdf\ file, the file size may increase
% by quite a large factor (depending on expansion limits and step). Therefore,
% courtesy and thriftiness of bandwidth command it not to enable font expansion
% when creating files to be distributed electronically.
%
%
% \section{Contributions}\label{sec:Contrib}
%
% I would be glad to include configuration files for more fonts.
% Preparing such files is quite a time-consuming task and requires a lot of
% patience. To alleviate this process, this package also includes a test file
% (|test-microtype.tex|) that can be used to check at least the protrusion
% settings.
%
% If you have created a configuration file for another font, or if you have any
% suggestions for enhancements in the default configuration files, you can send
% them to me: \mailtoRS.
%
%
% \section{Acknowledgments}
%
% Harald Harders (\mailto{h.harders@tu-bs.de}) has contributed protrusion
% settings for Adobe Minion. I would also like to thank him for a number of
% suggestions he had to make.
%
%
%\begin{thebibliography}{}
% \bibitem[Th\`anh 2000]{ThanhThesis}
%   \thanh, \emph{Micro-typographic extensions to the \TeX\ typesetting system},
%   \newblock Diss. Masaryk University Brno 2000,
%   \newblock in: \textit{TUGBoat}, vol.~21(2000), no.\ 4, pp.~317--434.
%   \newblock (Online at \url{http://www.tug.org/TUGboat/Articles/tb21-4/tb69thanh.pdf})
%
% \bibitem[Th\`anh 2001]{ThanhTUG}
%   \thanh, \emph{Margin Kerning and Font Expansion with \pdftex},
%   \newblock in: \textit{TUGBoat}, vol.~22(2001), no.\ 3 -- Proceedings of the
%            2001 Annual Meeting, pp.~146--148.
%   \newblock (Online at \url{http://www.tug.org/TUGboat/Articles/tb22-3/tb72thanh.pdf})
%
% \bibitem[\LaTeXe\ font selection]{fntguide}
%   \LaTeX3 Project Team, \emph{\LaTeXe\ font selection},
%   \newblock 10 February 2004.
%   \newblock (Available from \ctan\ at \ctanurl{/macros/latex/doc/fntguide.pdf})
%
% \bibitem[\pkg{pdfcprot}]{pdfcprot}
%   Carsten Schurig, \emph{The |pdfcprot.sty| package},
%   \newblock 14 August 2002.
%   \newblock (Available from \ctan\ in \ctanurl{/macros/latex/contrib/pdfcprot/})
%\end{thebibliography}
%
%
% \StopEventually{
%  \newpage
%  \PrintChanges
%  \PrintIndex
% }
%
%
% ^^A =========================================================================
%
%\DoNotIndex{\@cclv,\@cclvi,\@classoptionslist,\@currext,\@currname,\@defaultunits}
%\DoNotIndex{\@empty,\@expandtwoargs,\@firstofone,\@firstoftwo,\@for,\@gobble}
%\DoNotIndex{\@ifnextchar,\@ifstar,\@ifundefined,\@m,\@ne,\@nil,\@nnil}
%\DoNotIndex{\@onlypreamble,\@ptionlist,\@removeelement,\@secondoftwo}
%\DoNotIndex{\@tempa,\@tempb,\@tempc,\@tempcnta,\@tempcntb,\@tempdima}
%\DoNotIndex{\@unprocessedoptions,\@unusedoptionlist}
%\DoNotIndex{\advance,\begingroup,\catcode,\char,\csname,\def,\divide,\do,\edef}
%\DoNotIndex{\else,\empty,\endcsname,\endgroup,\endinput,\escapechar,\expandafter}
%\DoNotIndex{\fi,\g@addto@macro,\gdef,\global,\hbox,\if,\ifcase,\ifcat,\ifnum}
%\DoNotIndex{\ifx,\let,\loop,\m@ne,\multiply,\newcommand,\newcount,\newif,\next}
%\DoNotIndex{\noexpand,\number,\relax,\renewcommand,\repeat,\romannumeral,\setbox}
%\DoNotIndex{\space,\string,\the,\toks@,\tw@,\undefined,\uppercase,\wd,\x,\xdef,\z@}
%\DoNotIndex{\fontdimen} ^^A \f@encoding,\font@name,\normalfont,\normalsize
%\DoNotIndex{\AtBeginDocument,\AtEndOfPackage,\CurrentOption,\DeclareOption}
%\DoNotIndex{\InputIfFileExists,\MessageBreak,\NeedsTeXFormat,\PackageInfo}
%\DoNotIndex{\PackageError,\PackageWarning,\ProcessOptions,\RequirePackage}
%\DoNotIndex{\AE,\ae,\c,\DH,\dj,\H,\i,\j,\k,\L,\l,\O,\o,\OE,\oe,\r,\SS,\ss,\TH,\u,\v}
%\DoNotIndex{\guillemotleft,\guillemotright,\guilsinglleft,\guilsinglright}
%\DoNotIndex{\quotedblbase,\quotesinglbase,\textacutedbl,\textasciiacute}
%\DoNotIndex{\textasciibreve,\textasciicaron,\textasciidieresis,\textasciigrave}
%\DoNotIndex{\textasciimacron,\textasteriskcentered,\textbraceleft,\textbraceright}
%\DoNotIndex{\textbullet,\textcelsius,\textcolonmonetary,\textcopyright}
%\DoNotIndex{\textdagger,\textdaggerdbl,\textdegree,\textdiv,\textemdash,\textendash}
%\DoNotIndex{\texteuro,\textexclamdown,\textflorin,\textfouroldstyle,\textfractionsolidus}
%\DoNotIndex{\textgravedbl,\textgreater,\textinterrobang,\textinterrobangdown}
%\DoNotIndex{\textlangle,\textlbrackdbl,\textless,\textlnot,\textminus}
%\DoNotIndex{\textoneoldstyle,\textonesuperior,\textordfeminine,\textordmasculine}
%\DoNotIndex{\textparagraph,\textperiodcentered,\textpm,\textquestiondown}
%\DoNotIndex{\textquotedblleft,\textquotedblright,\textquoteleft,\textquoteright}
%\DoNotIndex{\textquotesingle,\textquotestraightbase,\textquotestraightdblbase}
%\DoNotIndex{\textrangle,\textrbrackdbl,\textregistered,\textsevenoldstyle}
%\DoNotIndex{\textthreeoldstyle,\textthreequartersemdash,\textthreesuperior}
%\DoNotIndex{\texttildelow,\texttimes,\texttrademark,\texttwelveudash,\texttwooldstyle}
%\DoNotIndex{\texttwosuperior,\textvisiblespace}
%\DoNotIndex{\/,\\,\",\`,\',\.,\~,\^,\%,\&,\ } ^^A the last five cannot be excluded
%\DoNotIndex{\define@key,\KV@@sp@def,\KVo@tempa,\setkeys} ^^A keyval
%
% ^^A -------------------------------------------------------------------------
%
%\newpage
% \section{Implementation}
%\def\MacroFont{\ttfamily\footnotesize}
%\makeatletter\def\macro@font{\ttfamily\footnotesize}\makeatother
%
% The \pkg{docstrip} modules in this file are:
%\begin{itemize}\setlength{\itemsep}{0pt}
%  \item[|driver|:] The driver file (only visible in the |dtx| file).
%  \item[|package|:] The code for the \pkg{microtype} package.
%  \item[|debug|:] Code for additional output in the log file.\\
%                Used for~-- surprise!~-- debugging purposes.
%  \item[|config|:] Surrounds all configuration modules.
%  \item[|m-t|:] The main configuration file (|microtype.cfg|).
%  \item[|cmr|:] Settings for Computer Modern Roman (|mt-cmr.cfg|).
%  \item[|pad|:] Settings for Adobe Garamond (|mt-pad.cfg|).
%  \item[|ppl|:] Settings for Palatino (|mt-ppl.cfg|).
%  \item[|ptm|:] Settings for Times (|mt-ptm.cfg|).
%  \item[|pmn|:] Settings for Adobe Minion (|mt-pmn.cfg|). \\
%                Contributed by Harald Harders.
%  \item[|auxiliary|:] A helper file that may be used to create and test
%                protrusion settings (|test-microtype.tex|).
%\end{itemize}
%
% \noindent And now for something completely different.
%
%    \begin{macrocode}
%<*package>
\NeedsTeXFormat{LaTeX2e}
\RequirePackage{keyval}
%    \end{macrocode}
%\begin{macro}{\MT@info}
%\begin{macro}{\MT@warning}
%\begin{macro}{\MT@error}
% Save some typing.
%    \begin{macrocode}
\def\MT@info{\PackageInfo{microtype}}
\def\MT@warning{\PackageWarning{microtype}}
\def\MT@error{\PackageError{microtype}}
%    \end{macrocode}
%\end{macro}\end{macro}\end{macro}
%\begin{macro}{\ifMT@DVIoutput}
%\begin{macro}{\ifMT@draft}
%\begin{macro}{\ifMT@verbose}
%\begin{macro}{\ifMT@protrusion}
%\begin{macro}{\ifMT@expansion}
%\begin{macro}{\ifMT@auto}
%\begin{macro}{\MT@expansionlevel}
%\begin{macro}{\MT@protrusionlevel}
%\begin{macro}{\MT@stretch}
%\begin{macro}{\MT@shrink}
%\begin{macro}{\MT@step}
% Declare package options.
%    \begin{macrocode}
\newif\ifMT@DVIoutput
\newif\ifMT@draft
\newif\ifMT@verbose
%<debug>\MT@verbosetrue
\newif\ifMT@protrusion\MT@protrusiontrue
\newif\ifMT@expansion \MT@expansiontrue
\newif\ifMT@auto      \MT@autotrue
\def\MT@expansionlevel{2}
\def\MT@protrusionlevel{2}
\def\MT@stretch{-1}
\def\MT@shrink{-1}
\def\MT@step{-1}
%    \end{macrocode}
%\end{macro}\end{macro}\end{macro}\end{macro}\end{macro}
%\end{macro}\end{macro}\end{macro}\end{macro}\end{macro}\end{macro}
% \subsection{Requirements}
%\begin{macro}{\ifMT@adjustprotcodes}
%\changes{v1.1}{2004/09/13}{bug fix concerning version check
%                           (reported by Harald Harders)}
%\begin{macro}{\ifMT@pdf}
% At first we check whether we are using \pdftex.
%    \begin{macrocode}
\newif\ifMT@pdf
\newif\ifMT@adjustprotcodes\MT@adjustprotcodestrue
\ifx\pdftexversion\undefined\else
   \MT@pdftrue
\fi
%    \end{macrocode}
%\end{macro}\end{macro}
%\begin{macro}{\MT@no@pdftex}
%\begin{macro}{\MT@noprot@pdftex}
%\begin{macro}{\MT@noauto@pdftex}
% \changes{v1.1}{2004/09/13}{issue an error instead of a warning, when \pdftex\
%                            version is too old for autoexpand.}
% Measures in case we don't run \pdftex, or it is too old.
%    \begin{macrocode}
\def\MT@no@pdftex{%
   \MT@warning{%
      You don't seem to be using pdftex. \MessageBreak
      All micro-typographic features will be disabled\@gobble}%
   \def\MT@exitornot{%
      \AtEndOfPackage{\let\@unprocessedoptions\relax}%
      \let\CurrentOption\@empty
      \endinput}%
}
\def\MT@noprot@pdftex{%
   \MT@warning{%
      You are using a pdftex version older than 0.14f.\MessageBreak
      microtype doesn't support such antiquated versions.\MessageBreak
      Please install a newer version of pdftex\@gobble}%
   \def\MT@exitornot{%
      \AtEndOfPackage{\let\@unprocessedoptions\relax}%
      \let\CurrentOption\@empty
      \endinput}%
}
\def\MT@noauto@pdftex{%
   \def\MT@exitornot{%
      \AtEndOfPackage{%
         \ifMT@expansion
            \ifMT@auto
%    \end{macrocode}
% Issue an error message (unless the user has said |auto=false|).
% Otherwise, \pdftex\ would try to create the expanded fonts from sources.
%    \begin{macrocode}
               \MT@error{%
                  You are using a pdftex version older than 1.20a.\MessageBreak
                  Automatic font expansion will not work.\MessageBreak
                  Please install a newer version of pdftex}%
                 {If expanded fonts exist on your system, you can\MessageBreak
                  turn off automatic expansion by passing the option\MessageBreak
                  `auto=false' to the package.}%
              \MT@autofalse
            \fi
            \def\MT@auto{1000 }%
         \fi
      }%
   }%
}
\let\MT@exitornot\relax
%    \end{macrocode}
%\end{macro}\end{macro}\end{macro}
%    \begin{macrocode}
\ifMT@pdf
   \ifnum\pdftexversion < 14
       \MT@noprot@pdftex
   \else
      \ifnum\pdftexversion = 14
         \ifnum \expandafter`\pdftexrevision < `f
            \MT@noprot@pdftex
         \fi
%    \end{macrocode}
% Only \pdftex\ versions 0.14f and 0.14g do not need adjustment of protrusion
% factors. We check here, too, while we're at it.
%    \begin{macrocode}
         \ifnum \expandafter`\pdftexrevision < `h
            \MT@adjustprotcodesfalse
         \fi
      \else
%    \end{macrocode}
% The |autoexpand| feature only works with 1.20a or newer.
%    \begin{macrocode}
         \ifnum\pdftexversion < 120
            \MT@noauto@pdftex
         \else
            \ifnum \expandafter`\pdftexrevision < `a
               \MT@noauto@pdftex
            \fi
         \fi
      \fi
   \fi
\else
   \MT@no@pdftex
\fi
%    \end{macrocode}
% We don't want the user commands to generate an error if we are not running
% \pdftex.
%    \begin{macrocode}
\newcommand{\DeclareMicroTypeSet}[3][]{}
\newcommand{\UseMicroTypeSet}[2][]{}
\newcommand{\DeclareMicroTypeAlias}[2]{}
\newcommand{\SetExpansion}[3][]{}
\newcommand{\SetProtrusion}[3][]{}
\newcommand{\microtypesetup}[1]{}
\newcommand{\DeclareCharacterInheritance}[3][]{}
%    \end{macrocode}
% This command also has a starred version.
%    \begin{macrocode}
\def\DeclareMicroTypeSet{%
   \@ifstar
      {\@ifnextchar[\MT@DeclareSet{\MT@DeclareSet[]}}%
      {\@ifnextchar[\MT@DeclareSet{\MT@DeclareSet[]}}%
}
\def\MT@DeclareSet[#1]#2#3{}
%    \end{macrocode}
% Set configurations are only allowed in the preamble. \cs{SetExpansion} and
% \cs{SetProtrusion}, on the other hand, must be allowed in the document, too,
% since they may be loaded from font configuration files.
%    \begin{macrocode}
\@onlypreamble{\DeclareMicroTypeSet}
\@onlypreamble{\UseMicroTypeSet}
\@onlypreamble{\DeclareMicroTypeAlias}
%    \end{macrocode}
% Now we can take the appropriate actions.
%    \begin{macrocode}
\MT@exitornot
%    \end{macrocode}
% \subsection{Auxiliary macros}
%\begin{macro}{\MT@ifempty}
% \changes{v1.1}{2004/09/15}{bug fix: use catcode 12 for the percent character
%                            (reported by Tom Kink)} ^^A <kink@hia.rwth-aachen.de>
%                                                    ^^A in <MID:2qrkp9F134l6lU1@uni-berlin.de>
% Test whether argument is empty.
%    \begin{macrocode}
\begingroup
\catcode`\%=12\relax
\catcode`\&=14\relax
\gdef\MT@ifempty#1{&
  \if %#1%&
    \expandafter\@firstoftwo
  \else
    \expandafter\@secondoftwo
  \fi}
\endgroup
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@xadd}
% Add item to a list. (Yes, definitions must be global.)
%    \begin{macrocode}
\def\MT@xadd#1#2{%
   \expandafter\ifx#1\relax
      \xdef#1{#2}%
   \else
      \begingroup
         \edef\x{#2}%
         \toks@=\expandafter\expandafter\expandafter{\expandafter#1\x}%
         \xdef#1{\the\toks@}%
      \endgroup
   \fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@in@list}
% Test whether item is in list.
%    \begin{macrocode}
\newif\ifMT@inlist@
\def\MT@in@list#1#2{%
   \MT@inlist@false
   \def\MT@given{#1}%
   \def\MT@lt##1{%
      \def\MT@next{##1}\ifx\MT@next\MT@given\MT@inlist@true\fi}#2%
}
\let\MT@lt\@empty
%    \end{macrocode}
%\end{macro}
%
% \subsection{Setting up a font}
%\begin{macro}{\MT@setupfont}
% Setting up a font means checking whether protrusion/expansion is desired for
% the current font (\cs{font@name}), and if so, adjusting \cs{lpcode},
% \cs{rpcode}, and \cs{efcode}.
%    \begin{macrocode}
\def\MT@setupfont{%
   \ifMT@verbose\MT@info{Setting up font `\font@name'}\fi
%    \end{macrocode}
% The font properties must be extracted from |\font@name|, since the current
% value of \cs{f@encoding} and friends may be wrong! We split up the name here
% (that we have to set \cs{escapechar} to -1 will get us in trouble, see later).
% Why do we have to set it to -1? See |source2e|.
%
% We could save this trouble if we changed \cs{define@newfont}, so that
% \cs{MT@setupfont} would be called inside its group.
%    \begin{macrocode}
   \begingroup
      \escapechar\m@ne
      \expandafter\expandafter\expandafter
         \MT@split@name\expandafter\string\font@name\@nil
   \endgroup
%    \end{macrocode}
% Try to find a configuration file for the current font family.
%    \begin{macrocode}
   \MT@find@file
%    \end{macrocode}
% Protrusion has to be set up first, says Thành!
%    \begin{macrocode}
   \MT@checkfor{protrusion}%
   \ifMT@font@protrusion
      \MT@set@prot@codes
      \else\ifMT@verbose\MT@info{... No protrusion\@gobble}\fi
   \fi
   \MT@checkfor{expansion}%
   \ifMT@font@expansion
      \MT@set@exp@codes
      \else\ifMT@verbose\MT@info{... No expansion\@gobble}\fi
   \fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\ifMT@font@protrusion}
%\begin{macro}{\ifMT@font@expansion}
%\begin{macro}{\MT@checkfor}
% We check all features of the current font against the lists defined by the
% |expansion| resp.\ |protrusion| option, and set \cs{MT@font@expansion} resp.\
% \cs{MT@font@protrusion} accordingly.
%    \begin{macrocode}
\newif\ifMT@font@protrusion
\newif\ifMT@font@expansion
\def\MT@checkfor#1{%
%    \end{macrocode}
% (but only if protrusion/expansion isn't set to false)
%    \begin{macrocode}
   \csname ifMT@#1\endcsname
      \csname MT@font@#1true\endcsname
      \MT@checklist{#1}{encoding}%
      \MT@checklist{#1}{family}%
      \MT@checklist{#1}{series}%
      \MT@checklist{#1}{shape}%
      \MT@checklist{#1}{size}%
   \fi
}
%    \end{macrocode}
%\end{macro}\end{macro}\end{macro}
%\begin{macro}{\MT@checklist}
% If we've already found that a property is not in the list, we don't have to
% bother any more.
%    \begin{macrocode}
\def\MT@checklist#1#2{%
   \csname ifMT@font@#1\endcsname\MT@checklist@{#1}{#2}\fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@checklist@}
%    \begin{macrocode}
\def\MT@checklist@#1#2{%
   \edef\@tempa{\csname MT@#1@setname\endcsname}%
%    \end{macrocode}
% If no limitations have been specified, i.e. the list for a font characteristic
% has not been defined at all, the font should be expanded resp.\ protruded.
%    \begin{macrocode}
   \expandafter\ifx\csname MT@#1list@#2@\@tempa\endcsname\relax
%<debug>      \MT@info{#1: #2 list empty}%
%    \end{macrocode}
% Otherwise, begin a \cs{expandafter} orgy to test whether the font characteristic is
% in the list.
%    \begin{macrocode}
   \else
      \def\MT@listname{\csname MT@#1list@#2@\@tempa\endcsname}%
      \expandafter\expandafter\expandafter\MT@in@list
         \expandafter\expandafter\expandafter
            {\csname MT@#2\endcsname}\MT@listname
      \ifMT@inlist@
%<debug>         \MT@info{#1: #2 `\csname MT@#2\endcsname' in list}%
      \else
         \csname MT@font@#1false\endcsname
%<debug>         \MT@info{#1: #2 `\csname MT@#2\endcsname' not in list}%
      \fi
   \fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{MT@split@name}
% Split up the font name (definitions must be global, since this is, and will
% be, called from inside a group).
%    \begin{macrocode}
{\catcode`\/=12
 \gdef\MT@split@name#1/#2/#3/#4/#5\@nil{%
   \gdef\MT@encoding{#1}%
   \gdef\MT@family{#2}%
   \gdef\MT@series{#3}%
   \gdef\MT@shape{#4}%
   \gdef\MT@size{#5}%
%    \end{macrocode}
% Alias family?
%    \begin{macrocode}
   \expandafter\ifx\csname MT@\MT@family @alias\endcsname\relax\else
      \ifMT@verbose
         \MT@info{... Using alias family name
            `\csname MT@\MT@family @alias\endcsname'\@gobble}%
      \fi
      \MT@escapechar{\csname MT@\MT@family @alias\endcsname}%
      \xdef\MT@family{\MT@val}%
   \fi
}}
%    \end{macrocode}
%\end{macro}
% \subsubsection{Protrusion}
%\begin{macro}{\MT@set@prot@codes}
% This macro is called by \cs{MT@setupfont}, and does all the work for setting
% up a font for protrusion.
%    \begin{macrocode}
\def\MT@set@prot@codes{%
%    \end{macrocode}
% Check which list should be applied to the current font.
%    \begin{macrocode}
   \MT@get@codes@list{prot}%
%    \end{macrocode}
% We might not have found a list.
%    \begin{macrocode}
   \@ifundefined{MT@protcodes@\MT@protcodes@name}{}{%
%    \end{macrocode}
% Get the name of the inheritance list.
%    \begin{macrocode}
      \MT@get@inh@list{protrusion}%
      \ifx\MT@protrusioninh@name\relax\else
         \expandafter\let\expandafter\@tempc
            \csname MT@protrusioninh@\MT@protrusioninh@name\endcsname
         \ifx\@tempc\relax\else
            \ifx\@tempc\@empty\else
               \def\MT@inh@name{\csname MT@protrusioninh@name\endcsname}%
               \expandafter\MT@inhdo\@tempc,\relax,%
            \fi
         \fi
%    \end{macrocode}
% Set to \cs{@empty}, so that we only parse the list once.
%    \begin{macrocode}
         \expandafter\let
            \csname MT@protrusioninh@\MT@protrusioninh@name\endcsname\@empty
      \fi
%    \end{macrocode}
% Load additional lists?
%    \begin{macrocode}
      \MT@load@list{prot}{\MT@protcodes@name}%
%    \end{macrocode}
% Load the main list.
%    \begin{macrocode}
      \expandafter\let\expandafter\@tempc
         \csname MT@protcodes@\MT@protcodes@name\endcsname
      \expandafter\MT@protdo\@tempc,\relax,%
      \MT@adjustprotcode
   }%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@protdo}
%\begin{macro}{\MT@protsplit}
%\begin{macro}{\MT@protsplit@val}
% \changes{v1.1}{2004/09/13}{bug fix: allow zero and negative values}
% Split up the values and set the \cs{rpcode}s and \cs{lpcode}s.
%    \begin{macrocode}
\def\MT@protdo#1,{%
   \ifx\relax#1\empty\else
      \MT@protsplit #1==\relax
      \expandafter\MT@protdo\fi
}
\def\MT@protsplit#1=#2=#3\relax{%
   \KV@@sp@def\@tempa{#1}%
   \ifx\@tempa\@empty\else
      \MT@get@slot
      \KV@@sp@def\@tempb{#2}%
      \ifnum\@tempc < \@cclvi \ifnum\@tempc > \m@ne
         \expandafter\MT@protsplit@val\@tempb\relax
      \fi\fi
   \fi
}
\def\MT@protsplit@val#1,#2\relax{%
   \KV@@sp@def\@tempb{#1}%
   \MT@ifempty{\@tempb}{}{%
      \lpcode\font@name\@tempc=\@tempb
   }%
   \KV@@sp@def\@tempb{#2}%
   \MT@ifempty{\@tempb}{}{%
      \rpcode\font@name\@tempc=\@tempb
   }%
%    \end{macrocode}
% Now we can set the values for the inheriting characters. Their slot numbers
% are saved in the macro |\MT@inh@|\meta{name}|@|\meta{slot}|@|.
%    \begin{macrocode}
   \ifx\MT@protrusioninh@name\relax\else
      \expandafter\ifx
            \csname MT@inh@\MT@protrusioninh@name @\@tempc @\endcsname\relax
         \else\MT@set@prot@children
      \fi
   \fi
}
%    \end{macrocode}
%\end{macro}\end{macro}\end{macro}
%\begin{macro}{\MT@set@prot@children}
% Don't know whether the group is necessary.
%    \begin{macrocode}
\def\MT@set@prot@children{%
   \begingroup
   \def\MT@lt##1{%
%<debug>      \MT@info{-- heir of \@tempc: ##1}%
      \lpcode\font@name##1=\lpcode\font@name\@tempc
      \rpcode\font@name##1=\rpcode\font@name\@tempc
   }%
   \csname MT@inh@\MT@protrusioninh@name @\@tempc @\endcsname
   \endgroup
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@adjustprotcode}
% Since \pdftex\ version 0.14h, we have to adjust the protrusion factors
% (i.\,e., convert numbers from thousandth of character width to thousandth of
% an \emph{em} of the font).
%    \begin{macrocode}
\ifMT@adjustprotcodes
   \def\MT@adjustprotcode{%
      \@tempcnta=\z@
      \loop
         \ifcase\lpcode\font@name\@tempcnta\else
            \MT@@adjustprotcode\lpcode{\font@name}\@tempcnta
         \fi
         \ifcase\rpcode\font@name\@tempcnta\else
            \MT@@adjustprotcode\rpcode{\font@name}\@tempcnta
         \fi
         \advance\@tempcnta \@ne
      \ifnum\@tempcnta < \@cclvi \repeat
   }
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@@adjustprotcode}
% We use code stolen from \thanh's |protcode.tex|.
%    \begin{macrocode}
   \def\MT@@adjustprotcode#1#2#3{%
      \setbox0=\hbox{%
         \ifx#2\font\else#2\fi
         \char#3}%
     %\setbox0=\hbox{\the#2\char#3}%  says pdfcprot.sty
      \@tempcntb=\wd0
      \multiply\@tempcntb #1#2#3%
      \divide\@tempcntb \fontdimen6 #2%
      #1#2#3=\@tempcntb
   }
\else
   \let\MT@adjustprotcode\relax
\fi
%    \end{macrocode}
%\end{macro}
%
% \subsubsection{Expansion}
%\begin{macro}{\MT@set@exp@codes}
% The same for font expansion.
%    \begin{macrocode}
\def\MT@set@exp@codes{%
   \MT@get@codes@list{exp}%
   \@ifundefined{MT@expcodes@\MT@expcodes@name}{}{%
%    \end{macrocode}
% We \emph{could} move \cs{MT@resetefcode} outside of the font check. That would
% mean that a font would be expanded (all characters by the same amount), even
% though there's no list for it. Debatable.
%    \begin{macrocode}
      \MT@resetefcode
      \MT@get@inh@list{expansion}%
      \ifx\MT@expansioninh@name\relax\else
         \expandafter\let\expandafter\@tempc
            \csname MT@expansioninh@\MT@expansioninh@name\endcsname
         \ifx\@tempc\relax\else
            \ifx\@tempc\@empty\else
               \def\MT@inh@name{\csname MT@expansioninh@name\endcsname}%
               \expandafter\MT@inhdo\@tempc,\relax,%
            \fi
         \fi
         \expandafter\let
            \csname MT@expansioninh@\MT@expansioninh@name\endcsname\@empty
      \fi
      \MT@load@list{exp}{\MT@expcodes@name}%
      \expandafter\let\expandafter\@tempc
         \csname MT@expcodes@\MT@expcodes@name\endcsname
      \expandafter\MT@expdo\@tempc,\relax,%
      \MT@get@extraopt
      \pdffontexpand\font@name \MT@stretch@ \MT@shrink@ \MT@step@ \MT@auto@%
   }%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@resetefcode}
% At first, all expansion factors for the characters will be set to 1000.
%    \begin{macrocode}
\def\MT@resetefcode{%
   \@tempcnta\z@
   \loop
      \efcode\font@name\@tempcnta=\@m
      \advance\@tempcnta \@ne
      \ifnum\@tempcnta < \@cclvi \repeat
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@expdo}
% There's only one number per character.
%    \begin{macrocode}
\def\MT@expdo#1,{%
   \ifx\relax#1\empty\else
      \MT@expsplit #1==\relax
      \expandafter\MT@expdo\fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@expsplit}
%    \begin{macrocode}
\def\MT@expsplit#1=#2=#3\relax{%
   \KV@@sp@def\@tempa{#1}%
   \ifx\@tempa\@empty\else
      \MT@get@slot
      \KV@@sp@def\@tempb{#2}%
      \ifnum\@tempc < \@cclvi \ifnum\@tempc > \m@ne
         \efcode\font@name\@tempc=\@tempb
%    \end{macrocode}
% Heirs, heirs, I love thy heirs.
%    \begin{macrocode}
         \ifx\MT@expansioninh@name\relax\else
            \expandafter\ifx
                  \csname MT@inh@\MT@expansioninh@name @\@tempc @\endcsname\relax
               \else\MT@set@exp@children
            \fi
         \fi
      \fi\fi
   \fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@set@exp@children}
%    \begin{macrocode}
\def\MT@set@exp@children{%
   \begingroup
   \def\MT@lt##1{%
%<debug>      \MT@info{heir of \@tempc: ##1}%
      \efcode\font@name##1=\efcode\font@name\@tempc
   }%
   \csname MT@inh@\MT@expansioninh@name @\@tempc @\endcsname
   \endgroup
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@get@extraopt}
% Apply different values to this font?
%    \begin{macrocode}
\def\MT@get@extraopt{%
   \@ifundefined{MT@expcodes@\MT@expcodes@name stretch}%
      {\let\MT@stretch@\MT@stretch}%
      {\expandafter\let\expandafter\MT@stretch@
         \csname MT@expcodes@\MT@expcodes@name stretch\endcsname
       \ifMT@verbose\MT@info{... ... Setting stretch factor to
         \MT@stretch@\@gobble}\fi}%
   \@ifundefined{MT@expcodes@\MT@expcodes@name shrink}%
      {\let\MT@shrink@\MT@shrink}%
      {\expandafter\let\expandafter\MT@shrink@
         \csname MT@expcodes@\MT@expcodes@name shrink\endcsname
       \ifMT@verbose\MT@info{... ... Setting shrink factor to
         \MT@shrink@\@gobble}\fi}%
   \@ifundefined{MT@expcodes@\MT@expcodes@name step}%
      {\let\MT@step@\MT@step}%
      {\expandafter\let\expandafter\MT@step@
         \csname MT@expcodes@\MT@expcodes@name step\endcsname
       \ifMT@verbose\MT@info{... ... Setting step to
         \MT@step@\@gobble}\fi}%
   \@ifundefined{MT@expcodes@\MT@expcodes@name auto}%
      {\let\MT@auto@\MT@auto}%
      {\expandafter\let\expandafter\MT@auto@
         \csname MT@expcodes@\MT@expcodes@name auto\endcsname
       \ifMT@verbose\MT@info{... ... Setting autoexpansion to
         \MT@auto@\@gobble}\fi}%
}
%    \end{macrocode}
%\end{macro}
%
% \subsubsection{Generic macros}
%\begin{macro}{\MT@load@list}
% Recurse through the lists to be loaded.
%    \begin{macrocode}
\def\MT@load@list#1#2{%
   \edef\@tempa{#2}%
   \expandafter\let\expandafter\@tempb\csname MT@#1codes@\@tempa load\endcsname
   \ifx\@tempb\relax\else
      \ifMT@verbose\MT@info{... ... Additionally loading #1. list `\@tempb'\@gobble}\fi
      \begingroup
         \MT@load@list{#1}{\@tempb}%
      \endgroup
      \expandafter\let\expandafter\@tempc\csname MT@#1codes@\@tempb\endcsname
      \expandafter\csname MT@#1do\expandafter\endcsname\@tempc,\relax,%
   \fi
}
%    \end{macrocode}
%\end{macro}
% \changes{v1.1}{2004/09/13}{configuration file names in lowercase
%                            (suggested by Harald Harders)}
%\begin{macro}{\MT@find@file}
% \changes{v1.1}{2004/09/14}{bug fix: also check whether the file for the base
%                            font family has been loaded}
% Micro-typographic settings may be written into a file |mt-|\meta{font family}|.cfg|:
%    \begin{macrocode}
\let\MT@files\@empty
\def\MT@find@file{%
%    \end{macrocode}
% Check for existence of the file only once.
%    \begin{macrocode}
   \expandafter\expandafter\expandafter\MT@in@list
      \expandafter\expandafter\expandafter
         {\csname MT@file@\MT@family\endcsname}\MT@files
   \ifMT@inlist@\else
%    \end{macrocode}
% We have to take care that all characters have the correct category code.
% Especially, new lines and spaces should be ignored, since files might be
% loaded in the middle of the document.
%    \begin{macrocode}
      \begingroup
      \nfss@catcodes
      \InputIfFileExists{mt-\MT@family.cfg}%
         {\MT@xadd\MT@files
            {\noexpand\MT@lt{\csname MT@file@\MT@family\endcsname}}%
          \ifMT@verbose\MT@info{... Loading font settings
            from mt-\MT@family.cfg\@gobble}\fi}%
         {\edef\@tempa{\expandafter\MT@get@basefamily\MT@family\@nil}%
          \expandafter\expandafter\expandafter\MT@in@list
             \expandafter\expandafter\expandafter
                {\csname MT@file@\@tempa\endcsname}\MT@files
          \ifMT@inlist@\else
             \InputIfFileExists{mt-\@tempa.cfg}%
                {\MT@xadd\MT@files
                   {\noexpand\MT@lt{\csname MT@file@\@tempa\endcsname}}%
                 \ifMT@verbose\MT@info{... Loading font settings
                   from mt-\@tempa.cfg\@gobble}\fi}%
                {\MT@xadd\MT@files
                   {\noexpand\MT@lt{\csname MT@file@\MT@family\endcsname}}%
                 \ifMT@verbose\MT@info{... No file mt-\MT@family.cfg\@gobble}\fi}%
          \fi}%
      \endgroup
   \fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@get@basefamily}
% \changes{v1.1}{2004/09/14}{only remove suffix, if it is `x' or `j'}
% The family name might have a suffix for expert or old style number font set
% (|x| or |j|). We mustn't simply remove the last letter, as this would make
% for instance |cmt| out of |cmtt| (OK, |cmex| will still become |cme|~\dots).
%    \begin{macrocode}
\def\MT@get@basefamily#1#2#3#4\@nil{%
   \if#4j#1#2#3\else
      \if#4x#1#2#3\else
         #1#2#3#4\fi\fi}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@get@listname}
% \changes{v1.1}{2004/09/15}{no longer check for empty characteristics list}
% Try all combinations of font family, series and shape to get a list for the
% current font.
%    \begin{macrocode}
\def\MT@get@listname#1{%
   \edef\@tempa{\MT@encoding/\MT@family/\MT@series/\MT@shape/\MT@size}%
%<debug>   \MT@info{trying to find #1. list for font \@tempa}%
   \@ifundefined{MT@#1@\@tempa}{%
      \edef\@tempa{\MT@encoding/\MT@family/\MT@series/\MT@shape/}%
%<debug>      \MT@info{trying \@tempa}%
      \@ifundefined{MT@#1@\@tempa}{%
         \edef\@tempa{\MT@encoding/\MT@family/\MT@series//}%
%<debug>         \MT@info{trying \@tempa}%
         \@ifundefined{MT@#1@\@tempa}{%
            \edef\@tempa{\MT@encoding/\MT@family//\MT@shape/}%
%<debug>            \MT@info{trying \@tempa}%
            \@ifundefined{MT@#1@\@tempa}{%
               \edef\@tempa{\MT@encoding/\MT@family///}%
%<debug>               \MT@info{trying \@tempa}%
               \@ifundefined{MT@#1@\@tempa}{%
                  \edef\@tempa{\MT@encoding//\MT@series//}%
%<debug>                  \MT@info{trying \@tempa}%
                  \@ifundefined{MT@#1@\@tempa}{%
                     \edef\@tempa{\MT@encoding///\MT@shape/}%
%<debug>                     \MT@info{trying \@tempa}%
                     \@ifundefined{MT@#1@\@tempa}{%
                        \edef\@tempa{\MT@encoding////}%
%<debug>                        \MT@info{trying \@tempa}%
   }{}}{}}{}}{}}{}}{}}{}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@get@codes@list}
%\begin{macro}{\MT@get@inh@list}
%    \begin{macrocode}
\def\MT@get@codes@list#1{%
   \MT@get@listname{#1codes}%
   \@ifundefined{MT@#1codes@\@tempa}%
      {\expandafter\let\expandafter\@tempb\csname MT@#1codes@name\endcsname
       \expandafter\let\csname MT@#1codes@\@tempb\endcsname\relax
       \MT@warning{I cannot find an #1. list for `\font@name'.\MessageBreak
            Switching off #1. for this font}}%
      {\expandafter\edef\csname MT@#1codes@name\endcsname
         {\csname MT@#1codes@\@tempa\endcsname}%
       \ifMT@verbose
         \MT@info{... Using #1. list `\csname MT@#1codes@name\endcsname'\@gobble}%
       \fi}%
}
\def\MT@get@inh@list#1{%
   \MT@get@listname{#1inh}%
   \@ifundefined{MT@#1inh@\@tempa}%
      {\expandafter\let\csname MT@#1inh@name\endcsname\relax}%
      {\expandafter\edef\csname MT@#1inh@name\endcsname
         {\csname MT@#1inh@\@tempa\endcsname}%
%<debug>       \ifMT@verbose\MT@info{... Using #1 inheritance list
%<debug>             `\csname MT@#1inh@name\endcsname'\@gobble}\fi
     }%
}
%    \end{macrocode}
%\end{macro}\end{macro}
%\begin{macro}{\MT@get@slot}
% Get the slot number of the character in the current encoding. There are three
% possibilities:
%    \begin{macrocode}
\def\MT@get@slot{%
   \let\@tempc\@cclvi
%    \end{macrocode}
%\begin{enumerate}
% \item The character is either specified as a three-digit number; \dots
%    \begin{macrocode}
   \expandafter\MT@get@number\@tempa\relax\relax
   \ifnum\@tempc < \@cclvi\else
%    \end{macrocode}
% Well, it may also be a backslash, which would be recognized as a command~\dots
%    \begin{macrocode}
      \expandafter\ifx\@tempa\ \relax
         \edef\@tempc{\number`\\}%
%    \end{macrocode}
% \item as a command declared by \cs{DeclareTextSymbol};
%    \begin{macrocode}
      \else
         \expandafter\ifcat\expandafter\noexpand\@tempa\relax
%    \end{macrocode}
% Fortunately, we can assume that the command actually exists in the current
% encoding. Therefore, we can simply call |\|\meta{encoding}|\|\meta{command}
% instead of |\|\meta{command} itself, which might expand to funny stuff,
% depending on context.
%
% We have to reset the escapechar, since it might be -1. Then we check whether
% the command is defined in the current encoding. We should also test whether it
% has been declared by \cs{DeclareTextSymbol}, i.\,e.\ whether it expands to
% |\char"|\meta{hex number} \dots\ better error handling remains TO DO.
%    \begin{macrocode}
            \begingroup\escapechar=`\\
            \expandafter\expandafter\expandafter
                  \ifx\expandafter\csname\expandafter\MT@encoding
                        \expandafter\string\@tempa\endcsname\relax
               \MT@warning{\expandafter\string\@tempa\space
                           is undefined in encoding `\MT@encoding'}%
            \else
               \xdef\@tempc{\expandafter\number
                     \expandafter\csname\expandafter\MT@encoding
                           \expandafter\string\@tempa\endcsname}%
            \fi
            \endgroup
         \else
%    \end{macrocode}
% \item  or by itself (e.\,g.\ `|A|', or `|\"A|').
%    \begin{macrocode}
            \expandafter\MT@two@tokens\@tempa\relax\relax
            \expandafter\edef\expandafter\@tempc\expandafter
                  {\expandafter\number\expandafter`\@tempa}%
         \fi
      \fi
   \fi
}
%    \end{macrocode}
%\end{enumerate}
%\end{macro}
%\begin{macro}{\MT@two@tokens}
% If we find two tokens, expand them to get the actual character.
%    \begin{macrocode}
\def\MT@two@tokens#1#2\relax{%
   \MT@ifempty{#2}{}%
      {\edef\@tempa{\@tempa}}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@get@number}
% \changes{v1.1}{2004/09/13}{numbers may also be specified in hexadecimal or octal
%                            (suggested by Harald Harders).}
% Numbers may be specified as a three-digit decimal number (|092|), as a
% hexidecimal number (prefixed with~|"|: |"5C|) or as a octal number (prefixed
% with~|'|: |'134|).
%    \begin{macrocode}
\def\MT@get@number#1#2#3\relax{%
   \ifx\relax#3\relax\else
      \if#1"\relax
         \def\@tempc{\uppercase{\edef\@tempc{\number#1#2#3}}}%
         \@tempc
      \else
         \if#1'\relax
            \def\@tempc{\number#1#2#3}%
         \else
            \ifnum9<1#1\relax
               \def\@tempc{\number#1#2#3}%
            \fi
         \fi
      \fi
      \ifnum\@tempc > \@cclv
         \MT@warning{Character number \@tempc\space larger than 255! Ignoring it}%
         \let\@tempc\m@ne
      \fi
   \fi
}
%    \end{macrocode}
%\end{macro}
%
% \subsubsection{Changes to \LaTeX's font selection scheme}
% We add \cs{MT@setupfont} to \cs{define@newfont}, which is called by \LaTeX\
% whenever a font is selected that has previously not been declared. This
% ensures that we will catch all fonts, and that we will not set up fonts more
% than once.
%
% In contrast to the \pkg{pdfcprot} package, there is no need to declare the
% fonts in advance that shall be subject to micro-typography. Also, only those
% fonts that are actually being used will be set up for expansion and
% protrusion, thus saving time and memory.
%
% For my reference:
%\begin{itemize}
%  \item \cs{pickup@font} calls \cs{define@newfont}.
%  \item \cs{define@newfont} may call
%  \begin{itemize}
%     \item \cs{wrong@fontshape}, which in turn will call \cs{pickup@font},
%        and thus \cs{define@newfont} again, or
%     \item \cs{extract@font}.
%  \end{itemize}
%  \item \cs{pickup@font} is called by \cs{wrong@fontshape}, \cs{selectfont},
%     or \cs{getanddefine@fonts} (for math).
%\end{itemize}
%
% It \emph{might} be better to use \cs{pickup@font} for our purposes and check
% for ourselves whether we've seen the font before. I'll wait for bug reports~\dots
%    \begin{macrocode}
\g@addto@macro\define@newfont{%
   \MT@setupfont
}
%    \end{macrocode}
% We make sure that the default font is set up, too.
%    \begin{macrocode}
\AtBeginDocument{%
   \normalfont\MT@setupfont
}
%    \end{macrocode}
%
% \subsection{Configuration}
% \subsubsection{Font Sets}
%\begin{macro}{\DeclareMicroTypeSet}
%\begin{macro}{\DeclareMicroTypeSet*}
% Calling this macro will create a list for every font characteristic of the form:
% |\MT|\meta{|expansion|\textbar|protrusion|}|list@|\meta{characteristic}|@|\meta{set name}.
% If the optional macro is empty, lists for both expansion and protrusion will
% be created.
%
% The third argument must be a list of |key=value| pairs. If a font characteristic
% is unspecified, we define the corresponding list to \cs{relax}, so that it
% does not constitute a constraint.
%
% The internal list will be of the form |\MT@lt {|\meta{var1}|} \MT@lt {|\meta{var2}|} ... |,
% where |\MT@lt| acts as the delimiter between the list entries.
%    \begin{macrocode}
\def\DeclareMicroTypeSet{%
   \@ifstar
      {\@ifnextchar[%]
         \MT@DeclareSetAndUseIt
         {\MT@DeclareSetAndUseIt[]}}%
      {\@ifnextchar[%]
         \MT@DeclareSet
         {\MT@DeclareSet[]}}%
}
%    \end{macrocode}
%\end{macro}\end{macro}
%\begin{macro}{\MT@DeclareSet}
%    \begin{macrocode}
\def\MT@DeclareSet[#1]#2#3{%
   \MT@DeclareSet@{#1}{#2}{#3}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@DeclareSetAndUseIt}
%    \begin{macrocode}
\def\MT@DeclareSetAndUseIt[#1]#2#3{%
   \MT@DeclareSet@{#1}{#2}{#3}%
   \UseMicroTypeSet[#1]{#2}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@DeclareSet@}
% \changes{v1.1}{2004/09/15}{remove spaces around first argument}
%    \begin{macrocode}
\def\MT@DeclareSet@#1#2#3{%
  \KV@@sp@def\@tempa{#1}%
  \MT@ifempty{\@tempa}%
    {\MT@declare@sets{expansion}{#2}{#3}%
     \MT@declare@sets{protrusion}{#2}{#3}}%
    {\expandafter\MT@declare@sets\expandafter{\@tempa}{#2}{#3}}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@declare@sets}
% \changes{v1.1}{2004/09/20}{remove spaces around set name}
% Define the current set name and parse the keys.
%    \begin{macrocode}
\def\MT@declare@sets#1#2#3{%
   \KV@@sp@def\@tempa{#2}%
   \expandafter\def\expandafter\MT@tmp@setname\expandafter{\@tempa}%
   \expandafter\let\csname MT@#1list@@\MT@tmp@setname\endcsname\@empty
%<debug>   \MT@info{declaring #1 set `\MT@tmp@setname'}%
   \setkeys{MT#1@set}{#3}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@define@set@keys}
% Define the \pkg{keyval} keys for expansion and protrusion sets.
%    \begin{macrocode}
\def\MT@define@set@keys#1{%
   \MT@define@set@key{#1}{encoding}%
   \MT@define@set@key{#1}{family}%
   \MT@define@set@key{#1}{series}%
   \MT@define@set@key{#1}{shape}%
   \MT@define@set@key@size{#1}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@define@set@key}
% \meta{\#1} = [|expansion|\textbar|protrusion|], \meta{\#2} = font axis,
%    \begin{macrocode}
\def\MT@define@set@key#1#2{%
   \define@key{MT#1@set}{#2}[]{%
      \@for\MT@val:=##1\do{%
%    \end{macrocode}
% Get rid of spaces.
%    \begin{macrocode}
         \expandafter\KV@@sp@def\expandafter\MT@val\expandafter{\MT@val}%
         \MT@get@highlevel{#2}%
         \MT@escapechar{\MT@val}%
         \MT@addto@list{#1}{#2}{\MT@val}%
      }%
%<debug>      \MT@info{-- #2: \csname MT@#1list@#2@\MT@tmp@setname\endcsname\@gobble}%
   }%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@get@highlevel}
% Saying, for instance, |family={rm*}| or |shape={bf*}| will lead to
% \cs{rmdefault} resp.\ \cs{bfdefault} being expanded/protruded.
%    \begin{macrocode}
\def\MT@get@highlevel#1{%
   \MT@getlast{\MT@val}%
   \if*\@tempb
%    \end{macrocode}
% And |family = *| will become \cs{familydefault}.
%    \begin{macrocode}
      \MT@ifempty{\@tempa}%
         {\def\@tempa{#1}}{}%
%    \end{macrocode}
% Beware that |\rmdefault| etc.\ might change after this package has been
% loaded!
%    \begin{macrocode}
      \def\MT@val{\csname \@tempa default\endcsname}%
   \fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@getlast}
%\begin{macro}{\MT@getlast@}
%    \begin{macrocode}
\def\MT@getlast#1{\def\@tempa{}\def\@tempb{}%
   \expandafter\MT@getlast@#1\@nil}
\def\MT@getlast@#1{\ifx#1\@nil \let\next=\relax
   \else \edef\@tempa{\@tempa\@tempb}\def\@tempb{#1}%
      \let\next=\MT@getlast@\fi \next}
%    \end{macrocode}
%\end{macro}\end{macro}
%\begin{macro}{\MT@escapechar}
% Make sure that the escape char is set to -1, and catcodes are the same as in
% the original font name, so that the comparison doesn't fail.
%    \begin{macrocode}
\def\MT@escapechar#1{%
   \begingroup
   \escapechar\m@ne
   \xdef\MT@val{\expandafter\string\csname #1\endcsname}%
   \endgroup
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@define@set@key@size}
% |size| requires special treatment.
%    \begin{macrocode}
\def\MT@define@set@key@size#1{%
   \define@key{MT#1@set}{size}[]{%
      \@for\MT@val:=##1\do{%
         \expandafter\KV@@sp@def\expandafter\MT@val\expandafter{\MT@val}%
         \MT@get@size
%    \end{macrocode}
% Strip `pt' if necessary.
%    \begin{macrocode}
         \@defaultunits\@tempdima\MT@val pt\relax\@nnil
         \edef\MT@val{\strip@pt\@tempdima}%
%         \MT@escapechar{\MT@val}%
         \MT@addto@list{#1}{size}{\MT@val}%
      }%
%<debug>      \MT@info{-- size: \csname MT@#1list@size@\MT@tmp@setname\endcsname\@gobble}%
   }%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@get@size}
% If it's not specified as a dimension, we tackle the size selection command
% here.
%    \begin{macrocode}
\def\MT@get@size{%
%    \end{macrocode}
% A single star means \cs{sizedefault}, which doesn't exist, so we define it to
% be \cs{normalsize}.
%    \begin{macrocode}
   \if*\MT@val
      \def\@tempa{\normalsize}%
   \else
      \expandafter\let\expandafter\@tempa\csname\MT@val\endcsname
   \fi
   \ifx\@tempa\relax\else
      \begingroup
         \def\@setfontsize##1##2##3##4\@nil{\gdef\MT@val{##2}}%
         \@tempa\@nil
      \endgroup
   \fi
}
%\def\MT@get@size{%
%   \expandafter\let\expandafter\@tempa\csname\MT@val\endcsname
%   \ifx\@tempa\relax\else
%    \end{macrocode}
% % This does not work with the AMS classes.
% %    \begin{macrocode}
% %      \expandafter\MT@get@size@\@tempa\MT@size@delim{\@tempa}%
% %    \end{macrocode}
% % I hope it is safe to use this instead.
%    \begin{macrocode}
%      \begingroup
%         \def\@setfontsize##1##2##3##4\@nil{\gdef\MT@val{##2}}%
%         \csname#1\endcsname\@nil
%      \endgroup
%   \fi
%}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@get@size@}
% To get the actual size, we parse the command, looking for \cs{@setfontsize},
% and get its second argument (stolen from |relsize|).
%    \begin{macrocode}
%\def\MT@get@size@#1#2#3#4\MT@size@delim#5{%
%   \def\@tempa{}%
%   \ifx\@setfontsize#1\relax\ifx#5#2\@firstofone\relax
%      \def\@tempa{#3}%
%   \fi\fi
%   \MT@ifempty{\@tempa}%
%      {\MT@warning{Could not parse size `\MT@val'\MessageBreak
%            for font set `\MT@tmp@setname'}}%
%      {\def\MT@val{\@tempa}}%
%}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@addto@list}
% Append the value \meta{\#3} to the expansion or protrusion (= \meta{\#1}) list
% for font axis \meta{\#2}.
%    \begin{macrocode}
\def\MT@addto@list#1#2#3{%
   \expandafter\MT@xadd\csname MT@#1list@#2@\MT@tmp@setname\endcsname
      {\noexpand\MT@lt{#3}}%
}
%    \end{macrocode}
%\end{macro}
%    \begin{macrocode}
\def\MT@tmp@setname{}
\MT@define@set@keys{expansion}
\MT@define@set@keys{protrusion}
%    \end{macrocode}
%\begin{macro}{\UseMicroTypeSet}
% \changes{v1.1}{2004/09/20}{remove spaces around first argument}
% To use a particular set we simply redefine
% |\MT@|\meta{|expansion|\textbar|protrusion|}|@setname|. If the optional
% argument is empty, both \cs{MT@expansion@setname} and
% \cs{MT@protrusion@setname} will be redefined.
%    \begin{macrocode}
\renewcommand{\UseMicroTypeSet}[2][]{%
   \KV@@sp@def{\@tempa}{#1}
   \MT@ifempty{#1}%
     {\MT@use@sets{expansion}{#2}%
      \MT@use@sets{protrusion}{#2}}%
     {\expandafter\MT@use@sets\expandafter{\@tempa}{#2}}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@use@sets}
% \changes{v1.1}{2004/09/20}{remove spaces around set name}
% The set might be defined later on.
%    \begin{macrocode}
\def\MT@use@sets#1#2{%
   \KV@@sp@def{\@tempa}{#2}%
   \expandafter\edef\csname MT@#1@setname\endcsname{\@tempa}%
   \expandafter\ifx\csname MT@#1list@@\@tempa\endcsname\relax
      \MT@warning{#1 set `\@tempa' currently not defined.\MessageBreak Using it anyway}%
      \else\MT@info{Using #1 set `\@tempa'}\fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\DeclareMicroTypeAlias}
% This can be used to set an alias name for a font, so that the file (and the
% settings) for the aliased font will be loaded.
%    \begin{macrocode}
\renewcommand{\DeclareMicroTypeAlias}[2]{%
   \expandafter\def\csname MT@#1@alias\endcsname{#2}%
}
%</package>
%    \end{macrocode}
%\end{macro}
%
% \subsubsection{Declarations}
% We now set up some default sets (in the configuration file).
%    \begin{macrocode}
%<*config&m-t>

\DeclareMicroTypeSet{all}{}

\DeclareMicroTypeSet{alltext}
   { encoding = {T1,OT1,LY1,TS1} }

\DeclareMicroTypeSet{basictext}
   { encoding = {T1,OT1,LY1},
     family   = {rm*,sf*},
     series   = {m},
     shape    = {},
     size     = {normalsize,footnotesize,small,large}
   }

\DeclareMicroTypeSet{normalfont}
   { encoding = *,
     family   = *,
     series   = *,
     shape    = *,
     size     = *
   }

%    \end{macrocode}
% The Latin Modern Fonts inherit the settings from Computer Modern.
%    \begin{macrocode}
\DeclareMicroTypeAlias{lmr}{cmr}
%</config&m-t>
%    \end{macrocode}
% Make sure that font sets are defined at the end of the package. If the user
% hasn't activated any, we use the `|alltext|' sets. They can be overridden
% later on, of course.
%    \begin{macrocode}
%<*package>
\AtEndOfPackage{%
   \@ifundefined{MT@expansion@setname}%
      {\UseMicroTypeSet[expansion]{basictext}}{}%
   \@ifundefined{MT@protrusion@setname}%
      {\UseMicroTypeSet[protrusion]{alltext}}{}%
}
%    \end{macrocode}
%
% \subsubsection{Fine Tuning}
% The macros \cs{SetExpansion} and \cs{SetProtrusion} provide a similar
% interface for setting the character protrusion resp. expansion factors for a
% set of fonts.
%
%\begin{macro}{\SetExpansion}
% This macro accepts three arguments: [options,] set of font characteristics and
% list of character protrusion factors.
%
% A new macro called |\MT@expcodes@|\meta{name} will be defined to be \meta{\#3}
% (i.e. the list of characters).
%    \begin{macrocode}
\renewcommand{\SetExpansion}[3][]{%
   \let\MT@expcodes@name\relax
%    \end{macrocode}
% Parse the first argument:
%    \begin{macrocode}
   \setkeys{MT@expcodes}{#1}%
%    \end{macrocode}
% If the user hasn't specified a name we will create one.
%    \begin{macrocode}
   \MT@get@codes@name{exp}%
%<debug>   \MT@info{creating expansion list `\MT@expcodes@name'}%
%    \end{macrocode}
% Now we can define the macro to be \meta{\#3}. Here, as elsewhere, we have to
% make the definitions global, since they may occur inside a group.
%    \begin{macrocode}
   \expandafter\gdef\csname MT@expcodes@\MT@expcodes@name\endcsname{#3}%
%    \end{macrocode}
% The second argument:
% We define macros for all permutations of the font characteristics to point to
% this macro.
%    \begin{macrocode}
   \setkeys{MT@expcodes}{#2}%
   \def\MT@permutelist{expcodes}%
   \MT@permute
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\SetProtrusion}
% |\SetProtrusion| is just the same.
%    \begin{macrocode}
\renewcommand{\SetProtrusion}[3][]{%
   \let\MT@protcodes@name\relax
   \setkeys{MT@protcodes}{#1}%
   \MT@get@codes@name{prot}%
%<debug>   \MT@info{creating protrusion list `\MT@protcodes@name'}%
   \expandafter\gdef\csname MT@protcodes@\MT@protcodes@name\endcsname{#3}%
   \setkeys{MT@protcodes}{#2}%
   \def\MT@permutelist{protcodes}%
   \MT@permute
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@get@codes@name}
% Simply use a roman number as the list name.
%    \begin{macrocode}
\def\MT@get@codes@name#1{%
   \@ifundefined{MT@#1codes@name}%
      {\@tempcnta=\@ne
       \loop
         \@ifundefined{MT@#1codes@#1-\romannumeral\@tempcnta}%
            {\expandafter\edef\csname MT@#1codes@name\endcsname
                  {#1-\romannumeral\@tempcnta}%
             \@tempcnta=\z@ }%
            {\advance \@tempcnta \@ne}%
          \ifnum\@tempcnta > \z@ \repeat}%
      {\@ifundefined{MT@#1codes@\csname MT@#1codes@name\endcsname}{}{%
         \MT@warning{Redefining list `\csname MT@#1codes@name\endcsname'}}}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@declare@codes}
% Define the keys for expansion and protrusion character code lists.
%    \begin{macrocode}
\def\MT@declare@codes#1{%
   \define@key{MT@#1codes}{name}[]{%
      \MT@ifempty{##1}{}{%
         \expandafter\gdef\csname MT@#1codes@name\endcsname{##1}%
      }%
   }%
   \define@key{MT@#1codes}{load}[]{%
      \MT@ifempty{##1}{}{%
         \expandafter\let\expandafter\@tempa\csname MT@#1codes@name\endcsname
         \expandafter\gdef\csname MT@#1codes@\@tempa load\endcsname{##1}%
      }%
   }%
   \MT@define@code@key{#1codes}{encoding}%
   \MT@define@code@key{#1codes}{family}%
   \MT@define@code@key{#1codes}{series}%
   \MT@define@code@key{#1codes}{shape}%
   \MT@define@code@key@size{#1codes}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@define@code@key}
%    \begin{macrocode}
\def\MT@define@code@key#1#2{%
   \define@key{MT@#1}{#2}[]{%
      \@tempcnta=\@ne
      \@for\MT@val:=##1\do{%
         \expandafter\KV@@sp@def\expandafter\MT@val\expandafter{\MT@val}%
%    \end{macrocode}
% Here, too, we allow for something like |bf*|. It will expanded immediately.
%    \begin{macrocode}
         \MT@get@highlevel{#2}%
         \expandafter\edef\csname MT@temp#2\romannumeral\@tempcnta\endcsname{\MT@val}%
         \advance\@tempcnta \@ne
      }%
   }%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@define@code@key@size}
%    \begin{macrocode}
\def\MT@define@code@key@size#1{%
   \define@key{MT@#1}{size}[]{%
      \@tempcnta=\@ne
      \@for\MT@val:=##1\do{%
         \expandafter\KV@@sp@def\expandafter\MT@val\expandafter{\MT@val}%
         \MT@get@size
         \expandafter\edef\csname MT@tempsize\romannumeral\@tempcnta\endcsname{\MT@val}%
         \advance\@tempcnta \@ne
      }%
   }%
}
%    \end{macrocode}
%\end{macro}
%    \begin{macrocode}
\MT@declare@codes{prot}
\MT@declare@codes{exp}
%    \end{macrocode}
%\begin{macro}{\MT@define@expcodes@key}
% Some more options for the first argument to \cs{SetExpansion}.
%    \begin{macrocode}
\def\MT@define@expcodes@key#1{%
   \define@key{MT@expcodes}{#1}[]{%
      \MT@ifempty{##1}{}{%
         \expandafter\let\expandafter\@tempa\csname MT@expcodes@name\endcsname
%    \end{macrocode}
% A space terminates the number.
%    \begin{macrocode}
         \expandafter\gdef\csname MT@expcodes@\@tempa #1\endcsname{##1 }%
      }%
   }
}
%    \end{macrocode}
%\end{macro}
%    \begin{macrocode}
\MT@define@expcodes@key{stretch}
\MT@define@expcodes@key{shrink}
\MT@define@expcodes@key{step}
\define@key{MT@expcodes}{auto}[]{%
   \MT@ifempty{#1}{\def\@tempb{true}}{\def\@tempb{#1}}%
   \csname if\@tempb\endcsname
      \def\@tempb{autoexpand }%
   \else
      \let\@tempb\relax
   \fi
   \expandafter\let\expandafter\@tempa\csname MT@expcodes@name\endcsname
   \expandafter\xdef\csname MT@expcodes@\@tempa auto\endcsname{\@tempb}%
}
%    \end{macrocode}
%\begin{macro}{\DeclareCharacterInheritance}
% \changes{v1.1}{2004/09/15}{new macro: possibility to specify character inheritance}
% This macro may be used in the configuration files to declare characters
% that should inherit protrusion resp.\ expansion values from other characters.
% Thus, there is no need to define all accented characters
% (e.\,g.\ |\`a|, |\'a|, |\^a|, |\~a|, |\"a|, |\r{a}|, |\k{a}|, |\u{a}|).
%    \begin{macrocode}
\renewcommand{\DeclareCharacterInheritance}[3][]{%
   \KV@@sp@def\@tempa{#1}%
   \MT@ifempty{\@tempa}%
      {\MT@declare@char@inh{protrusion}{#2}{#3}%
       \MT@declare@char@inh{expansion}{#2}{#3}}%
      {\expandafter\MT@declare@char@inh\expandafter{\@tempa}{#2}{#3}}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@declare@char@inh}
%    \begin{macrocode}
\def\MT@declare@char@inh#1#2#3{%
   \expandafter\let\csname MT@#1inh@name\endcsname\relax
   \MT@get@inh@name{#1}%
%<debug>   \MT@info{creating inheritance list `\csname MT@#1inh@name\endcsname'}%
   \setkeys{MT@#1inh}{#2}%
   \def\MT@inh@name{\csname MT@#1inh@name\endcsname}%
   \expandafter\gdef\csname MT@#1inh@\MT@inh@name\endcsname{#3}%
   \def\MT@permutelist{#1inh}%
   \MT@permute
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@define@inh@key@encoding}
% \cs{DeclareCharacterInheritance} may also be set up for various combinations
% (although this doesn't really seem necessary). But we only allow one encoding.
%    \begin{macrocode}
\def\MT@define@inh@key@encoding#1{%
   \define@key{MT@#1}{encoding}[]{%
      \expandafter\KV@@sp@def\expandafter\MT@val\expandafter{##1}%
      \MT@get@highlevel{encoding}%
      \expandafter\edef\csname MT@tempencoding\romannumeral1\endcsname{\MT@val}%
   }%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@define@inh@keys}
%    \begin{macrocode}
\def\MT@define@inh@keys#1{%
   \MT@define@inh@key@encoding{#1inh}%
   \MT@define@code@key{#1inh}{family}%
   \MT@define@code@key{#1inh}{series}%
   \MT@define@code@key{#1inh}{shape}%
   \MT@define@code@key@size{#1inh}%
}
\MT@define@inh@keys{expansion}
\MT@define@inh@keys{protrusion}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@get@inh@name}
% The inheritance lists cannot be named by the user.
%    \begin{macrocode}
\def\MT@get@inh@name#1{%
   \@tempcnta=\@ne
   \loop
   \@ifundefined{MT@#1inh@#1-inh-\romannumeral\@tempcnta}%
      {\expandafter\edef\csname MT@#1inh@name\endcsname
            {#1-inh-\romannumeral\@tempcnta}%
         \@tempcnta=\z@ }%
      {\advance \@tempcnta \@ne}%
      \ifnum\@tempcnta > \z@ \repeat
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@inhdo}
% Parse the inheritance lists. We define the commands |\MT@inh@|\meta{name}|@|\meta{slot}|@|,
% containing the inheriting characters. They will also be translated to slot
% numbers here, to save some time.
%    \begin{macrocode}
\def\MT@inhdo#1,{%
   \ifx\relax#1\empty\else
      \MT@inhsplit #1==\relax
      \expandafter\MT@inhdo\fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@inhsplit}
%    \begin{macrocode}
\def\MT@inhsplit#1=#2=#3\relax{%
   \KV@@sp@def\@tempa{#1}%
   \ifx\@tempa\@empty\else
      \MT@get@slot
      \let\MT@val\@tempc
      \KV@@sp@def\@tempb{#2}%
      \ifnum\@tempc < \@cclvi \ifnum\@tempc > \m@ne
         \let\MT@lt\relax
         \@for\@tempa:=\@tempb\do{%
            \expandafter\KV@@sp@def\expandafter\@tempa\expandafter{\@tempa}%
            \ifx\@tempa\@empty\else
               \MT@get@slot
               \expandafter\MT@xadd\csname MT@inh@\MT@inh@name @\MT@val @\endcsname
                  {\noexpand\MT@lt{\@tempc}}%
            \fi
         }%
%<debug>      \def\MT@lt{}%
%<debug>      \MT@info{children of #1:
%<debug>          \csname MT@inh@\MT@inh@name @\MT@val @\endcsname\@gobble}%
      \fi\fi
   \fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@permute}
% \changes{v1.1}{2004/09/15}{don't use sets for empty encoding}
%\begin{macro}{\MT@permute@}
%\begin{macro}{\MT@permute@@}
%\begin{macro}{\MT@permute@@@}
%\begin{macro}{\MT@permute@@@@}
%\begin{macro}{\MT@permute@@@@@}
% This permutation can surely be done in a more elegant way.
%    \begin{macrocode}
\newcount\MT@cnta
\newcount\MT@cntb
\newcount\MT@cntc
\newcount\MT@cntd
\newcount\MT@cnte
\def\MT@permute{%
   \MT@cnta=\@ne
   \MT@permute@
%    \end{macrocode}
% Set commands back to \cs{relax} for the next round.
%    \begin{macrocode}
   \MT@permute@reset
}
\def\MT@permute@{%
   \MT@cntb=\@ne
   \MT@permute@@
   \advance\MT@cnta\@ne
   \@ifundefined{MT@tempencoding\romannumeral\MT@cnta}{}%
      {\MT@permute@}%
}
\def\MT@permute@@{%
   \MT@cntc=\@ne
   \MT@permute@@@
   \advance\MT@cntb\@ne
   \@ifundefined{MT@tempfamily\romannumeral\MT@cntb}{}%
      {\MT@permute@@}%
}
\def\MT@permute@@@{%
   \MT@cntd=\@ne
   \MT@permute@@@@
   \advance\MT@cntc\@ne
   \@ifundefined{MT@tempseries\romannumeral\MT@cntc}{}%
      {\MT@permute@@@}%
}
\def\MT@permute@@@@{%
   \MT@cnte=\@ne
   \MT@permute@@@@@
   \advance\MT@cntd\@ne
   \@ifundefined{MT@tempshape\romannumeral\MT@cntd}{}%
      {\MT@permute@@@@}%
}
\def\MT@permute@@@@@{%
   \MT@permute@define{a}{encoding}%
   \MT@permute@define{b}{family}%
   \MT@permute@define{c}{series}%
   \MT@permute@define{d}{shape}%
   \MT@permute@define{e}{size}%
   \def\@tempa{\MT@tempencoding/\MT@tempfamily/\MT@tempseries/\MT@tempshape/\MT@tempsize}%
   \ifx\MT@tempencoding\empty\else
      \@ifundefined{MT@\MT@permutelist @\@tempa}{}%
         {\MT@warning{\MT@permutelist. list
            `\csname MT@\MT@permutelist @name\endcsname' will override list\MessageBreak
            `\csname MT@\MT@permutelist @\@tempa\endcsname' for font `\@tempa'}}%
      \expandafter\xdef\csname MT@\MT@permutelist @\@tempa\endcsname
         {\csname MT@\MT@permutelist @name\endcsname}%
%<debug>      \MT@info{initializing: use list for font \@tempa\@gobble}%
   \fi
   \advance\MT@cnte\@ne
   \@ifundefined{MT@tempsize\romannumeral\MT@cnte}{}%
      {\MT@permute@@@@@}%
}
%    \end{macrocode}
%\end{macro}\end{macro}\end{macro}\end{macro}\end{macro}\end{macro}
%\begin{macro}{\MT@permute@define}
% Defining and resetting the commands.
%    \begin{macrocode}
\def\MT@permute@define#1#2{%
   \expandafter\@tempcnta\csname MT@cnt#1\endcsname
   \@ifundefined{MT@temp#2\romannumeral\@tempcnta}%
      {\expandafter\def\csname MT@temp#2\endcsname{}}%
      {\expandafter\edef\csname MT@temp#2\endcsname
         {\csname MT@temp#2\romannumeral\@tempcnta\endcsname}}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@permute@reset}
%    \begin{macrocode}
\def\MT@permute@reset{%
   \MT@permute@reset@{encoding}%
   \MT@permute@reset@{family}%
   \MT@permute@reset@{series}%
   \MT@permute@reset@{shape}%
   \MT@permute@reset@{size}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@permute@reset@}
%    \begin{macrocode}
\def\MT@permute@reset@#1{%
   \@tempcnta\@ne
   \loop
      \expandafter\let\csname MT@temp#1\romannumeral\@tempcnta\endcsname\relax
      \advance\@tempcnta\@ne
      \expandafter\ifx\csname MT@temp#1\romannumeral\@tempcnta\endcsname\relax\else\repeat
}
%</package>
%    \end{macrocode}
%\end{macro}
%
% \subsubsection{Settings}
% Let's now use the commands we have just defined.
%    \begin{macrocode}
%<*config>

%<*m-t>
%    \end{macrocode}
% These are the inheriting characters. We only declare those characters that
% are the same on \emph{both} sides, i.\,e.\ not \AE\ for A.
%    \begin{macrocode}
%% CHARACTER INHERITANCE

%    \end{macrocode}
% Other interesting characters, which should inherit settings on one side only:
% |012|~(`fi' ligature), |013|~(`fl'), |014|~(`ffi'), |015|~(`ffl'), \AE, \ae,
% \OE, \oe.
%    \begin{macrocode}
\DeclareCharacterInheritance
   { encoding = OT1 }
   { f = {011}, % ff
     i = {\i},
     j = {\j},
     O = {\O},
     o = {\o},
  }

%    \end{macrocode}
% Candidates here: |028|~(`fi'), |029|~(`fl'), |030|~(`ffi'), |031|~(`ffl'),
% |156| (`IJ'~ligature), |188|~(`ij'), \AE, \ae, \OE, \oe.
%    \begin{macrocode}
\DeclareCharacterInheritance
   { encoding = T1 }
   { A = {\`A,\'A,\^A,\~A,\"A,\r{A},\k{A},\u{A}},
     a = {\`a,\'a,\^a,\~a,\"a,\r{a},\k{a},\u{a}},
     C = {\'C,\c{C},\v{C}},
     c = {\'c,\c{c},\v{c}},
     D = {\v{D},\DH},
     d = {\v{d},\dj},
     E = {\`E,\'E,\^E,\"E,\k{E},\v{E}},
     e = {\`e,\'e,\^e,\"e,\k{e},\v{e}},
     f = {027}, % ff
     G = {\u{G}},
     g = {\u{g}},
     I = {\`I,\'I,\^I,\"I,\.I},
     i = {\`i,\'i,\^i,\"i,\i},
     j = {\j},
     L = {\'L,\v{L},\L},
     l = {\'l,\v{l},\l},
     N = {\'N,\~N,\v{N}},
     n = {\'n,\~n,\v{n}},
     O = {\`O,\'O,\^O,\~O,\"O,\H{O},\O},
     o = {\`o,\'o,\^o,\~o,\"o,\H{o},\o},
     R = {\'R,\v{R}},
     r = {\'r,\v{r}},
     S = {\'S,\c{S},\v{S},\SS},
     s = {\'s,\c{s},\v{s},\ss},
     T = {\c{T},\v{T}},
     t = {\c{t},\v{t}},
     U = {\`U,\'U,\^U,\"U,\H{U},\r{U}},
     u = {\`u,\'u,\^u,\"u,\H{u},\r{u}},
     Y = {\'Y,\"Y},
     y = {\'y,\"y},
     Z = {\'Z,\.Z,\v{Z}},
     z = {\'z,\.z,\v{z}},
     - = {127},
  }

%    \end{macrocode}
% More characters: |008|~(`fl'), |012|~(`fi'), |014|~(`ffi'), |015|~(`ffl'), \AE, \ae, \OE, \oe.
%    \begin{macrocode}
\DeclareCharacterInheritance
   { encoding = LY1 }
   { A = {\`A,\'A,\^A,\~A,\"A,\r{A}},
     a = {\`a,\'a,\^a,\~a,\"a,\r{a}},
     C = {\c{C}},
     c = {\c{c}},
     D = {\DH},
     E = {\`E,\'E,\^E,\"E},
     e = {\`e,\'e,\^e,\"e},
     f = {011}, % ff
     I = {\`I,\'I,\^I,\"I},
     i = {\`i,\'i,\^i,\"i,\i},
     L = {\L},
     l = {\l},
     N = {\~N},
     n = {\~n},
     O = {\`O,\'O,\^O,\~O,\"O,\O},
     o = {\`o,\'o,\^o,\~o,\"o,\o},
     S = {\v{S}},
     s = {\v{s}},
     U = {\`U,\'U,\^U,\"U},
     u = {\`u,\'u,\^u,\"u},
     Y = {\'Y,\"Y},
     y = {\'y,\"y},
     Z = {\v{Z}},
     z = {\v{z}},
  }

%% EXPANSION SETTINGS
% TO DO for the other fonts...

%    \end{macrocode}
% These are the original expansion settings from \thanh. They are used for all
% fonts (until somebody shows mercy and creates font-specific settings).
%    \begin{macrocode}
\SetExpansion
%<m-t>   [ name     = default ]
%<cmr>   [ name     = cmr-default ]
%<pad>   [ name     = pad-default ]
%<ppl>   [ name     = ppl-default ]
%<ptm>   [ name     = ptm-default ]
%<cmr>   { family   = cmr,
%<pad>   { family   = {pad,padx,padj},
%<ppl>   { family   = {ppl,pplx,pplj},
%<ptm>   { family   = {ptm,ptmx,ptmj},
%<m-t>   { encoding = {OT1,T1,LY1}     }
%<!m-t>     encoding = {OT1,T1,LY1}    }
   {
     A = 500,     a = 700,
   \AE = 500,   \ae = 700,
     B = 700,     b = 700,
     C = 700,     c = 700,
     D = 500,     d = 700,
     E = 700,     e = 700,
     F = 700,
     G = 500,     g = 700,
     H = 700,     h = 700,
     K = 700,     k = 700,
     M = 700,     m = 700,
     N = 700,     n = 700,
     O = 500,     o = 700,
   \OE = 500,   \oe = 700,
     P = 700,     p = 700,
     Q = 500,     q = 700,
     R = 700,
     S = 700,     s = 700,
     U = 700,     u = 700,
     W = 700,     w = 700,
     Z = 700,     z = 700,
     2 = 700,
     3 = 700,
     6 = 700,
     8 = 700,
     9 = 700,
   }

%</m-t>
%% PROTRUSION SETTINGS

%    \end{macrocode}
% These were be the original settings from \thanh.
%    \begin{macrocode}
%\SetProtrusion
%   [ name     = thanh ]
%   { }
%   {
%     A = {50,50},
%     F = { 0,50},
%     J = {50, 0},
%     K = { 0,50},
%     L = { 0,50},
%     T = {50,50},
%     V = {50,50},
%     W = {50,50},
%     X = {50,50},
%     Y = {50,50},
%     k = { 0,50},
%     r = { 0,50},
%     t = { 0,50},
%     v = {50,50},
%     w = {50,50},
%     x = {50,50},
%     y = {50,50},
%     . = {0,700},    {,}= {0,700},
%     : = {0,500},     ; = {0,500},
%     ! = {0,200},     ? = {0,200},
%     ( = {50, 0},     ) = { 0,50},
%     - = {0,700},
%     \textendash        = {0,300},     \textemdash        = {0,200},
%     \textquoteleft     = {700,0},     \textquoteright    = {0,700},
%     \textquotedblleft  = {500,0},     \textquotedblright = {0,500},
%   }
%
%    \end{macrocode}
% \changes{v1.1}{2004/09/14}{added protrusion factors for some more characters}
% \changes{v1.1}{2004/09/14}{removed 8-bit characters from the configuration files
%                            (suggested by Harald Harders)}
% \changes{v1.1}{2004/09/14}{added protrusion settings for Adobe Minion
%                            (contributed by Harald Harders)}
% We also create configuration files for the fonts Computer Modern Roman (\nfss\
% code |cmr|), Palatino (|ppl|, |pplx|, |pplj|), Times (|ptm|, |ptmx|, |ptmj|),
% Adobe Garamond (|pad|, |padx|, |padj|) and Minion\footnote{ Contributed by
% Harald Harders (\mailto{h.harders@tu-bs.de})} (|pmnx|, |pmnj|).
%
% The default settings always use the most moderate value.
%    \begin{macrocode}
\SetProtrusion
%<m-t>   [ name     = default ]
%<cmr>   [ name     = cmr-default ]
%<pad>   [ name     = pad-default ]
%<ppl>   [ name     = ppl-default ]
%<ptm>   [ name     = ptm-default ]
%<pmn>   [ name     = pmnj-default ]
%<m-t>   { encoding = {OT1}   }
%<cmr>   { family   = cmr,
%<pad>   { family   = {pad,padx,padj},
%<ppl>   { family   = {ppl,pplx,pplj},
%<ptm>   { family   = {ptm,ptmx,ptmj},
%<pmn>   { family   = pmnj,
%<!m-t>     encoding = {OT1}    }
   {
     A = {50,50},
%<m-t|cmr|pad|ptm>   \AE = {50,  },
%<pad|pmn>     C = {50,  },
%<pad|pmn>     D = {  ,50},
%<m-t|cmr|pad|pmn|ptm>     F = {  ,50},
%<pad|pmn>     G = {50,  },
     J = {50,  },
     K = {  ,50},
%<m-t|cmr|pad|pmn|ppl>     L = {  ,50},
%<ptm>     L = {  ,80},
%<pad|pmn>     O = {50,50},
%<pad|pmn>   \OE = {50,  },
%<pad|pmn>     Q = {50,70},
     T = {50,50},
     V = {50,50},
     W = {50,50},
     X = {50,50},
%<cmr|m-t|pad|pmn|ppl>     Y = {50,50},
%<ptm>     Y = {80,80},
     k = {  ,50},
%<pmn>     l = {  ,-50},
%<pad|ppl>     p = {50,50},
%<pad|ppl>     q = {50,  },
     r = {  ,50},
%<cmr|pad|pmn>     t = {  ,70},
     v = {50,50},
     w = {50,50},
     x = {50,50},
%<m-t|pad|pmn>     y = {  ,50},
%<cmr|ppl|ptm>     y = {50,70},
%<pmn>     1 = {  ,50},
%<ptm>     1 = {100,100},
%<pad|pmn>     3 = {50,  },
%<pad|pmn|ptm>     4 = {50,  },
%<cmr|ppl|ptm>     7 = { ,100},
%<pad|pmn>     7 = {50,80},
     . = { ,700},
%<m-t|pad|pmn>    {,}= { ,500},
%<cmr|ppl|ptm>    {,}= { ,700},
     : = { ,500},
%<m-t|pad|pmn|ptm>     ; = { ,300},
%<cmr|ppl>     ; = { ,500},
     ! = { ,100},
%<m-t|pad|pmn|ptm>     ? = { ,100},
%<cmr|ppl>     ? = { ,200},
     " = {300,300},
%<m-t|cmr|pad|pmn|ppl>     @ = {50,50},
%<ptm>     @ = {100,100},
     ~ = {200,250},
%<m-t|pad|pmn|ppl|ptm>     _ = {100,100},
%<cmr>     _ = {200,200},
%<pad|ppl|ptm>     & = {50,100},
%<m-t|cmr|pad|pmn>   037 = {50,50},  % \%
%<ppl|ptm>   037 = {100,100},  % \%
%<m-t|ppl|ptm>     * = {200,200},
%<pad|cmr>     * = {300,300},
%<pmn>     * = {200,300},
%<cmr|ppl|ptm>     + = {250,250},
%<pad>     + = {300,300},
%<pmn>     + = {150,200},
%<cmr|ppl>     ( = {100,   },    ) = {   ,300},
%<m-t|pad|pmn|ptm>     ( = {100,   },    ) = {   ,200},
%<pmn>     [ = {100,   },    ] = {   ,100},
%<cmr|ppl>     \ = {200,300},    / = {200,300},
%<m-t|pad|pmn|ptm>     \ = {100,200},    / = {100,200},
%<m-t|cmr|pad|ppl|ptm>     - = {500,500},
%<pmn>     - = {200,400},
%<m-t|cmr|pad|ppl|ptm>     \textendash       = {300,300},   \textemdash        = {200,200},
%<pmn>     \textendash       = {200,200},   \textemdash       = {150,150},
%    \end{macrocode}
% Why settings for left \emph{and} right quotes? Because in some languages they
% might be used like that (see the \pkg{csquotes} package for example).
%    \begin{macrocode}
%<m-t|ptm>     \textquoteleft    = {500,500},   \textquoteright    = {300,500},
%<cmr|pad|ppl>     \textquoteleft    = {500,700},   \textquoteright    = {500,700},
%<pmn>     \textquoteleft    = {300,400},   \textquoteright    = {300,400},
%<pmn>     \textquotedblleft = {300,300},   \textquotedblright = {300,300},
%<m-t|ptm>     \textquotedblleft = {300,400},   \textquotedblright = {300,400},
%<cmr|ppl>     \textquotedblleft = {300,500},   \textquotedblright = {300,500},
%<pad>     \textquotedblleft = {400,500},   \textquotedblright = {400,500},
   }

%    \end{macrocode}
% \tOne\ and \lyOne\ encodings contain some more characters. The default list
% will be loaded first.
%
% We won't bother about the extra characters of \lyOne. Whoever uses that
% encoding, should complain to me.
%    \begin{macrocode}
\SetProtrusion
%<m-t>   [ name     = T1-default,
%<cmr>   [ name     = cmr-T1,
%<pad>   [ name     = pad-T1,
%<ppl>   [ name     = ppl-T1,
%<ptm>   [ name     = ptm-T1,
%<pmn>   [ name     = pmnj-T1,
%<m-t>     load     = default ]
%<cmr>     load     = cmr-default ]
%<pad>     load     = pad-default ]
%<ppl>     load     = ppl-default ]
%<ptm>     load     = ptm-default ]
%<pmn>     load     = pmnj-default ]
%<m-t>   { encoding = {T1,LY1}   }
%<cmr>   { family   = cmr,
%<pad>   { family   = {pad,padx,padj},
%<ppl>   { family   = {ppl,pplx,pplj},
%<ptm>   { family   = {ptm,ptmx,ptmj},
%<pmn>   { family   = pmnj,
%<!m-t>     encoding = {T1,LY1}    }
   {
%<pmn>     \TH = {  , 50},
%<m-t|cmr|pad|ppl|ptm>     \quotesinglbase   = {400,400},   \quotedblbase      = {400,400},
%<pmn>     \quotesinglbase   = {400,400},   \quotedblbase      = {300,300},
%<m-t|cmr|pad|ppl|ptm>     \guilsinglleft    = {400,400},   \guilsinglright    = {300,500},
%<pmn>     \guilsinglleft    = {400,300},   \guilsinglright    = {300,400},
%<m-t>     \guillemotleft    = {300,300},   \guillemotright    = {300,300},
%<cmr>     \guillemotleft    = {300,200},   \guillemotright    = {100,400},
%<pad>     \guillemotleft    = {300,300},   \guillemotright    = {200,400},
%<pmn>     \guillemotleft    = {200,200},   \guillemotright    = {150,300},
%<ppl|ptm>     \guillemotleft    = {300,300},   \guillemotright    = {200,400},
%<m-t|cmr|pad|pmn|ppl>     \textexclamdown   = {100,   },   \textquestiondown  = {100,   },
%<ptm>     \textexclamdown   = {200,   },   \textquestiondown  = {200,  },
%<m-t|cmr|pad|ppl|ptm>     \textbraceleft    = {400,200},   \textbraceright    = {200,400},
%<pmn>     \textbraceleft    = {200,   },   \textbraceright    = {   ,300},
%<m-t|cmr|pad|ppl|ptm>     \textless         = {200,100},   \textgreater       = {100,200},
%<pmn>     \textless         = {100,   },   \textgreater       = {   ,100},
%<pmn>     \textvisiblespace = {100,100},
   }

%<*pmn>
\SetProtrusion
   [ name     = pmnx-OT1,
     load     = pmnj-default ]
   { family   = pmnx,
     encoding = OT1   }
   {
     1 = {230,180},
   }

\SetProtrusion
   [ name     = pmnx-T1,
     load     = pmnj-T1 ]
   { family   = pmnx,
     encoding = {T1,LY1} }
   {
     1 = {230,180},
   }

%</pmn>
%    \end{macrocode}
% To find default settings for italic is difficult, since the character shapes
% and their behaviour at the beginning or end of line may be wildly different
% for different fonts. Therefore, we leave the letters away, and only set up the
% punctuation characters.
%    \begin{macrocode}
\SetProtrusion
%<m-t>   [ name     = OT1-it    ]
%<cmr>   [ name     = cmr-it   ]
%<pad>   [ name     = pad-it   ]
%<pmn>   [ name     = pmnj-it   ]
%<ppl>   [ name     = ppl-it   ]
%<ptm>   [ name     = ptm-it   ]
   { shape    = it,
%<cmr>     family   = cmr,
%<pad>     family   = {pad,padx,padj},
%<pmn>     family   = pmnj,
%<ppl>     family   = {ppl,pplx,pplj},
%<ptm>     family   = {ptm,ptmx,ptmj},
     encoding = OT1 }
   {
%<cmr|ptm>     A = {100,50},
%<pad|pmn>     A = {50,  },
%<ppl>     A = {50,50},
%<cmr|ptm>   \AE = {100,  },
%<pad|ppl>   \AE = {50,  },
%<pmn>   \AE = {  ,-50},
%<cmr|pad|ppl|ptm>     B = {50,  },
%<pmn>     B = {20,-50},
%<cmr|pad>     C = {100, },
%<ppl|ptm>     C = {50,  },
%<pmn>     C = {50,-50},
%<cmr|pad|ppl|ptm>     D = {50,50},
%<pmn>     D = {20,  },
%<cmr|pad|ppl|ptm>     E = {50,  },
%<pmn>     E = {20,-50},
%<cmr|pad|ptm>     F = {100, },
%<ppl>     F = {50,  },
%<pmn>     F = {10,  },
%<cmr|pad>     G = {100, },
%<ppl|ptm>     G = {50,  },
%<pmn>     G = {50,-50},
%<cmr|pad|ppl|ptm>     H = {50,  },
%<cmr|pad|ptm>     I = {50,  },
%<pmn>     I = {20,-50},
%<cmr|ptm>     J = {100, },
%<pad>     J = {50,  },
%<pmn>     J = {20,  },
%<cmr|pad|ppl|ptm>     K = {50,  },
%<pmn>     K = {20,  },
%<cmr|pad|ppl|ptm>     L = {50,  },
%<pmn>     L = {20,50},
%<cmr|ptm>     M = {50,  },
%<pmn>     M = {  ,-30},
%<cmr|ptm>     N = {50,  },
%<pmn>     N = {  ,-30},
%<cmr|pad>     O = {100, },
%<pmn|ppl|ptm>     O = {50,  },
%<cmr|pad>   \OE = {100, },
%<pmn|ppl|ptm>   \OE = {50,  },
%<cmr|pad|ppl|ptm>     P = {50,  },
%<pmn>     P = {20,-50},
%<cmr|pad>     Q = {100, },
%<pmn|ppl|ptm>     Q = {50,  },
%<cmr|pad|ppl|ptm>     R = {50,  },
%<pmn>     R = {20,  },
%<cmr|pad|ppl|ptm>     S = {50,  },
%<pmn>     S = {20,-30},
%<cmr|pad|ppl|ptm>     $ = {50,  },
%<pmn>     $ = {20,-30},
%<cmr|pad|ppl|ptm>     T = {100, },
%<pmn>     T = {70,  },
%<cmr|pad|ppl|ptm>     U = {50,  },
%<pmn>     U = {50,-50},
%<cmr|pad|pmn>     V = {100, },
%<ppl|ptm>     V = {100,50},
%<cmr|pad|pmn>     W = {100, },
%<ppl>     W = {50,  },
%<ptm>     W = {100,50},
%<cmr|ppl|ptm>     X = {50,  },
%<cmr|ptm>     Y = {100, },
%<pmn>     Y = {50,  },
%<ppl>     Y = {100,50},
%<pmn>     Z = {  ,-50},
%<pmn>     d = {  ,-50},
%<pad|pmn>     f = { ,-100},
%<pmn>     i = {  ,-30},
%<pmn>     j = {  ,-30},
%<pmn>     l = {  ,-100},
%<pmn>     p = {-50,  },
%<pmn>     r = {  ,50},
%<pmn>     v = {50,  },
%<pmn>     w = {50,  },
%<cmr|pad|ppl>     1 = {100, },
%<pmn>     1 = {50, },
%<ptm>     1 = {100,50},
%<cmr|pad|ppl|ptm>     2 = {50,  },
%<pmn>     2 = {-50,  },
%<pmn>     3 = {-100, },
%<ptm>     3 = {50,  },
%<cmr|pad|ppl|ptm>     4 = {50,  },
%<cmr|ptm>     7 = {100, },
%<pad>     7 = {50,  },
%<pmn>     7 = {20,  },
%<ppl>     7 = {50,50},
%<m-t|cmr|pmn|pad|ppl>     . = { ,500},
%<ptm>     . = { ,700},
%<m-t|cmr|pmn|pad|ppl>    {,}= { ,500},
%<ptm>    {,}= { ,700},
%<m-t|cmr|pad|ppl>     : = { ,300},
%<pmn>     : = { ,200},
%<ptm>     : = { ,500},
%<m-t|cmr|pad|ppl>     ; = { ,300},
%<pmn>     ; = { ,200},
%<ptm>     ; = { ,500},
%<ptm>     ! = { ,100},
%<ptm>     ? = { ,100},
%<ppl>     ? = { ,300},
     " = {400,200},
%<m-t|pmn>     _ = {  ,100},
%<cmr>     _ = {100,200},
%<pad|ppl|ptm>     _ = {100,100},
%<m-t|pad|pmn|ppl|ptm>     & = {50,50},
%<cmr>     & = {100,50},
%<m-t|cmr|pad|pmn>   037 = {100, },
%<ppl|ptm>   037 = {100,100},
%<m-t|pmn|ppl|ptm>     * = {200,200},
%<cmr>     * = {400,100},
%<pad>     * = {500,100},
%<ptm>     * = {400,200},
%<m-t|cmr|pmn|ppl>     + = {150,200},
%<pad|ptm>     + = {250,200},
%<m-t|pad|pmn|ppl>     @ = {50,50},
%<cmr>     @ = {200,50},
%<ptm>     @ = {150,150},
     ~ = {200,150},
     ( = {200, },     ) = {   ,200},
%<m-t|cmr|pad|ppl|ptm>     \ = {100,200},   / = {100,200},
%<pmn>     \ = {100,150},   / = {100,150},
%<m-t|pad>     - = {300,300},
%<cmr|ptm>     - = {500,500},
%<pmn>     - = {200,300},
%<ppl>     - = {300,500},
%<m-t|cmr|pad|ppl|ptm>     \textendash       = {300,300},   \textemdash        = {200,200},
%<pmn>     \textendash       = {200,200},   \textemdash        = {150,150},
%<m-t|ppl>     \textquoteleft    = {700,400},   \textquoteright    = {700,400},
%<cmr|pad>     \textquoteleft    = {800,200},   \textquoteright    = {800,200},
%<pmn>     \textquoteleft    = {400,200},   \textquoteright    = {400,200},
%<ptm>     \textquoteleft    = {800,500},   \textquoteright    = {800,500},
%<m-t|ppl>     \textquotedblleft = {500,300},   \textquotedblright = {500,300},
%<cmr|pad>     \textquotedblleft = {700,200},   \textquotedblright = {700,200},
%<pmn>     \textquotedblleft = {400,200},   \textquotedblright = {400,200},
%<ptm>     \textquotedblleft = {700,400},   \textquotedblright = {700,400},
   }

\SetProtrusion
%<m-t>   [ name     = T1-it-default,
%<cmr>   [ name     = cmr-it-T1,
%<pad>   [ name     = pad-it-T1,
%<ppl>   [ name     = ppl-it-T1,
%<ptm>   [ name     = ptm-it-T1,
%<pmn>   [ name     = pmnj-it-T1,
%<m-t>     load     = OT1-it ]
%<cmr>     load     = cmr-it ]
%<pad>     load     = pad-it ]
%<ppl>     load     = ppl-it ]
%<ptm>     load     = ptm-it ]
%<pmn>     load     = pmnj-it ]
   { shape    = it,
%<cmr>     family   = cmr,
%<pad>     family   = {pad,padx,padj},
%<ppl>     family   = {ppl,pplx,pplj},
%<ptm>     family   = {ptm,ptmx,ptmj},
%<pmn>     family   = pmnj,
     encoding = {T1,LY1}    }
   {
%<pmn>     188 = {  ,-30}, % ij
%<pmn>     031 = { ,-100}, % ffl
%<cmr|ptm>     156 = {100, },  % IJ
%<pad>     156 = {50,  },  % IJ
%<pmn>     156 = {20,  },  % IJ
%<pmn>   \v{t} = { ,100},
%<m-t|cmr|ptm>     \quotesinglbase   = {300,700},   \quotedblbase      = {400,500},
%<pad|ppl>     \quotesinglbase   = {500,500},   \quotedblbase      = {400,400},
%<pmn>     \quotesinglbase   = {200,500},   \quotedblbase      = {150,500},
%<m-t|ppl|ptm>     \guilsinglleft    = {400,400},   \guilsinglright    = {300,500},
%<cmr>     \guilsinglleft    = {500,300},   \guilsinglright    = {400,400},
%<pad>     \guilsinglleft    = {500,400},   \guilsinglright    = {300,500},
%<pmn>     \guilsinglleft    = {300,400},   \guilsinglright    = {200,500},
%<m-t|ppl>     \guillemotleft    = {300,300},   \guillemotright    = {300,300},
%<cmr>     \guillemotleft    = {400,100},   \guillemotright    = {200,300},
%<pad>     \guillemotleft    = {300,300},   \guillemotright    = {200,400},
%<pmn>     \guillemotleft    = {200,300},   \guillemotright    = {150,400},
%<ptm>     \guillemotleft    = {300,400},   \guillemotright    = {200,400},
%<m-t|pad|ppl>     \textexclamdown   = {100,   },   \textquestiondown  = {200,   },
%<cmr|ptm>     \textexclamdown   = {200,   },   \textquestiondown  = {200,   },
%<pmn>     \textexclamdown   = {-50,   },   \textquestiondown  = {-50,   },
%<m-t|ppl>     \textbraceleft    = {200,100},   \textbraceright    = {200,200},
%<cmr|pad|ptm>     \textbraceleft    = {400,100},   \textbraceright    = {200,200},
%<pmn>     \textbraceleft    = {200,   },   \textbraceright    = {   ,200},
%<cmr|pad|ppl|ptm>     \textless         = {300,100},   \textgreater       = {200,100},
%<pmn>     \textless         = {100,   },   \textgreater       = {   ,100},
%<pmn>     \textvisiblespace = {100,100},
   }

%<*pmn>
\SetProtrusion
   [ name     = pmnx-it,
     load     = pmnj-it ]
   { shape    = it,
     family   = pmnx,
     encoding = OT1 }
   {
     1 = {100,150},
   }

\SetProtrusion
   [ name     = pmnx-it-T1,
     load     = pmnj-it-T1 ]
   { shape    = it,
     family   = pmnx,
     encoding = {T1,LY1} }
   {
     1 = {100,150},
   }

%</pmn>
%    \end{macrocode}
% Small caps should inherit the values from their big brothers. Since values are
% relative to character width, we don't need to adjust them any further.
%    \begin{macrocode}
\SetProtrusion
%<m-t>   [ name     = OT1-sc,
%<cmr>   [ name     = cmr-sc,
%<pad>   [ name     = pad-sc,
%<pmn>   [ name     = pmnj-sc,
%<ppl>   [ name     = ppl-sc,
%<ptm>   [ name     = ptm-sc,
%<m-t>     load     = default ]
%<cmr>     load     = cmr-default ]
%<pad>     load     = pad-default ]
%<pmn>     load     = pmnj-default ]
%<ppl>     load     = ppl-default ]
%<ptm>     load     = ptm-default ]
   { shape    = sc,
%<cmr>     family   = cmr,
%<pad>     family   = {pad,padx,padj},
%<pmn>     family   = pmnj,
%<ppl>     family   = {ppl,pplx,pplj},
%<ptm>     family   = {ptm,ptmx,ptmj},
     encoding = OT1 }
   {
     a = {50,50},
%<cmr|pad|ppl|ptm>   \ae = {50,  },
%<pmn>     c = {50,  },
%<pad|pmn>     d = {  ,50},
%<m-t|cmr|pad|pmn|ptm>     f = {  ,50},
%<pad|pmn>     g = {50,  },
     j = {50,  },
%<m-t|cmr|pad|pmn|ppl>     l = {  ,50},
%<ptm>     l = {  ,80},
%<m-t|cmr|pad|pmn|ppl>   013 = { 0,50}, % fl
%<ptm>   013 = { 0,80}, % fl
%<pad|pmn>     o = {50,50},
%<pad|pmn>   \oe = {50,  },
%<ppl>     p = { 0, 0},
%<pad|pmn>     q = {50,70},
%<ppl>     q = { 0,  },
     r = {  , 0},
     t = {50,50},
%<m-t|cmr|pad|pmn|ppl>     y = {50,50},
%<ptm>     y = {80,80},
   }

\SetProtrusion
%<m-t>   [ name     = T1-sc,
%<cmr>   [ name     = cmr-sc-T1,
%<pad>   [ name     = pad-sc-T1,
%<pmn>   [ name     = pmnj-sc-T1,
%<ppl>   [ name     = ppl-sc-T1,
%<ptm>   [ name     = ptm-sc-T1,
%<m-t>     load     = T1-default ]
%<cmr>     load     = cmr-T1 ]
%<pad>     load     = pad-T1 ]
%<pmn>     load     = pmnj-T1 ]
%<ppl>     load     = ppl-T1 ]
%<ptm>     load     = ptm-T1 ]
   { shape    = sc,
%<cmr>     family   = cmr,
%<pad>     family   = {pad,padx,padj},
%<pmn>     family   = pmnj,
%<ppl>     family   = {ppl,pplx,pplj},
%<ptm>     family   = {ptm,ptmx,ptmj},
     encoding = {T1,LY1} }
   {
     a = {50,50},
%<cmr|pad|ppl|ptm>   \ae = {50,  },
%<pmn>     c = {50,  },
%<pad|pmn>     d = {  ,50},
%<m-t|cmr|pad|pmn|ptm>     f = {  ,50},
%<pad|pmn>     g = {50,  },
     j = {50,  },
%<m-t|cmr|pad|pmn|ppl>     l = {  ,50},
%<ptm>     l = {  ,80},
%<m-t|cmr|pad|pmn|ppl>   029 = {  ,50}, % fl
%<ptm>   029 = {  ,80}, % fl
%<pad|pmn>     o = {50,50},
%<pad|pmn>   \oe = {50,  },
%<ppl>     p = { 0, 0},
%<pad|pmn>     q = {50,70},
%<ppl>     q = { 0,  },
     r = {  , 0},
     t = {50,50},
%<m-t|cmr|pad|pmn|ppl>     y = {50,50},
%<ptm>     y = {80,80},
   }

%<*pmn>
\SetProtrusion
   [ name     = pmnx-sc,
     load     = pmnj-sc ]
   { shape    = sc,
     family   = pmnx,
     encoding = OT1 }
   {
     1 = {230,180},
   }

\SetProtrusion
   [ name     = pmnx-sc-T1,
     load     = pmnj-sc-T1 ]
   { shape    = sc,
     family   = pmnx,
     encoding = {T1,LY1} }
   {
     1 = {230,180},
   }

%    \end{macrocode}
% Minion provides real small caps in italics.
%    \begin{macrocode}
\SetProtrusion
   [ name     = pmnj-scit,
     load     = pmnj-it ]
   { shape    = {scit,si},
     family   = pmnj,
     encoding = OT1 }
   {
     a = {50,  },
   \ae = {  ,-50},
     b = {20,-50},
     c = {50,-50},
     d = {20, 0},
     e = {20,-50},
     f = {10, 0},
   012 = {10,-50}, % fi
   013 = {10,-50}, % fl
   014 = {10,-50}, % ffi
   015 = {10,-50}, % ffl
     g = {50,-50},
     i = {20,-50},
     j = {20, 0},
     k = {20,  },
     l = {20,50},
     m = {  ,-30},
     n = {  ,-30},
     o = {50,  },
   \oe = {50,-50},
     p = {20,-50},
     q = {50,  },
     r = {20, 0},
     s = {20,-30},
     t = {70,  },
     u = {50,-50},
     v = {100,  },
     w = {100,  },
     y = {50,  },
     z = {  ,-50},
   }

\SetProtrusion
   [ name     = pmnj-scit-T1,
     load     = pmnj-it-T1 ]
   { shape    = {scit,si},
     family   = pmnj,
     encoding = {T1,LY1} }
   {
     a = {50,  },
   \ae = {  ,-50},
     b = {20,-50},
     c = {50,-50},
     d = {20, 0},
     e = {20,-50},
     f = {10, 0},
   028 = {10,-50}, % fi
   029 = {10,-50}, % fl
   030 = {10,-50}, % ffi
   031 = {10,-50}, % ffl
     g = {50,-50},
     i = {20,-50},
   188 = {20, 0},  % ij
     j = {20, 0},
     k = {20,  },
     l = {20,50},
     m = {  ,-30},
     n = {  ,-30},
     o = {50,  },
   \oe = {50,-50},
     p = {20,-50},
     q = {50,  },
     r = {20, 0},
     s = {20,-30},
     t = {70,  },
     u = {50,-50},
     v = {100,  },
     w = {100,  },
     y = {50,  },
     z = {  ,-50},
   }

\SetProtrusion
   [ name     = pmnx-scit,
     load     = pmnj-scit ]
   { shape    = {scit,si},
     family   = pmnx,
     encoding = OT1 }
   {
     1 = {100,150},
   }

\SetProtrusion
   [ name     = pmnx-scit-T1,
     load     = pmnj-scit-T1 ]
   { shape    = {scit,si},
     family   = pmnx,
     encoding = {T1,LY1} }
   {
     1 = {100,150},
   }

%</pmn>
\SetProtrusion
%<m-t>   [ name     = textcomp ]
%<cmr>   [ name     = cmr-textcomp ]
%<pad>   [ name     = pad-textcomp ]
%<pmn>   [ name     = pmn-textcomp ]
%<ppl>   [ name     = ppl-textcomp ]
%<ptm>   [ name     = ptm-textcomp ]
%<m-t>   { encoding = TS1      }
%<cmr>   { family   = cmr,
%<pad>   { family   = {pad,padx,padj},
%<pmn>   { family   = {pmnx,pmnj},
%<ppl>   { family   = {ppl,pplx,pplj},
%<ptm>   { family   = {ptm,ptmx,ptmj},
%<!m-t>     encoding = TS1  }
   {
%<m-t|ptm>     \textminus      = {200,200},
%<cmr|pad|ppl>     \textminus      = {300,300},
%<m-t|pad|ptm>     \textcopyright  = {100,100},
%<cmr|ppl>     \textcopyright  = {200,200},
%<m-t|pad|ptm>     \texttrademark  = {100,100},
%<cmr|ppl>     \texttrademark  = {200,200},
%<m-t|pad|ptm>     \textregistered = {100,100},
%<cmr|ppl>     \textregistered = {200,200},
%<cmr>     \textlangle     = {400,   },
%<cmr>     \textrangle     = {   ,400},
%<m-t|ppl|ptm>     \textdegree     = {300,300},
%<cmr>     \textdegree     = {600,600},
%<pad>     \textdegree     = {500,500},
%<pmn>     \textquotestraightbase = {400,400},
%<pmn>     \textquotestraightdblbase = {300,300},
%<pmn>     \texttwelveudash = {200,200},
%<pmn>     \textthreequartersemdash = {150,150},
%<pmn>     \textquotesingle = {300,400},
%<pmn>     \textasteriskcentered = {200,300},
%<pmn>     \textfractionsolidus = {-200,-200},
%<pmn>     \textoneoldstyle = {  ,50},
%<pmn>     \textthreeoldstyle = {50,  },
%<pmn>     \textfouroldstyle = {50,  },
%<pmn>     \textsevenoldstyle = {50,80},
%<pmn>     \textminus = {200,200},
%<pmn>     \textlbrackdbl = {100,  },
%<pmn>     \textrbrackdbl = {  ,100},
%<pmn>     \textasciigrave = {200,500},
%<pmn>     \texttildelow = {200,250},
%<pmn>     \textasciibreve = {300,400},
%<pmn>     \textasciicaron = {300,400},
%<pmn>     \textacutedbl = {200,300},
%<pmn>     \textgravedbl = {150,300},
%<pmn>     \textdagger = {80,80},
%<pmn>     \textdaggerdbl = {80,80},
%<pmn>     \textbullet = {  ,100},
%<pmn>     \textcelsius = {50,  },
%<pmn>     \textflorin = {50,100},
%<pmn>     \textcolonmonetary = {50,  },
%<pmn>     \textinterrobang = {  ,100},
%<pmn>     \textinterrobangdown = {100,  },
%<pmn>     \texttrademark  = {50,50},
%<pmn>     \textasciidieresis = {300,400},
%<pmn>     \textcopyright  = {100,150},
%<pmn>     \textordfeminine = {200,200},
%<pmn>     \textlnot = {200,  },
%<pmn>     \textregistered = {50,150},
%<pmn>     \textasciimacron = {150,200},
%<pmn>     \textdegree     = {150,400},
%<pmn>     \textpm = {150,200},
%<pmn>     \texttwosuperior = {200,200},
%<pmn>     \textthreesuperior = {200,200},
%<pmn>     \textasciiacute = {300,400},
%<pmn>     \textparagraph = {  ,100},
%<pmn>     \textperiodcentered = {300,400},
%<pmn>     \textonesuperior = {200,200},
%<pmn>     \textordmasculine = {200,200},
%<pmn>     \texteuro = {100,  },
%<pmn>     \texttimes = {70,100},
%<pmn>     \textdiv = {150,200},
   }

%<*pmn>
\SetProtrusion
   [ name     = pmn-textcomp-it   ]
   { shape    = it,
     family   = {pmnx,pmnj},
     encoding = TS1 }
   {
     \textquotestraightbase = {400,400},
     \textquotestraightdblbase = {300,300},
     \texttwelveudash = {200,200},
     \textthreequartersemdash = {150,150},
     \textquotesingle = {300,200},
     \textasteriskcentered = {200,300},
     \textfractionsolidus = {-200,-200},
     \textoneoldstyle = {50,  },
     \texttwooldstyle = {-50,  },
     \textthreeoldstyle = {-100,  },
     \textsevenoldstyle = {20,  },
     \textminus = {200,200},
     \textlbrackdbl = {100,  },
     \textrbrackdbl = {  ,100},
     \textasciigrave = {300,300},
     \texttildelow = {200,250},
     \textasciibreve = {300,300},
     \textasciicaron = {300,300},
     \textacutedbl = {200,300},
     \textgravedbl = {150,300},
     \textdagger = {80,50},
     \textdaggerdbl = {80,50},
     \textbullet = {30,70},
     \textcelsius = {50,-50},
     \textflorin = {50,100},
     \textcolonmonetary = {50,-50},
     \texttrademark  = {50,100},
     \textasciidieresis = {300,200},
     \textcopyright  = {100,150},
     \textordfeminine = {200,200},
     \textlnot = {200,  },
     \textregistered = {50,150},
     \textasciimacron = {150,200},
     \textdegree     = {150,150},
     \textpm = {150,200},
     \texttwosuperior = {200,100},
     \textthreesuperior = {200,100},
     \textasciiacute = {300,200},
     \textparagraph = {  ,100},
     \textperiodcentered = {300,400},
     \textonesuperior = {200,100},
     \textordmasculine = {200,200},
     \texteuro = {100,-50},
     \texttimes = {70,100},
     \textdiv = {150,200},
   }

%</pmn>
%</config>
%    \end{macrocode}
% But we're not finished with the package yet.
%
% \subsection{User Command}
%\begin{macro}{\microtypesetup}
%\begin{macro}{\MT@define@optionX}
% This command may be used anywhere in the document. It accepts the options:
% |protrusion|, |expansion| and |activate|. Specifying font sets is not
% allowed.
%    \begin{macrocode}
%<*package>
\def\microtypesetup{\setkeys{MTX}}
\def\MT@define@optionX#1{%
   \define@key{MTX}{#1}[true]{%
      \@for\MT@val:=##1\do{%
         \expandafter\KV@@sp@def\expandafter\MT@val\expandafter{\MT@val}%
         \MT@ifempty{\MT@val}{}{%
            \@tempcnta\m@ne
            \def\@tempa{true}%
            \ifx\MT@val\@tempa
               \@tempcnta\MT@expansionlevel
               \MT@info{#1 enabled}%
               \let\MT@val\relax
            \fi
            \def\@tempa{false}%
            \ifx\MT@val\@tempa
               \@tempcnta\z@
               \MT@info{#1 disabled}%
               \let\MT@val\relax
            \fi
            \def\@tempa{compatibility}%
            \ifx\MT@val\@tempa
               \@tempcnta\@ne
               \MT@info{#1 set to level 1}%
               \let\MT@val\relax
            \fi
            \def\@tempa{nocompatibility}
            \ifx\MT@val\@tempa
               \@tempcnta\tw@
               \MT@info{#1 set to level 2}%
               \let\MT@val\relax
            \fi
            \ifx\MT@val\relax\else
               \MT@warning{Value `\MT@val' not recognized}%
            \fi
            \ifnum\@tempcnta>\m@ne
               \def\@tempa{expansion}%
               \def\@tempb{#1}%
               \ifx\@tempa\@tempb
                  \pdfadjustspacing\@tempcnta
               \else
                  \pdfprotrudechars\@tempcnta
               \fi
            \fi
         }%
      }%
   }%
}
%    \end{macrocode}
%\end{macro}\end{macro}
%    \begin{macrocode}
\MT@define@optionX{protrusion}
\MT@define@optionX{expansion}
\define@key{MTX}{activate}[]{%
   \setkeys{MTX}{protrusion={#1}}%
   \setkeys{MTX}{expansion={#1}}%
}
%    \end{macrocode}
%
% \subsection{Package Options}
%\begin{macro}{\MT@define@option}
% |expansion| and |protrusion| may be |true|, |false|, |compatibility|,
% |nocompatibility| and/or a \meta{set name}.
%    \begin{macrocode}
\def\MT@define@option#1{%
   \define@key{MT}{#1}[]{%
      \@for\MT@val:=##1\do{%
         \expandafter\KV@@sp@def\expandafter\MT@val\expandafter{\MT@val}%
         \MT@ifempty{\MT@val}{}{%
            \def\@tempa{false}%
            \ifx\MT@val\@tempa
               \csname MT@#1false\endcsname
               \let\MT@val\relax
            \fi
            \def\@tempa{compatibility}%
            \ifx\MT@val\@tempa
               \expandafter\def\csname MT@#1level\endcsname{1}%
               \let\MT@val\relax
            \fi
            \def\@tempa{nocompatibility}
            \ifx\MT@val\@tempa
               \expandafter\def\csname MT@#1level\endcsname{2}%
               \let\MT@val\relax
            \fi
            \ifx\MT@val\relax\else
               \csname MT@#1true\endcsname
               \def\@tempa{true}%
               \ifx\MT@val\@tempa
               \else\MT@use@sets{#1}{\MT@val}\fi
            \fi
         }%
      }%
   }%
}
%    \end{macrocode}
%\end{macro}
%    \begin{macrocode}
\MT@define@option{protrusion}
\MT@define@option{expansion}
%    \end{macrocode}
% |activate| is a shortcut.
%    \begin{macrocode}
\define@key{MT}{activate}[]{%
   \setkeys{MT}{protrusion={#1}}%
   \setkeys{MT}{expansion={#1}}%
}
%    \end{macrocode}
% |stretch|, etc., have to end with a space to terminate the number.
%    \begin{macrocode}
\define@key{MT}{stretch}[20]{\def\MT@stretch{#1 }}
\define@key{MT}{shrink}[20]{\def\MT@shrink{#1 }}
\define@key{MT}{step}[2]{\def\MT@step{#1 }}
\define@key{MT}{auto}[true]{\csname MT@auto#1\endcsname}
\define@key{MT}{DVIoutput}[true]{\csname MT@DVIoutput#1\endcsname}
\define@key{MT}{verbose}[true]{\csname MT@verbose#1\endcsname}
%    \end{macrocode}
% |draft| may be inherited from the class options.
%    \begin{macrocode}
\define@key{MT}{draft}[true]{\csname MT@draft#1\endcsname}
%    \end{macrocode}
% Load the local configuration file before executing the package options.
%    \begin{macrocode}
\MT@info{%
  Trying to load local config file `microtype.cfg' ..\@gobble}
\InputIfFileExists{microtype.cfg}
  {\MT@info{%
    ... local config file loaded successfully\@gobble}}
  {\MT@info{%
    ... local config file not used\@gobble}}
%    \end{macrocode}
%\begin{macro}{\ProcessOptionsWithKV}
% Parse options.
%    \begin{macrocode}
\def\ProcessOptionsWithKV#1{%
  \let\@tempc\relax
  \let\KVo@tempa\@empty
  \@for\CurrentOption:=\@classoptionslist\do{%
    \@ifundefined{KV@#1@\CurrentOption}%
    {}%
    {%
      \edef\KVo@tempa{\KVo@tempa,\CurrentOption,}%
      \@expandtwoargs\@removeelement\CurrentOption
         \@unusedoptionlist\@unusedoptionlist
    }%
  }%
  \edef\KVo@tempa{%
    \noexpand\setkeys{#1}{%
      \KVo@tempa\@ptionlist{\@currname.\@currext}%
    }%
  }%
  \KVo@tempa
  \AtEndOfPackage{\let\@unprocessedoptions\relax}%
  \let\CurrentOption\@empty
}
%    \end{macrocode}
%\end{macro}
%    \begin{macrocode}
\ProcessOptionsWithKV{MT}%
%    \end{macrocode}
% Now we can process the options:
%
% \pdftex\ can create \dvi\ output, too. However, both the \dvi\ viewer and
% dvips need to find actual fonts (in the form of |tfm| files). Therefore, this
% does not make too much sense unless one only wants the protrusion feature, or
% fonts for different degrees of expansion are readily available.
%    \begin{macrocode}
\ifMT@DVIoutput
   \ifMT@pdf
      \pdfoutput\z@
   \fi
\fi
%    \end{macrocode}
% Set up the numbers for font expansion: If |stretch| has not been specified, we
% take the default value of 20. If |shrink| has not been specified, it will get
% the same value as |stretch|.
% If both values have been set to 0, we will switch off expansion.
%
% If |step| has not been specified, we will set it to min(|stretch|,|shrink|)/10,
% rounded off, minimum value 1.
%    \begin{macrocode}
\ifMT@expansion
   \ifnum\MT@stretch=\m@ne
      \def\MT@stretch{20 }%
   \fi
   \ifnum\MT@shrink=\m@ne
      \ifnum\MT@stretch>\z@
         \let\MT@shrink\MT@stretch
      \else
         \def\MT@shrink{20 }%
      \fi
   \fi
   \ifnum\MT@stretch=\z@
      \ifnum\MT@shrink=\z@
         \MT@expansionfalse
      \fi
   \fi
   \ifnum\MT@step=\m@ne
      \ifnum\MT@stretch>\MT@shrink
         \ifnum\MT@shrink=\z@
            \@tempcnta=\MT@stretch
         \else
            \@tempcnta=\MT@shrink
         \fi
      \else
         \ifnum\MT@stretch=\z@
            \@tempcnta=\MT@shrink
         \else
            \@tempcnta=\MT@stretch
         \fi
      \fi
      \divide\@tempcnta by 10
   \else
      \@tempcnta=\MT@step
   \fi
   \ifnum\@tempcnta=\z@ \@tempcnta=\@ne\fi
   \edef\MT@step{\the\@tempcnta\space}%
\fi
%    \end{macrocode}
%\begin{macro}{\MT@auto}
% Automatic expansion of the font? This new feature of \pdftex\ 1.20a makes the
% \textit{hz}-algorithm really usable.
%
% Should we turn it off for |DVIoutput|?
%    \begin{macrocode}
\ifMT@auto
   \def\MT@auto{autoexpand}
\else
   \let\MT@auto\relax
\fi
%    \end{macrocode}
%\end{macro}
% Tell the log file which options the user has chosen (in case it's interested):
%    \begin{macrocode}
\ifMT@draft
   \MT@info{%
      `draft' option active.\MessageBreak
      Disabling all micro-typographic features\@gobble}
   \MT@protrusionfalse
   \MT@expansionfalse
\else
   \MT@info{%
      \ifMT@protrusion Character protrusion enabled (level \MT@protrusionlevel)%
      \else No character protrusion\fi\@gobble}
   \MT@info{%
      \ifMT@expansion\ifMT@auto Automatic f\else F\fi
         ont expansion enabled (level \MT@expansionlevel),\MessageBreak
         stretch: \MT@stretch/ shrink: \MT@shrink/ step: \MT@step
      \else No character expansion\fi\@gobble}
\fi
\MT@info{%
   Generating \ifnum\pdfoutput=\z@ DVI \else PDF \fi output\@gobble}
%    \end{macrocode}
% Finally, we enable the micro-typographic extensions, or we don't.
%    \begin{macrocode}
\ifMT@protrusion
   \pdfprotrudechars\MT@protrusionlevel
\fi
\ifMT@expansion
   \pdfadjustspacing\MT@expansionlevel
\fi
%</package>
%    \end{macrocode}
% That was it.
%
% ^^A From now on, don't bother indexing:
%\makeatletter\let\special@index\@gobble\makeatother
%
% \subsection{Auxiliary file for micro-fine tuning}
% This file can be used to test protrusion and expansion settings.
%    \begin{macrocode}
%<*auxiliary>
\documentclass{article}

%% Here you can set the font you want to test, using
%% the commands \fontfamily, \fontseries, and \fontshape.
%% Make sure to end all lines with a comment character!
\newcommand{\TestFont}{%
   \fontfamily{ppl}%
%%   \fontseries{b}%
%%   \fontshape{it}% sc, sl
}

\usepackage{ifthen}
\usepackage[T1]{fontenc}
%%\usepackage[ansinew]{inputenc}
\usepackage[verbose,expansion=alltext,stretch=50]{microtype}

\pagestyle{empty}
\setlength{\parindent}{0pt}
\newcommand{\crulefill}{\cleaders\hbox{$\mkern-2mu\smash-\mkern-2mu$}\hfill}
\newcommand{\testprotrusion}[2][]{%
  \ifthenelse{\equal{#1}{r}}{}{#2}%
   lorem ipsum dolor sit amet,
     \ifthenelse{\equal{#1}{r}}{\crulefill}{\leftarrowfill} #2
     \ifthenelse{\equal{#1}{l}}{\crulefill}{\rightarrowfill}
   you know the rest%
  \ifthenelse{\equal{#1}{l}}{}{#2}%
   \linebreak
  {\fontencoding{\encodingdefault}%
   \fontseries{\seriesdefault}%
   \fontshape{\shapedefault}%
   \selectfont
   Better not write anything that might \dotfill
      attract too much attention}\linebreak
}
\newcommand{\showTestFont}{\expandafter\stripprefix\meaning\TestFont}
\def\stripprefix#1>{}
\newcount\charcount
\begin{document}
\microtypesetup{expansion=false}

{\centering The font in this document is called by:\\
 \texttt{\showTestFont}\par}\bigskip

\TestFont\selectfont
 This line intentionally left empty\linebreak
%% A -- Z
\charcount=65
\loop
   \testprotrusion{\char\charcount}
   \advance\charcount 1
   \ifnum\charcount < 91 \repeat
%% a -- z
\charcount=97
\loop
   \testprotrusion{\char\charcount}
   \advance\charcount 1
   \ifnum\charcount < 123 \repeat
%% 0 -- 9
\charcount=48
\loop
   \testprotrusion{\char\charcount}
   \advance\charcount 1
   \ifnum\charcount < 58 \repeat
%%
 \testprotrusion[r]{,}
 \testprotrusion[r]{.}
 \testprotrusion[r]{;}
 \testprotrusion[r]{:}
 \testprotrusion[r]{?}
 \testprotrusion[r]{!}
 \testprotrusion[l]{\textexclamdown}
 \testprotrusion[l]{\textquestiondown}
 \testprotrusion[r]{)}
 \testprotrusion[l]{(}
 \testprotrusion{/}
 \testprotrusion{\textbackslash}
 \testprotrusion{-}
 \testprotrusion{\textendash}
 \testprotrusion{\textemdash}
 \testprotrusion{\textquoteleft}
 \testprotrusion{\textquoteright}
 \testprotrusion{\textquotedblleft}
 \testprotrusion{\textquotedblright}
 \testprotrusion{\quotesinglbase}
 \testprotrusion{\quotedblbase}
 \testprotrusion{\guilsinglleft}
 \testprotrusion{\guilsinglright}
 \testprotrusion{\guillemotleft}
 \testprotrusion{\guillemotright}

\bigskip

The following displays the current font stretched by 5\%,
normal, and shrunk by 5\%:

\bigskip

\newlength{\MTln}
\newcommand{\teststring}
   {ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789}
\settowidth{\MTln}{\teststring}

\microtypesetup{expansion=true}

\parbox{1.05\MTln}{\teststring\linebreak\\
                   \teststring}\par\bigskip
\parbox{0.95\MTln}{\teststring}
\end{document}
%</auxiliary>
%    \end{macrocode}
% Needless to say that things may always be improved. For suggestions, mail to
% \mailtoRS.
%
% ^^A -------------------------------------------------------------------------
%
% \CharacterTable
%  {Upper-case    \A\B\C\D\E\F\G\H\I\J\K\L\M\N\O\P\Q\R\S\T\U\V\W\X\Y\Z
%   Lower-case    \a\b\c\d\e\f\g\h\i\j\k\l\m\n\o\p\q\r\s\t\u\v\w\x\y\z
%   Digits        \0\1\2\3\4\5\6\7\8\9
%   Exclamation   \!     Double quote  \"     Hash (number) \#
%   Dollar        \$     Percent       \%     Ampersand     \&
%   Acute accent  \'     Left paren    \(     Right paren   \)
%   Asterisk      \*     Plus          \+     Comma         \,
%   Minus         \-     Point         \.     Solidus       \/
%   Colon         \:     Semicolon     \;     Less than     \<
%   Equals        \=     Greater than  \>     Question mark \?
%   Commercial at \@     Left bracket  \[     Backslash     \\
%   Right bracket \]     Circumflex    \^     Underscore    \_
%   Grave accent  \`     Left brace    \{     Vertical bar  \|
%   Right brace   \}     Tilde         \~}
%
% \CheckSum{2984}
%
% \Finale
%
\endinput
%
