% \iffalse meta-comment
% -*- TeX:DTX -*-
% $Id: microtype.dtx,v 1.0 2004-09-11 15:09:09+02 schlicht Exp schlicht $
% ----------------------------------------------------------------------------
%                      The `microtype' package
%       An interface to the micro-typographic extensions of pdfTeX
%            Copyright (c) 2004 R Schlicht <w.m.l@gmx.net>
%
% This work  may be  distributed and/or modified  under the conditions of
% the LaTeX Project Public License, either version 1.3 of this license or
% (at your option) any later version.  The latest version of this license
% is in
%    http://www.latex-project.org/lppl.txt
% and version 1.3 or later  is part of all distributions of LaTeX version
% 2003/12/01 or later.
%
% This work has the LPPL maintenance status "author-maintained".
%
% This work consists of the files microtype.dtx and microtype.ins and the
% derived file microtype.sty.
%
% ----------------------------------------------------------------------------
%
%<*driver>
\ProvidesFile{microtype.dtx}%
%</driver>
%<package>\ProvidesPackage{microtype}%
%<*package|driver>
      [2004/09/11 v1.0 Micro-typography with pdfTeX (RS)]
%</package|driver>
%<config>\ProvidesFile{microtype.cfg}
%<config>         [2004/09/11 v1.0 microtype configuration file (RS)]
%<cmr-config>\ProvidesFile{MT-cmr.cfg}
%<cmr-config>         [2004/09/11 v1.0 microtype config. file: Computer Modern (RS)]
%<pad-config>\ProvidesFile{MT-pad.cfg}
%<pad-config>         [2004/09/11 v1.0 microtype config. file: Adobe Garamond (RS)]
%<ppl-config>\ProvidesFile{MT-ppl.cfg}
%<ppl-config>         [2004/09/11 v1.0 microtype config. file: Palatino (RS)]
%<ptm-config>\ProvidesFile{MT-ptm.cfg}
%<ptm-config>         [2004/09/11 v1.0 microtype config. file: Times New Roman (RS)]
%
%<*driver>
\documentclass[11pt,a4paper]{ltxdoc}
\usepackage[ansinew]{inputenc}
\usepackage{textcomp}
\usepackage{array}
\IfFileExists{booktabs.sty}{\usepackage{booktabs}}{}
\IfFileExists{url.sty}{\usepackage{url}}{\def\url##1{\texttt{##1}}}
% Let's abolish CM! We use Charter and Letter Gothic
% (for the pre-built documentation on CTAN):
%\def\rmdefault{bch}
%\def\ttdefault{blg}
%\usepackage[T1]{fontenc}
\makeatletter
\def\Describe#1#2#3{%
   \noindent\csname Describe#1\endcsname{#2}{\ttfamily#3\\*[.25\baselineskip]}}
\def\DescribeOption{\leavevmode\@bsphack
   \begingroup\MakePrivateLetters\Describe@Option}
\def\Describe@Option#1{\endgroup
   \marginpar{\raggedleft\PrintDescribeOption{#1}}%
   \SpecialOptionIndex{#1}\@esphack\ignorespaces}
\def\SpecialOptionIndex#1{\@bsphack
   \index{#1\actualchar{\protect\ttfamily#1} (option)\encapchar usage}%
   \index{\quotechar!User Options\actualchar{\protect\bfseries User Options:}\levelchar
      {\protect\ttfamily#1}\encapchar usage}%
   \@esphack}
\def\SpecialUsageIndex#1{\@bsphack % index macro descriptions separately, too
   {\index{\quotechar!User Commands\actualchar{\protect\bfseries User Commands:}\levelchar
      \expandafter\@gobble\string#1\actualchar
      \string\verb\quotechar*\verbatimchar\string#1\verbatimchar\encapchar usage}%
    \let\special@index\index\SpecialIndex@{#1}{\encapchar usage}}%
    \@esphack}
\def\PrintDescribeOption#1{\strut \MacroFont\color{theblue}\string #1}
\def\PrintDescribeMacro#1{\strut \MacroFont\color{thegreen}\string #1}
\def\MacroFont{\ttfamily\small}% will be set to \footnotesize before `Implementation'
\def\AltMacroFont{\ttfamily\itshape\footnotesize}
\def\Option#1{{\color{thered}\ttfamily\itshape\small#1}}
\def\OptionV#1{{\color{thered}\rmfamily\itshape\normalsize$\langle$#1$\rangle$}}
\def\Default#1{\underline{#1}}
\def\theCodelineNo{\reset@font\color{thegrey}\scriptsize\arabic{CodelineNo}}
\def\@tempa{bch}
\ifx\rmdefault\@tempa
   \def\pkg#1{\texttt{#1}}
   \def\bfdefault{b}
   \def\Module#1{{\rmfamily\itshape\color{theblue}$\langle$#1$\rangle$}}
\else
   \def\pkg#1{\textsf{#1}}
\fi
\def\@biblabel#1{}
\renewcommand{\descriptionlabel}[1]{\hspace\labelsep\normalfont#1}
\long\def\@makecaption#1#2{%
  \vskip\abovecaptionskip
  \sbox\@tempboxa{\small\itshape #1: #2}%
  \hb@xt@\hsize{\hfil\box\@tempboxa\hfil}%
  \vskip\belowcaptionskip}
\makeatother
\frenchspacing
\setlength\hfuzz{25pt}
\settowidth\MacroIndent{\scriptsize 000\ }
\def\MacroTopsep{0pt}
\def\MacrocodeTopsep{3pt}
% fancy PDF document
\let\pdftrue\empty % \newif doesn't work here
\ifx\pdfoutput\undefined\else\ifx\pdfoutput\relax\else
   \ifcase\pdfoutput\else\let\pdftrue\relax\fi\fi\fi
\ifx\pdftrue\relax
   \usepackage{color}
   \usepackage[
      bookmarks=true,
      colorlinks=true,
      linkcolor=linkcolor,
      urlcolor=linkcolor,
      citecolor=linkcolor,
      hyperindex=false,
      pdfauthor={R Schlicht <w.m.l@gmx.net>},
      pdftitle={The microtype package},
      pdfsubject={An interface to the micro-typographic extension of pdfTeX},
      pdfkeywords={TeX, LaTeX, pdftex, typography, micro-typography,
                   font expansion, character protrusion, margin kerning}
     ]{hyperref}
   \def\usage#1{\textbf{\textit{\hyperpage{#1}}}}% for indexing of \DescribeMacro
   \def\ctanurl#1{\href{http://www.tex.ac.uk/tex-archive#1}{\texttt{#1}}}
   \def\mailtoRS{\href{mailto:<w.m.l@gmx.net> R Schlicht?subject=microtype \fileversion}{\texttt{w.m.l@gmx.net}}}
   \definecolor{thegrey}{gray}{0.45}
   \definecolor{thered}{rgb}{0.75,0.00,0.00}
   \definecolor{theblue}{rgb}{0.16,0.24,0.64}
   \definecolor{thegreen}{rgb}{0.18,0.58,0.08}
   \definecolor{linkcolor}{rgb}{0,0,0.42}
\else
   \def\color#1{}
   \def\ctanurl#1{\url{#1}}
   \def\mailtoRS{\texttt{w.m.l@gmx.net}}
   \def\texorpdfstring#1#2{#1}
\fi
% some abbreviations
\def\pdftex{pdf\kern.05em\TeX}
\def\thanh{H\`an Th\^e\llap{\raise 0.5ex\hbox{\'{}}} Th\`anh} % the `official' notation
\def\pdf{{\small PDF}}
\def\dvi{{\small DVI}}
\def\nfss{{\small NFSS}}
\def\ctan{{\small CTAN}}
\def\tOne{{\small T1}}
\def\otOne{{\small OT1}}
\def\lyOne{{\small LY1}}
\def\tsOne{{\small TS1}}
\CodelineIndex
%\RecordChanges
\begin{document}
   \DocInput{microtype.dtx}
\end{document}
%</driver>
% \fi
%
%\DoNotIndex{\@cclvi,\@classoptionslist,\@currext,\@currname,\@defaultunits}
%\DoNotIndex{\@empty,\@expandtwoargs,\@firstofone,\@firstoftwo,\@for,\@gobble}
%\DoNotIndex{\@ifnextchar,\@ifstar,\@ifundefined,\@m,\@ne,\@nil,\@nnil}
%\DoNotIndex{\@onlypreamble,\@ptionlist,\@removeelement,\@secondoftwo}
%\DoNotIndex{\@tempa,\@tempb,\@tempc,\@tempcnta,\@tempcntb,\@tempdima}
%\DoNotIndex{\@unprocessedoptions,\@unusedoptionlist}
%\DoNotIndex{\advance,\begingroup,\catcode,\char,\csname,\def,\divide,\do}
%\DoNotIndex{\edef,\else,\empty,\endcsname,\endgroup,\endinput,\escapechar}
%\DoNotIndex{\expandafter,\fi,\g@addto@macro,\gdef,\global,\hbox,\if,\ifcase}
%\DoNotIndex{\ifcat,\ifnum,\ifx,\let,\loop,\m@ne,\multiply,\newcommand,\newcount}
%\DoNotIndex{\newif,\next,\noexpand,\number,\relax,\renewcommand,\repeat,\romannumeral}
%\DoNotIndex{\setbox,\space,\string,\the,\toks@,\tw@,\undefined,\wd,\x,\xdef,\z@}
%\DoNotIndex{\fontdimen} ^^A \f@encoding,\font@name,\normalfont,\normalsize
%\DoNotIndex{\AtBeginDocument,\AtEndOfPackage,\CurrentOption,\DeclareOption}
%\DoNotIndex{\InputIfFileExists,\MessageBreak,\NeedsTeXFormat,\PackageInfo}
%\DoNotIndex{\PackageWarning,\ProcessOptions,\RequirePackage}
%\DoNotIndex{\/,\\,\guillemotleft,\guillemotright,\guilsinglleft,\guilsinglright}
%\DoNotIndex{\quotedblbase,\quotesinglbase,\textcopyright,\textdegree,\textemdash}
%\DoNotIndex{\textendash,\textlangle,\textminus,\textquotedblleft,\textquotedblright}
%\DoNotIndex{\textquoteleft,\textquoteright,\textrangle,\textregistered,\texttrademark}
%\DoNotIndex{\%,\&,\ } ^^A these cannot be suppressed
%\DoNotIndex{\define@key,\KV@@sp@def,\KVo@tempa,\setkeys} ^^A keyval
%
% ^^A -------------------------------------------------------------------------
% \changes{v1.0}{2004/09/11}{Initial version.}
% ^^A -------------------------------------------------------------------------
%
%\newif\ifnobooktabs
%\IfFileExists{booktabs.sty}{}{\nobooktabstrue}
%\newcolumntype{L}[1]{p{#1}<{\raggedright}}
%
% \GetFileInfo{microtype.dtx}
% \title{The \pkg{microtype} package\\[.25\baselineskip]\large
%        An interface to the micro-typographic extensions of \pdftex}
% \author{R Schlicht\\\mailtoRS}
% \date{\fileversion{} -- \filedate}
%
% \maketitle
%
%\begin{abstract}
% \noindent The \pkg{microtype} package provides a \LaTeX{} interface to the
% micro-typographic extensions of \pdftex: character protrusion and font
% expansion. It allows to restrict font expansion and/or character protrusion to
% a certain set of fonts, and to configure micro-typographic aspects of the
% fonts in a straight-forward and flexible way. Settings for various fonts are
% provided.\footnote{
% Currently, this package includes settings for: Computer Modern Roman, Adobe
% Garamond, Palatino and Times New Roman, as well as some generic settings for
% unknown fonts.}
%
% Note that font expansion and character protrusion does only work with \pdftex,
% at least version 0.14f, resp.\ version 1.20a (release candidate~7), for
% automatic font expansion.
%\end{abstract}
%
% \tableofcontents
% \listoftables
%
% \newpage
% \section{Micro-Typography with \texorpdfstring{\pdftex}{pdfTeX}}\label{sec:Micro-Type}
% \pdftex{}, the \TeX{} extension written by \thanh, introduces two features
% that make it the tool of choice not only for the creation of electronic
% documents but also of works of outstanding time-honoured typography:
% \textit{character protrusion} (also known as margin kerning) and
% \textit{font expansion}. Quoting \thanh's thesis:
%
%\begin{quote}\small
%   \hspace{-.25ex}`Margin kerning is the adjustments of the characters at the
%   margins of a typeset text. A simplified employment of margin kerning is
%   hanging punctuation. Margin kerning is needed for optical alignment of the
%   margins of a typeset text, because mechanical justification of the margins
%   makes them look rather ragged. Some characters can make a line appear
%   shorter to the human eye than others. Shifting such characters by an
%   appropriate amount into the margins would greatly improve the appearance of
%   a typeset text.
%
%   Composing with font expansion is the method to use a wider or narrower
%   variant of a font to make interword spacing more even. A font in a loose
%   line can be substituted by a wider variant so the interword spaces are
%   stretched by a smaller amount. Similarly, a font in a tight line can be
%   replaced by a narrower variant to reduce the amount that the interword
%   spaces are shrunk by. There is certainly a potential danger of font
%   distortion when using such manipulations, thus they must be used with
%   extreme care. The potentiality to adjust a line width by font expansion
%   can be taken into consideration while a paragraph is being broken into
%   lines, in order to choose better breakpoints.' \cite[323]{ThanhThesis}
%\end{quote}
%
% Both these features have been lacking a simple \LaTeX{} user interface for
% quite some time. Then, the \pkg{pdfcprot} package was published
% \cite{pdfcprot}, which allowed \LaTeX{} users to employ character protrusion
% without having to mess much with the internals.
%
% Font expansion, however, was still most difficult to utilize, since it
% required that the font metrics be available in all levels of expansion.
% Therefore, anybody who wanted to use this feature had to create multiple
% instances of the fonts in advance. Shell scripts to somewhat relieve the user
% from this burden were available~-- however, it remained a cumbersome task.
% Furthermore, all fonts were still being physically created, thus wasting
% compilation time and disk space.
%
% In the summer of 2004, \thanh{} implemented a feature that can be expected to
% prove as a major facilitation for \TeX{} and \LaTeX{} users: Font expansion
% can now take place automatically. That is, \pdftex{} no longer needs the
% expanded font metrics but will calculate them at compile-time, and completely
% in memory.
%
% This package provides a simple interface to both font expansion and character
% protrusion.\footnote{ Thus, it is an alternative, not a supplement, to the
% \pkg{pdfcprot} package. I have decided to include an interface to character
% protrusion in this package, too, because both features are closely related,
% and should not be split over two packages; also, the \pkg{pdfcprot} is no
% longer maintained by its author.} It should be straightforward to customize
% all relevant micro-typographic aspects to your taste and needs. The next
% chapters will present a survey of all options and customization possibilities.
%
%
% \section{Invoking the Package}
% There is nothing surprising in loading this package:
%\begin{verbatim}
%\usepackage{microtype}
%\end{verbatim}
%
% Another commonality with many other \LaTeX{} packages is that you can pass
% options to the package in the optional argument to \cs{usepackage}, using the
% well known |key=value| syntax. Multiple values, where allowed, must be
% enclosed in braces.
%
% In the following, I will describe all {\color{theblue}|keys|} and their
% possible \Option{values} (the \Option{\Default{underlined}} value may be
% omitted in the options list). Some values are \mbox{\OptionV{placeholders}}.
%^^A Table~\ref{tab:options} presents all options.
%
%^^A\begin{table}\small
%^^A\begin{tabular*}{\textwidth}{@{}L{6em}L{12em}*2{L{6.6em}}}
%^^A\ifnobooktabs\hline\else\addlinespace\toprule\addlinespace\fi
%^^A   Option      &  Admissible values & \multicolumn{2}{l}{Default value when option~\dots} \\
%^^A\ifnobooktabs\else\cmidrule(l){3-4}\fi                 &&specified & not specified \\
%^^A\ifnobooktabs\hline\else
%^^A     \cmidrule(r){1-1}\cmidrule(lr){2-2}\cmidrule(lr){3-3}\cmidrule(l){4-4}\fi
%^^A |protrusion| & |true|, |false|, |compatibility|, \meta{set name} & |true|            & |alltext|   \\
%^^A |expansion|  & |true|, |false|, |compatibility|, \meta{set name} & |true|            & |basictext| \\
%^^A |activate|   & |true|, |false|, |compatibility|, \meta{set name} & |true|            & --          \\
%^^A |DVIoutput|  & |true|, |false|                  & |true|            & |false|     \\
%^^A |verbose|    & |true|, |false|                  & |true|            & |false|     \\
%^^A |draft|      & |true|, |false|                  & |true|            & |false|     \\
%^^A |auto|       & |true|, |false|                  & |true|            & |true|      \\
%^^A |stretch|    & \meta{number}                    & |20|              & |20|        \\
%^^A |shrink|     & \meta{number}                    & \meta{= stretch}  & |20|        \\
%^^A |step|       & \meta{number}                    & \meta{stretch/10} & |2|         \\
%^^A\ifnobooktabs\hline\else\bottomrule\fi
%^^A\end{tabular*}\caption{User options}\label{tab:options}
%^^A\end{table}
%
% \subsection{Global Options}
%\Describe{Option}{protrusion}
%   {\Default{\Option{true}}, \Option{false}, \Option{compatibility},
%    \Default{\Option{nocompatibility}}, \OptionV{font set name}}
%\DescribeOption{expansion}
% Both character protrusion and font expansion are \emph{enabled} by default.
% They may be disabled separately from each other by setting the respective key
% to |false|.
%\DescribeOption{activate}
% The |activate| option is a shortcut for setting both |expansion| and
% |protrusion| at the same time. Therefore, the following lines all have
% the same effect:
%\begin{verbatim}
%\usepackage[protrusion=true,expansion=true]{microtype}
%\end{verbatim}
%\begin{verbatim}
%\usepackage[protrusion,expansion]{microtype}
%\end{verbatim}
%\begin{verbatim}
%\usepackage[activate={nocompatibility,true}]{microtype}
%\end{verbatim}
%\begin{verbatim}
%\usepackage{microtype}
%\end{verbatim}
%
% When \pdftex{} employs font expansion and character protrusion, line breaks
% may turn out differently. If that is not desired, you may pass the value
% |compatibility| to the protrusion and/or expansion options.
%
% Finally, you may also specify the name of a font set to which character
% protrusion and/or font expansion should be restricted. See
% chapter~\ref{sec:Sets-Fonts} for a detailed discussion.
%
%\newpage
%\Describe{Option}{DVIoutput}{\Default{\Option{true}}, \Option{false}}
% \pdftex{} is not only able to generate \pdf{} output but can also spit out
% \dvi{} files. The latter behaviour can be ordered by the option |DVIoutput|.
% If you've previously set \cs{pdfoutput} to zero, |DVIoutput| will also be set
% to true.
%
% When producing \dvi{} files, automatic font expansion will not work because
% dvips (resp.\ the \dvi{} viewer) is not able to generate the expanded fonts on
% the fly.
%
%\bigskip
%\Describe{Option}{verbose}{\Default{\Option{true}}, \Option{false}}
% You can get information in the log file on each font being set up, if you
% enable the |verbose| option, which is disabled by default.
%
%\bigskip
%\noindent\Describe{Option}{draft}{\Default{\Option{true}}, \Option{false}}
% If the |draft| option is passed to the package~-- which may also originate
% from the class options~--, font expansion and character protrusion will be
% turned off.
%
% \subsection{Options for Font Expansion}
%\Describe{Option}{auto}{\Default{\Option{true}}, \Option{false}}
% As noted in chapter~\ref{sec:Micro-Type}, font expansion may take place
% automatically. This option is true by default, if \pdftex's version is found
% to be 1.20a or higher. If |auto| is set to false, the fonts for all steps of
% expansion must exist in your \TeX{} installation.
%
%\iffalse ^^A is this true? Buggy!
% Note that if |auto| is true, but expanded fonts do actually exist (with files
% called \meta{font~name}|[+-]|\meta{expansion factor}, e.\,g. |cmr12+10.tfm|
% etc., as described by Thành \cite{ThanhThesis,ThanhTUG}), these fonts
% \emph{will} be used -- only any missing ones will be calculated on the fly.
%\fi
%
%\bigskip
%\Describe{Option}{stretch}{\OptionV{number} (\Default{20})}
%\DescribeOption{shrink}
% You may specify the stretchability and shrinkability of a font, i.\,e.\ the
% maximum amount that a font may stretch or shrink. The \OptionV{number}s will
% be divided by 1000, so that a stretch factor of 10 means that the font may
% expand by up to 1\%.
%
% The default stretch factor is 20. The shrink factor will by default be the
% same as the stretch factor. Therefore, the following lines are equivalent:
%\begin{verbatim}
%\usepackage[stretch=20,shrink=20]{microtype}
%\end{verbatim}
%\begin{verbatim}
%\usepackage[stretch=20]{microtype}
%\end{verbatim}
%\begin{verbatim}
%\usepackage{microtype}
%\end{verbatim}
%
%\medskip
%\Describe{Option}{step}
%   {\OptionV{number} \textrm{(\Default{min(|stretch|,|shrink|)/10})}}
% Font expansion will be applied in discrete steps. For example, if |step| is
% set to~2 (which it is by default), \pdftex{} will try up to ten different
% expansion levels of a font. If you set |stretch| or |shrink| to something
% other than their default value but don't specify |step|, it will be set to
% 1/10th of the smaller value of the two.
%
% \section{User Command}
%\Describe{Macro}{\microtypesetup}{\{\OptionV{key = value list}\}}
% This command may be used anywhere in the document to change the general
% settings of the micro-typographic extensions. It accepts the keys:
% |expansion|, |protrusion| and |activate|, which in turn may receive the
% values |true|, |false|, |compatibility| or |nocompatibility| (but not the
% name of a font set). Thus, you could temporarily disable font expansion by
% saying:
%\begin{verbatim}
%\microtypesetup{expansion=false}
%\end{verbatim}
%
%
% \section{Configuration}
% \subsection{Declaring Font Sets}\label{sec:Sets-Fonts}
% By default, all text fonts that are being used in the document will be subject
% to protrusion and a basic set of fonts to expansion. You may want to
% customize the set of fonts which should get the benefit of micro-typographic
% treatment. This can be achieved by specifying attributes of the font that
% have to be matched for them to be taken into account.
%
%\bigskip
%\Describe{Macro}{\DeclareMicroTypeSet}
%   {[\Option{protrusion}\textbar\Option{expansion}]
%    \{\OptionV{set name}\} \{\OptionV{set of fonts}\}}
%\DescribeMacro{\DeclareMicroTypeSet*}
% This macro declares a new set of fonts to which font expansion or character
% protrusion (or, if no optional argument is given, both) should be applied.
% This set can then be activated by calling:
%\begin{tabbing}\MacroFont
%|\UseMicroTypeSet[|\Option{protrusion}\textbar\Option{expansion}|]{|\OptionV{set name}|}|
%\end{tabbing}
% or by passing the name to the |expansion| resp.\ |protrusion| option when
% loading the package; e.\,g.:
%
%\begin{verbatim}
%\usepackage[protrusion=alltext,expansion=basictext]{microtype}
%\end{verbatim}
%
% The starred version of the command declares \emph{and} activates the font
% set at the same time.
%
% \paragraph{The set of fonts} is specified by assigning values to the \nfss{}
% font attributes: encoding, family, series, shape, and size (cf.~\cite{fntguide}).
% Let's start with an example. This package predefines a font set called
% `|basictext|' in the configuration file as follows:
%\begin{verbatim}
%\DeclareMicroTypeSet{basictext}
%   { encoding = {T1,OT1,LY1},
%     family   = {rm*,sf*},
%     series   = {m},
%     shape    = {},
%     size     = {normalsize,footnotesize,small,large}
%   }
%\end{verbatim}
% If you now call
%\begin{verbatim}
%\UseMicroTypeSet[expansion]{basictext}
%\end{verbatim}
% in your document's preamble, only fonts in the text encodings \tOne, \otOne{}
% or \lyOne, roman or sans serif families, in the normal (or `medium') series,
% and in font sizes called by \cs{normalsize}, \cs{footnotesize}, \cs{small} or
% \cs{large}, will be expanded. Math fonts, on the other hand, will not, since
% they are in a different encoding. Neither will fonts in bold face, or huge
% fonts. Etc. (This font set will be activated for font expansion, if you don't
% activate a different one.)
%
% If an attribute list is left empty -- be it by saying something like
% `|shape={}|', as in the above example, or by not specifying it at all --, it
% does not constitute a restriction. I.\,e., this is equivalent to specifying
% \emph{all} possible values for that attribute.
%
% Therefore, the predefined set `|alltext|', declared like this:
%\begin{verbatim}
%\DeclareMicroTypeSet{alltext}
%   { encoding = {T1,OT1,LY1,TS1} }
%\end{verbatim}
% is far less restrictive. Here, the only condition is the encoding. (This is
% the default font set for character protrusion.)
%
% If a value is followed by an asterisk (like `|rm*|' and `|sf*|' in the example
% above), it does not designate a \nfss{} code, but will expand to the current
% |\|\meta{value}|default|, e.\,g. |\rmdefault|.\footnote{ Note that this
% expansion will take place immediately, so you should make all relevant
% changes \emph{before} loading this package.} For example, if you want to
% include the bold font, too, you should say `|bf*|' instead of `|b|'
% (|\bfdefault| for Computer Modern is `|bx|', while for other fonts, it might
% be `|sb|'). A single asterisk means |\|\meta{characteristic}|default|,
% e.\,g.\ \cs{encodingdefault}, respectively \cs{normalsize} for the size axis.
% Sizes may be either specified as a dimension (|10| or |10pt|), or as a size
% selection command \emph{without} the backslash.
%
% Table~\ref{tab:predefined-font-sets} shows an overview of all predefined
% font sets.
%
%\begin{table}\small
%\begin{tabular*}{\textwidth}{@{}L{5em}L{3em}L{5em}L{7.5em}L{9.5em}}
%\ifnobooktabs\hline\else\addlinespace\toprule\addlinespace\fi
%         &|all|& |alltext|      & |basictext|                     & |normalfont|\\
%\ifnobooktabs\hline\else
%     \cmidrule(lr){2-2}\cmidrule(lr){3-3}\cmidrule(lr){4-4}\cmidrule(l){5-5}\fi
% encoding & -- &\tOne, \otOne, \lyOne, \tsOne&\tOne, \otOne, \lyOne&\cs{encodingdefault} \\
% family   & -- & --             & \cs{rmdefault}, \cs{sfdefault}  & \cs{familydefault}   \\
% series   & -- & --             & m                               & \cs{seriesdefault}   \\
% shape    & -- & --             & --                              & \cs{shapedefault}    \\
% size     & -- & --             & \cs{normalsize}, \cs{footnotesize},
%                                  \cs{small}, \cs{large}          & \cs{normalsize}      \\
%\ifnobooktabs\hline\else\bottomrule\fi
%\end{tabular*}
%\caption{Predefined font sets}\label{tab:predefined-font-sets}
%\end{table}
%
%\bigskip
%\Describe{Macro}{\UseMicroTypeSet}
%   {[\Option{protrusion}\textbar\Option{expansion}] \{\OptionV{set name}\}}
% Activates a font set defined by \cs{DeclareMicroTypeSet}. By specifying the
% optional argument, you can limit the application of the set to protrusion or
% expansion only.
%
%\bigskip
% The commands \cs{DeclareMicroTypeSet} and \cs{UseMicroTypeSet} may only be
% used in the preamble or in the main configuration file (cf.\
% chapter~\ref{sub:Config-File}).
%
%\newpage
% \subsection{Micro Fine Tuning}
% For typographic reasons, not all characters should be protruded or expanded by
% the same amount. Therefore, you can specify this amount for each character.
% Furthermore, since every font looks different, you will want to be able to do
% this for each font or set of fonts separately.
%
% \subsubsection{Character Protrusion}
%\Describe{Macro}{\SetProtrusion}
%   {[\OptionV{options}] \{\OptionV{set of fonts}\} \{\OptionV{character list}\}}
% Using this macro, you can set the protrusion factors for each character of a
% font or a set of fonts.
%
% A very simple-minded example would be the following:
%
%\begin{verbatim}
%\SetExpansion
%   { encoding = T1,
%     family   = cmr }
%   {  A             = {50,50},
%     \textquoteleft = {700,0}  }
%\end{verbatim}
% which would result in the character A being protruded by 5\% on both sides,
% and the opening quote character by 70\% into the left margin. This would
% apply to all font shapes, series and sizes of the Computer Modern Roman
% family in encoding~\tOne.
%
% \paragraph{The character list} may contain a number of \meta{character}~=
% \meta{protrusion factors} pairs. Characters can be specified either as a
% single character (`|A|'), as a command that has been defined by
% \cs{DeclareTextSymbol} (`\cs{textquoteleft}'), or as a decimal, three-digit
% number (e.\,g.~`|092|'). \mbox{8-bit} characters may be entered directly or
% in the \LaTeX{} \mbox{7-bit} way of defining them: both |Ä| and |\"A| are
% valid, provided the character is actually included in the encoding. \otOne{}
% encoding, for instance, does not contain the character `Ä', but constructs it
% from the dieresis accent \"{} and an A, whose protrusion resp.\ expansion
% value the character Ä will also inherit. Therefore, defining |Ä| for \otOne{}
% would be wrong.
%
% The numbers designate the amount that a character should be protruded into the
% left margin (first value) respectively into the right margin (second value),
% where 1000 means that the character should be kerned fully into the margin,
% while, for example, a value of 50 means that it should be protruded by 5\% of
% its width.
%
% \paragraph{The set of fonts} should be declared using the same syntax of
% \meta{font axis}~|=| \meta{value list} pairs as in the command
% \cs{DeclareMicroTypeSet}.
%
% To determine whether a given font matches the specified set, all combinations
% of font family, series and shape will be tested. The font size will only be
% taken into account if all other criteria match as well. The encoding has to
% match, unless everything else fails, too. Therefore, you should \emph{always}
% specify it.
%
% Table~\ref{tab:test-order} shows the order in which the combinations of font
% characteristics will be tested.
%
%\begin{table}\small\centering
%\def\match{\large\raisebox{-.1em}{\textbullet}}
%\begin{tabular}{@{}l*{9}l@{}}
%\ifnobooktabs\hline\else\addlinespace\toprule\addlinespace\fi
%                 & 1.  & 2.  & 3.  & 4.  & 5.  & 6.  & 7.  & 8.  & 9. \\
%\ifnobooktabs\hline\else
%   \cmidrule(r){2-2}\cmidrule(r){3-3}\cmidrule(r){4-4}\cmidrule(r){5-5}
%   \cmidrule(r){6-6}\cmidrule(r){7-7}\cmidrule(r){8-8}\cmidrule(r){9-9}
%   \cmidrule{10-10}\fi
% encoding &\match &\match &\match &\match &\match &\match &\match &\match & -- \\
% family   &\match &\match &\match &\match &\match & --    & --    & --    & -- \\
% series   &\match &\match &\match & --    & --    &\match & --    & --    & -- \\
% shape    &\match &\match & --    &\match & --    & --    &\match & --    & -- \\
% size     &\match & --    & --    & --    & --    & --    & --    & --    & -- \\
%\ifnobooktabs\hline\else\bottomrule\fi
%\end{tabular}
%\caption{Order for matching font attributes}\label{tab:test-order}
%\end{table}
%
% \paragraph{Optional options:}
%\begin{description}
%   \item[|name|] You may assign a name to the protrusion settings, so that you
%        are able to load it by another set.
%   \item[|load|] You can load other settings (provided, you previously assigned
%        a name to them), before the current list will be loaded, so that the
%        fonts will inherit the values from the loaded list.
%\end{description}
%
% Using this mechanism, you can for instance create a default list for a font;
% settings for other shapes or series can then load these settings, and
% overwrite or extend them (since the value that comes last will take
% precedence). Font settings will be loaded recursively.
%
%\newpage
% \subsubsection{Font Expansion}
%\Describe{Macro}{\SetExpansion}
%   {[\OptionV{options}] \{\OptionV{set of fonts}\} \{\OptionV{character list}\}}
% The macro for setting up a font for selected expansion works in a similar way,
% therefore I will only describe the differences to \cs{SetProtrusion} here:
%
% You can only specify one number for each character, which determines the
% amount that a character may be expanded. This parameter can be used to
% restrict expansion of certain characters that are more sensitive to
% deformation.
%
% While the default value for character protrusion is~0~-- that is, if you
% didn't specify any characters, none would be protruded~--, the default value
% for expansion is 1000, which means that all characters would be expanded by
% the same amount.
% The numbers denominate thousandth of the full expansion.
% For example, if you set the expansion factor for the character `O' to 500,
% it will only be expanded or shrunk by one half of the amount that the rest
% of the characters will be expanded or shrunk.
%
%\paragraph{Options}
% Additionally to |name| and |load|, the optional first argument accepts the
% following options: |stretch|, |shrink|, |step|, |auto|.
%
% Using these, you may override the global settings specified in the package
% options. Note that if you don't specify either one of |stretch|, |shrink| and
% |step|, their respective global value will be used (that is, no calculation
% will take place). You could for instance take advantage of these options
% in the following way:
%\begin{verbatim}
%\SetExpansion
%   [ load    = T1-default,
%     stretch = 10,
%     shrink  = 10 ]
%   { series  = bf*,
%     encoding= T1  }
%   { }
%\end{verbatim}
% This would use the settings for the characters as defined in the list
% |T1-default|, but expand the bold font by a smaller value (compared to the
% default stretch factor of~20).\footnote{ Note, however, that \pdftex{} does
% not allow different expansion limits or steps within one paragraph.}
%
%\bigskip
% If settings for a font don't exist, font expansion will not be applied to this
% font at all. Should you want all characters to be expanded or shrunk by the
% same amount, declare an empty list for this font, e.\,g.:
%\begin{verbatim}
%\SetExpansion
%   { family = {pkpx,pkpj}, encoding = T1 }
%   { }
%\end{verbatim}
%
%\bigskip
% See the configuration file |microtype.cfg| and the other font-specific files
% for examples of these commands.
%
%
% \subsection{Configuration Files}\label{sub:Config-File}
%
% The default configuration will be loaded from the file |microtype.cfg|. You
% may extend this file with custom settings.
%
% However, if you want to create new expansion and protrusion settings for a
% different font, you should put them into a separate file, whose name must be:
% `|MT-|\meta{font family}|.cfg|', (e.\,g.\ `|MT-pad.cfg|'), and may contain
% \cs{SetProtrusion} and \cs{SetExpansion} commands. These files will only be
% loaded if you are actually using the respective fonts. If the font name
% consists of four characters, the package will also try to find the file for
% the base font family by removing the suffix denoting the sub-family, so that
% you may put settings for the fonts |padx| (expert set), |padj| (oldstyle
% numerals) and |pad| (normal) into one and the same file.
%
% This package ships with configuration files for Computer Modern Roman
% (|MT-cmr.cfg|), Palatino (|MT-ppl.cfg|), the inescapable Times New Roman
% (|MT-ptm.cfg|) and for Adobe Garamond (|MT-pad.cfg|). Settings for \otOne{}
% encoding are only included for Computer Modern Roman.
% If you have created a file for another font and you are willing to share,
% don't hesitate to send it to me so that it can be included in future releases
% of this package.
%
%\bigskip
%\Describe{Macro}{\DeclareMicroTypeAlias}
%    {\{\OptionV{font name}\} \{\OptionV{alias font}\}}
% You may use this command for fonts that are very similar, or actually the
% same (for instance if you did not stick to the Berry naming scheme when
% installing the font). An example would be the Latin Modern fonts which are
% clones of the Computer Modern fonts, so that you probably don't want to
% create new settings for them -- you could say:
%\begin{verbatim}
%\DeclareMicroTypeAlias{lmr}{cmr}
%\end{verbatim}
% which would make the package, whenever it encounters the font |lmr|, pretend
% that it actually found the font |cmr|. In fact, you will find this very line
% in the default configuration file.
%
% \section{Caveats} \paragraph{Use settings that match your font.} Although the
% default settings do give reasonable results for most fonts, the particular
% font you happen to be using may have different character shapes that
% necessitate more or less protrusion or expansion. In particular italic letter
% shapes may differ wildly in different fonts, hence I have decided against
% providing default protrusion settings for them.
%
% The file |test-microtype.tex| might be of some help when adjusting the
% protrusion settings for a font.
%
% \paragraph{Don't use too large a value for expansion.} Font expansion is a
% feature that is supposed to enhance the typographic quality of your document
% by producing a more uniform greyness of the text block. When expanding or
% shrinking a font too much, the effect will be turned into its opposite.
% Expanding the font by more than 2\%, i.\,e.\ setting a |stretch| factor of
% more than 20, should be justified by a typographically trained eye. If you
% are so lucky as to be in the possession of multiple instances of a Multiple
% Master font, you may set expansion limits to up to 4\%.
%
% \paragraph{Load the \pkg{microtype} package as early as possible.} The
% package will only see fonts the first time they are selected. If a font has
% been called before this package is loaded, it will not be set up for
% protrusion or expansion. (This does not apply to the default font, though.)
%
% \paragraph{Don't use font expansion for web documents.} Because each instance
% of the font will be embedded in the \pdf{} file, the file size may increase
% by quite a large factor (depending on expansion limits and step). Therefore,
% courtesy and thriftiness of bandwidth command it not to enable font expansion
% when creating files to be distributed electronically.
%
%
% \section{Contributions}\label{sec:Contrib}
% I would be glad to include configuration files for more fonts.
% Preparing such files is quite a time-consuming task and requires a lot of
% patience. To alleviate this process, this package also includes a test file
% (|test-microtype.tex|) that can be used to check at least the protrusion
% settings.
%
% If you have created a configuration file for another font, or if you have any
% suggestions for enhancements in the default configuration files, you can send
% them to me: \mailtoRS.
%
%
%\newpage
%\begin{thebibliography}{}
% \bibitem[Th\`anh 2000]{ThanhThesis}
%   \thanh, \emph{Micro-typographic extensions to the \TeX{} typesetting system},
%   \newblock Diss. Masaryk University Brno 2000,
%   \newblock in: \textit{TUGBoat}, vol.~21(2000), no.\ 4, pp.~317--434.
%   \newblock (Online at \url{http://www.tug.org/TUGboat/Articles/tb21-4/tb69thanh.pdf})
%
% \bibitem[Th\`anh 2001]{ThanhTUG}
%   \thanh, \emph{Margin Kerning and Font Expansion with \pdftex},
%   \newblock in: \textit{TUGBoat}, vol.~22(2001), no.\ 3 -- Proceedings of the
%            2001 Annual Meeting, pp.~146--148.
%   \newblock (Online at \url{http://www.tug.org/TUGboat/Articles/tb22-3/tb72thanh.pdf})
%
% \bibitem[\LaTeXe{} font selection]{fntguide}
%   \LaTeX3 Project Team, \emph{\LaTeXe{} font selection},
%   \newblock 10 February 2004.
%   \newblock (Available from \ctan{} at \ctanurl{/macros/latex/doc/fntguide.pdf})
%
% \bibitem[\pkg{pdfcprot}]{pdfcprot}
%   Carsten Schurig, \emph{The |pdfcprot.sty| package},
%   \newblock 14 August 2002.
%   \newblock (Available from \ctan{} in \ctanurl{/macros/latex/contrib/pdfcprot/})
%\end{thebibliography}
%
% \StopEventually{
%  \PrintChanges
%  \PrintIndex
% }
%
% ^^A -------------------------------------------------------------------------
%
%\newpage
%\def\MacroFont{\ttfamily\footnotesize} ^^A Who cares to read this, anyway?
%\makeatletter\def\macro@font{\ttfamily\footnotesize}\makeatother
% \section{Implementation}
%^^A\leavevmode ^^A get spacing before macrocode right
% The \pkg{docstrip} modules in this file are:
%\begin{itemize}\setlength{\itemsep}{0pt}
%  \item[|driver|:] The driver file.
%  \item[|package|:] The code for the \pkg{microtype} package.
%  \item[|debug|:] Code for additional output in the log file.\\
%        Used for~-- surprise!~-- debugging purposes.
%  \item[|config|:] The main configuration file (|microtype.cfg|).
%  \item[|cmr-config|:] Settings for Computer Modern Roman (|MT-cmr.cfg|).
%  \item[|pad-config|:] Settings for Adobe Garamond (|MT-pad.cfg|).
%  \item[|ppl-config|:] Settings for Palatino (|MT-ppl.cfg|).
%  \item[|ptm-config|:] Settings for Times New Roman (|MT-ptm.cfg|).
%  \item[|auxiliary|:] A helper file that may be used to create and test protrusion settings
%        (|test-microtype.tex|).
%\end{itemize}
%    \begin{macrocode}
%<*package>
\NeedsTeXFormat{LaTeX2e}[1994/12/01]
\RequirePackage{keyval}
%    \end{macrocode}
%\begin{macro}{\MT@info}
%\begin{macro}{\MT@warning}
% Save some typing.
%    \begin{macrocode}
\def\MT@info#1{\PackageInfo{microtype}{#1}}
\def\MT@warning#1{\PackageWarning{microtype}{#1}}
%    \end{macrocode}
%\end{macro}\end{macro}
%\begin{macro}{\ifMT@DVIoutput}
%\begin{macro}{\ifMT@draft}
%\begin{macro}{\ifMT@verbose}
%\begin{macro}{\ifMT@protrusion}
%\begin{macro}{\ifMT@expansion}
%\begin{macro}{\ifMT@auto}
%\begin{macro}{\MT@expansionlevel}
%\begin{macro}{\MT@protrusionlevel}
%\begin{macro}{\MT@stretch}
%\begin{macro}{\MT@shrink}
%\begin{macro}{\MT@step}
% Declare package options.
%    \begin{macrocode}
\newif\ifMT@DVIoutput
\newif\ifMT@draft
\newif\ifMT@verbose
%<debug>\MT@verbosetrue
\newif\ifMT@protrusion\MT@protrusiontrue
\newif\ifMT@expansion \MT@expansiontrue
\newif\ifMT@auto      \MT@autotrue
\def\MT@expansionlevel{2}
\def\MT@protrusionlevel{2}
\def\MT@stretch{-1}
\def\MT@shrink{-1}
\def\MT@step{-1}
%    \end{macrocode}
%\end{macro}\end{macro}\end{macro}\end{macro}\end{macro}
%\end{macro}\end{macro}\end{macro}\end{macro}\end{macro}\end{macro}
% \subsection{Requirements}
%\begin{macro}{\ifMT@pdf}
%\begin{macro}{\ifMT@adjustprotcodes}
% At first we check whether we are using \pdftex{}.
%    \begin{macrocode}
\newif\ifMT@pdf
\newif\ifMT@adjustprotcodes
\ifx\pdftexversion\undefined\else
   \MT@pdftrue
\fi
%    \end{macrocode}
%\end{macro}\end{macro}
%\begin{macro}{\MT@no@pdftex}
%\begin{macro}{\MT@noprot@pdftex}
%\begin{macro}{\MT@noauto@pdftex}
% Measures in case we don't run \pdftex{}, or it is too old.
%    \begin{macrocode}
\def\MT@no@pdftex{%
   \MT@warning{%
      You don't seem to be using pdftex. \MessageBreak
      All micro-typographic features will be disabled\@gobble}%
   \def\MT@exitornot{%
      \AtEndOfPackage{\let\@unprocessedoptions\relax}%
      \let\CurrentOption\@empty
      \endinput}%
}
\def\MT@noprot@pdftex{%
   \MT@warning{%
      You are using a pdftex version older than 0.14f.\MessageBreak
      microtype doesn't support such antiquated versions.\MessageBreak
      Please install a newer version of pdftex\@gobble}%
   \def\MT@exitornot{%
      \AtEndOfPackage{\let\@unprocessedoptions\relax}%
      \let\CurrentOption\@empty
      \endinput}%
}
\def\MT@noauto@pdftex{%
   \def\MT@exitornot{%
      \AtEndOfPackage{%
         \ifMT@expansion
            \ifMT@auto
               \MT@warning{%
                  You are using a pdftex version older than 1.20a.\MessageBreak
                  Automatic expansion will be turned off.\MessageBreak
                  Please install a newer version of pdftex\@gobble}%
              \MT@autofalse
            \fi
            \def\MT@auto{1000 }%
         \fi
      }%
   }%
}
\let\MT@exitornot\relax
%    \end{macrocode}
%\end{macro}\end{macro}\end{macro}
%    \begin{macrocode}
\ifMT@pdf
   \ifnum\pdftexversion < 14
       \MT@noprot@pdftex
   \else
      \ifnum\pdftexversion = 14
         \ifnum \expandafter`\pdftexrevision < `f
            \MT@noprot@pdftex
         \fi
%    \end{macrocode}
% If \pdftex{} is newer than 0.14g, we have to adjust protrusion factors. We
% check here, too, while we're at it.
%    \begin{macrocode}
         \ifnum \expandafter`\pdftexrevision > `g
            \MT@adjustprotcodestrue
         \fi
      \else
%    \end{macrocode}
% The |autoexpand| feature only works with 1.20a or newer.
%    \begin{macrocode}
         \ifnum\pdftexversion < 120
            \MT@noauto@pdftex
         \else
            \ifnum \expandafter`\pdftexrevision < `a
               \MT@noauto@pdftex
            \else
               \MT@adjustprotcodestrue
            \fi
         \fi
      \fi
   \fi
\else
   \MT@no@pdftex
\fi
%    \end{macrocode}
% We don't want the user commands to generate an error if we are not running
% \pdftex.
%    \begin{macrocode}
\newcommand{\DeclareMicroTypeSet}[3][]{}
\newcommand{\UseMicroTypeSet}[2][]{}
\newcommand{\DeclareMicroTypeAlias}[2]{}
\newcommand{\SetExpansion}[3][]{}
\newcommand{\SetProtrusion}[3][]{}
\newcommand{\microtypesetup}[1]{}
%    \end{macrocode}
% This command also has a starred version.
%    \begin{macrocode}
\def\DeclareMicroTypeSet{%
   \@ifstar
      {\@ifnextchar[\MT@DeclareSet{\MT@DeclareSet[]}}%
      {\@ifnextchar[\MT@DeclareSet{\MT@DeclareSet[]}}%
}
\def\MT@DeclareSet[#1]#2#3{}
%    \end{macrocode}
% Set configurations are only allowed in the preamble. \cs{SetExpansion} and
% \cs{SetProtrusion}, on the other hand, must be allowed in the document, too,
% since they may be loaded from font configuration files.
%    \begin{macrocode}
\@onlypreamble{\DeclareMicroTypeSet}
\@onlypreamble{\UseMicroTypeSet}
\@onlypreamble{\DeclareMicroTypeAlias}
%    \end{macrocode}
% Now we can take the appropriate actions.
%    \begin{macrocode}
\MT@exitornot
%    \end{macrocode}
% \subsection{Auxiliary macros}
%\begin{macro}{\MT@ifempty}
% Test whether argument is empty.
%    \begin{macrocode}
\begingroup
\catcode`\%=4\relax
\catcode`\&=14\relax
\gdef\MT@ifempty#1{&
  \if %#1%&
    \expandafter\@firstoftwo
  \else
    \expandafter\@secondoftwo
  \fi}
\endgroup
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@xadd}
% Add item to a list. (Yes, definitions must be global.)
%    \begin{macrocode}
\def\MT@xadd#1#2{%
   \expandafter\ifx#1\relax
      \xdef#1{#2}%
   \else
      \begingroup
         \edef\x{#2}%
         \toks@=\expandafter\expandafter\expandafter{\expandafter#1\x}%
         \xdef#1{\the\toks@}%
      \endgroup
   \fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@in@list}
% Test whether item is in list.
%    \begin{macrocode}
\newif\ifMT@inlist@
\def\MT@in@list#1#2{%
   \MT@inlist@false
   \def\MT@given{#1}%
   \def\MT@lt##1{\def\MT@next{##1}\ifx\MT@next\MT@given\MT@inlist@true\fi}#2%
}
\let\MT@lt\@empty
%    \end{macrocode}
%\end{macro}
%
% \subsection{Setting up a font}
%\begin{macro}{\MT@setupfont}
% Setting up a font means checking whether protrusion/expansion is desired for
% the current font (\cs{font@name}), and if so, adjusting \cs{lpcode},
% \cs{rpcode}, and \cs{efcode}.
%    \begin{macrocode}
\def\MT@setupfont{%
   \ifMT@verbose\MT@info{Setting up font `\font@name'}\fi
%    \end{macrocode}
% The font properties must be extracted from |\font@name|, since the current
% value of \cs{f@encoding} and friends may be wrong! We split up the name here
% (that we have to set \cs{escapechar} to -1 will get us in trouble, see later).
% Why do we have to set it to -1? See |source2e|.
%
% We could save this trouble if we changed \cs{define@newfont}, so that
% \cs{MT@setupfont} would be called inside its group.
%    \begin{macrocode}
   \begingroup
      \escapechar\m@ne
      \expandafter\expandafter\expandafter
         \MT@split@name\expandafter\string\font@name\@nil
   \endgroup
%    \end{macrocode}
% Something tricky, again: If \cs{f@encoding} is different from \cs{cf@encoding}
% things may get screwed up for encoding-specific commands (|\text...|) in the
% character lists. This for instance happens if a different encoding is called
% with \cs{selectfont} (\cs{@@enc@update} would be called by \cs{selectfont}
% later on, anyway). Therefore, we have to call \cs{@@enc@update}, to redefine
% \meta{encoding}|-cmd| now.
%
% [No longer necessary because translating commands into slot numbers has been
% changed completely.]
%    \begin{macrocode}
%   \ifx\cf@encoding\f@encoding\else\@@enc@update\fi
%    \end{macrocode}
% Try to find a configuration file for the current font family.
%    \begin{macrocode}
   \MT@find@file
%    \end{macrocode}
% Protrusion has to be set up first, says Thành!
%    \begin{macrocode}
   \MT@checkfor{protrusion}%
   \ifMT@font@protrusion
      \MT@set@prot@codes
      \else\ifMT@verbose\MT@info{... No protrusion\@gobble}\fi
   \fi
   \MT@checkfor{expansion}%
   \ifMT@font@expansion
      \MT@set@exp@codes
      \else\ifMT@verbose\MT@info{... No expansion\@gobble}\fi
   \fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\ifMT@font@protrusion}
%\begin{macro}{\ifMT@font@expansion}
%\begin{macro}{\MT@checkfor}
% We check all features of the current font against the lists defined by the
% |expansion| resp.\ |protrusion| option, and set \cs{MT@font@expanion} resp.\
% \cs{MT@font@protrusion} accordingly.
%    \begin{macrocode}
\newif\ifMT@font@protrusion
\newif\ifMT@font@expansion
\def\MT@checkfor#1{%
%    \end{macrocode}
% (but only if protrusion/expansion isn't set to false)
%    \begin{macrocode}
   \csname ifMT@#1\endcsname
      \csname MT@font@#1true\endcsname
      \MT@checklist{#1}{encoding}%
      \MT@checklist{#1}{family}%
      \MT@checklist{#1}{series}%
      \MT@checklist{#1}{shape}%
      \MT@checklist{#1}{size}%
   \fi
}
%    \end{macrocode}
%\end{macro}\end{macro}\end{macro}
%\begin{macro}{\MT@checklist}
% If we've already found that a property is not in the list, we don't have to
% bother any more.
%    \begin{macrocode}
\def\MT@checklist#1#2{%
   \csname ifMT@font@#1\endcsname\MT@checklist@{#1}{#2}\fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@checklist@}
%    \begin{macrocode}
\def\MT@checklist@#1#2{%
   \edef\@tempa{\csname MT@#1@setname\endcsname}%
%    \end{macrocode}
% If no limitations have been specified, i.e. the list for a font characteristic
% has not been defined at all, the font should be expanded resp.\ protruded.
%    \begin{macrocode}
   \expandafter\ifx\csname MT@#1list@#2@\@tempa\endcsname\relax
%<debug>      \MT@info{#1: #2 list empty}%
%    \end{macrocode}
% Otherwise, begin a \cs{expandafter} orgy to test whether the font characteristic is
% in the list.
%    \begin{macrocode}
   \else
      \def\MT@listname{\csname MT@#1list@#2@\@tempa\endcsname}%
      \expandafter\expandafter\expandafter\MT@in@list
         \expandafter\expandafter\expandafter
            {\csname MT@#2\endcsname}\MT@listname
      \ifMT@inlist@
%<debug>         \MT@info{#1: #2 `\csname MT@#2\endcsname' in list}%
      \else
         \csname MT@font@#1false\endcsname
%<debug>         \MT@info{#1: #2 `\csname MT@#2\endcsname' not in list}%
      \fi
   \fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{MT@split@name}
% Split up the font name (definitions must be global, since this is, and will
% be, called from inside a group).
%    \begin{macrocode}
{\catcode`\/=12
 \gdef\MT@split@name#1/#2/#3/#4/#5\@nil{%
   \gdef\MT@encoding{#1}%
   \gdef\MT@family{#2}%
   \gdef\MT@series{#3}%
   \gdef\MT@shape{#4}%
   \gdef\MT@size{#5}%
%    \end{macrocode}
% Alias family?
%    \begin{macrocode}
   \expandafter\ifx\csname MT@\MT@family @alias\endcsname\relax\else
      \ifMT@verbose
         \MT@info{... Using alias family name
            `\csname MT@\MT@family @alias\endcsname'\@gobble}%
      \fi
      \MT@escapechar{\csname MT@\MT@family @alias\endcsname}%
      \xdef\MT@family{\MT@val}%
   \fi
}}
%    \end{macrocode}
%\end{macro}
% \subsubsection{Protrusion}
%\begin{macro}{\MT@set@prot@codes}
% This macro is called by \cs{MT@setupfont}, and does all the work for setting
% up a font for protrusion.
%    \begin{macrocode}
\def\MT@set@prot@codes{%
%    \end{macrocode}
% Check which list should be applied to the current font.
%    \begin{macrocode}
   \MT@get@codes@list{prot}%
%    \end{macrocode}
% We might not have found a list.
%    \begin{macrocode}
   \@ifundefined{MT@protcodes@\MT@protcodes@name}{}{%
%    \end{macrocode}
% Load additional lists?
%    \begin{macrocode}
      \MT@load@list{prot}{\MT@protcodes@name}%
%    \end{macrocode}
% Load the main list.
%    \begin{macrocode}
      \expandafter\let\expandafter\@tempc
         \csname MT@protcodes@\MT@protcodes@name\endcsname
      \expandafter\MT@protdo\@tempc,\relax,%
      \MT@adjustprotcode
   }%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@protdo}
%\begin{macro}{\MT@protsplit}
%\begin{macro}{\MT@protsplit@val}
% Split up the values and set the \cs{rpcode}s and \cs{lpcode}s.
%    \begin{macrocode}
\def\MT@protdo#1,{%
   \ifx\relax#1\empty\else
      \MT@protsplit #1==\relax
      \expandafter\MT@protdo\fi
}
\def\MT@protsplit#1=#2=#3\relax{%
   \KV@@sp@def\@tempa{#1}%
   \ifx\@tempa\@empty\else
      \MT@get@slot
      \KV@@sp@def\@tempb{#2}%
      \ifnum\@tempc < \@cclvi
         \expandafter\MT@protsplit@val\@tempb\relax
      \fi
   \fi
}
\def\MT@protsplit@val#1,#2\relax{%
   \KV@@sp@def\@tempb{#1}%
   \ifnum\@tempb > \m@ne
      \lpcode\font@name\@tempc=\@tempb
   \fi
   \KV@@sp@def\@tempb{#2}%
   \ifnum\@tempb > \m@ne
      \rpcode\font@name\@tempc=\@tempb
   \fi
}
%    \end{macrocode}
%\end{macro}\end{macro}\end{macro}
%\begin{macro}{\MT@adjustprotcode}
% Since \pdftex{} version 0.14g, we have to adjust the protrusion factors
% (i.\,e., convert numbers from thousandth of character width to thousandth of
% an \emph{em} of the font).
%    \begin{macrocode}
\ifMT@adjustprotcodes
   \def\MT@adjustprotcode{%
      \@tempcnta=\z@
      \loop
         \ifcase\lpcode\font@name\@tempcnta\else
            \MT@@adjustprotcode\lpcode{\font@name}\@tempcnta
         \fi
         \ifcase\rpcode\font@name\@tempcnta\else
            \MT@@adjustprotcode\rpcode{\font@name}\@tempcnta
         \fi
         \advance\@tempcnta \@ne
      \ifnum\@tempcnta < \@cclvi \repeat
   }
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@@adjustprotcode}
% We use code stolen from \thanh's |protcode.tex|.
%    \begin{macrocode}
   \def\MT@@adjustprotcode#1#2#3{%
      \setbox0=\hbox{%
         \ifx#2\font\else#2\fi
         \char#3}%
     %\setbox0=\hbox{\the#2\char#3}%  says pdfcprot.sty
      \@tempcntb=\wd0
      \multiply\@tempcntb #1#2#3%
      \divide\@tempcntb \fontdimen6 #2%
      #1#2#3=\@tempcntb
   }
\else
   \let\MT@adjustprotcode\relax
\fi
%    \end{macrocode}
%\end{macro}
%
% \subsubsection{Expansion}
%\begin{macro}{\MT@set@exp@codes}
% The same for font expansion.
%    \begin{macrocode}
\def\MT@set@exp@codes{%
   \MT@get@codes@list{exp}%
   \@ifundefined{MT@expcodes@\MT@expcodes@name}{}{%
%    \end{macrocode}
% We \emph{could} move \cs{MT@resetefcode} outside of the font check. That would
% mean that a font would be expanded (all characters by the same amount), even
% though there's no list for it. Debatable.
%    \begin{macrocode}
      \MT@resetefcode
      \MT@load@list{exp}{\MT@expcodes@name}%
      \expandafter\let\expandafter\@tempc
         \csname MT@expcodes@\MT@expcodes@name\endcsname
      \expandafter\MT@expdo\@tempc,\relax,%
      \MT@get@extraopt
      \pdffontexpand\font@name \MT@stretch@ \MT@shrink@ \MT@step@ \MT@auto@%
   }%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@resetefcode}
% At first, all expansion factors for the characters will be set to 1000.
%    \begin{macrocode}
\def\MT@resetefcode{%
   \@tempcnta\z@
   \loop
      \efcode\font@name\@tempcnta=\@m
      \advance\@tempcnta \@ne
      \ifnum\@tempcnta < \@cclvi \repeat
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@expdo}
% There's only one number per character.
%    \begin{macrocode}
\def\MT@expdo#1,{%
   \ifx\relax#1\empty\else
      \MT@expsplit #1==\relax
      \expandafter\MT@expdo\fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@expsplit}
%    \begin{macrocode}
\def\MT@expsplit#1=#2=#3\relax{%
   \KV@@sp@def\@tempa{#1}%
   \ifx\@tempa\@empty\else
      \MT@get@slot
      \KV@@sp@def\@tempb{#2}%
      \ifnum\@tempc < \@cclvi
         \efcode\font@name\@tempc=\@tempb
      \fi
   \fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@get@extraopt}
% Apply different values to this font?
%    \begin{macrocode}
\def\MT@get@extraopt{%
   \@ifundefined{MT@expcodes@\MT@expcodes@name stretch}%
      {\let\MT@stretch@\MT@stretch}%
      {\expandafter\let\expandafter\MT@stretch@
         \csname MT@expcodes@\MT@expcodes@name stretch\endcsname
       \ifMT@verbose\MT@info{... ... Setting stretch factor to
         \MT@stretch@\@gobble}\fi}%
   \@ifundefined{MT@expcodes@\MT@expcodes@name shrink}%
      {\let\MT@shrink@\MT@shrink}%
      {\expandafter\let\expandafter\MT@shrink@
         \csname MT@expcodes@\MT@expcodes@name shrink\endcsname
       \ifMT@verbose\MT@info{... ... Setting shrink factor to
         \MT@shrink@\@gobble}\fi}%
   \@ifundefined{MT@expcodes@\MT@expcodes@name step}%
      {\let\MT@step@\MT@step}%
      {\expandafter\let\expandafter\MT@step@
         \csname MT@expcodes@\MT@expcodes@name step\endcsname
       \ifMT@verbose\MT@info{... ... Setting step to
         \MT@step@\@gobble}\fi}%
   \@ifundefined{MT@expcodes@\MT@expcodes@name auto}%
      {\let\MT@auto@\MT@auto}%
      {\expandafter\let\expandafter\MT@auto@
         \csname MT@expcodes@\MT@expcodes@name auto\endcsname
       \ifMT@verbose\MT@info{... ... Setting autoexpansion to
         \MT@auto@\@gobble}\fi}%
}
%    \end{macrocode}
%\end{macro}
% \subsubsection{Generic macros}
%\begin{macro}{\MT@load@list}
% Recurse through the lists to be loaded.
%    \begin{macrocode}
\def\MT@load@list#1#2{%
   \edef\@tempa{#2}%
   \expandafter\let\expandafter\@tempb\csname MT@#1codes@\@tempa load\endcsname
   \ifx\@tempb\relax\else
      \ifMT@verbose\MT@info{... ... Additionally loading #1. list `\@tempb'\@gobble}\fi
      \begingroup
         \MT@load@list{#1}{\@tempb}%
      \endgroup
      \expandafter\let\expandafter\@tempc\csname MT@#1codes@\@tempb\endcsname
      \expandafter\csname MT@#1do\expandafter\endcsname\@tempc,\relax,%
   \fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@find@file}
% Micro-typographic settings may be written into a file |MT-|\meta{font family}|.cfg|:
%    \begin{macrocode}
\let\MT@files\@empty
\def\MT@find@file{%
%    \end{macrocode}
% Check for existence of the file only once.
%    \begin{macrocode}
   \expandafter\expandafter\expandafter\MT@in@list
      \expandafter\expandafter\expandafter
         {\csname MT@file@\MT@family\endcsname}\MT@files
   \ifMT@inlist@\else
%    \end{macrocode}
% We have to take care that all characters have the correct category code.
% Especially, new lines and spaces should be ignored, since files might be
% loaded in the middle of the document.
%    \begin{macrocode}
      \begingroup
      \nfss@catcodes
      \InputIfFileExists{MT-\MT@family.cfg}
         {\ifMT@verbose\MT@info{... Loading font settings
            from MT-\MT@family.cfg\@gobble}\fi}%
         {\InputIfFileExists{MT-\MT@base@family.cfg}
            {\ifMT@verbose\MT@info{... Loading font settings
               from MT-\MT@base@family.cfg\@gobble}\fi}%
            {\ifMT@verbose\MT@info{... No file MT-\MT@family.cfg\@gobble}\fi}}%
      \endgroup
      \MT@xadd\MT@files{\noexpand\MT@lt{\csname MT@file@\MT@family\endcsname}}%
   \fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@base@family}
%\begin{macro}{\MT@get@base}
% The family name might have a suffix for expert or old style number font set
% (|x| or |j|). Here, we remove it.
%    \begin{macrocode}
\def\MT@base@family{\expandafter\MT@get@base\MT@family\@nil}
\def\MT@get@base#1#2#3#4\@nil{#1#2#3}
%    \end{macrocode}
%\end{macro}\end{macro}
%\begin{macro}{\MT@get@codes@list}
% Try all combinations of font family, series and shape to get a list for the
% current font.
%    \begin{macrocode}
\def\MT@get@codes@list#1{%
   \edef\@tempa{\MT@encoding/\MT@family/\MT@series/\MT@shape/\MT@size}%
%<debug>   \MT@info{trying to find #1. list for font \@tempa}%
   \@ifundefined{MT@#1codes@\@tempa}{%
      \edef\@tempa{\MT@encoding/\MT@family/\MT@series/\MT@shape/}%
%<debug>      \MT@info{trying \@tempa}%
      \@ifundefined{MT@#1codes@\@tempa}{%
         \edef\@tempa{\MT@encoding/\MT@family/\MT@series//}%
%<debug>         \MT@info{trying \@tempa}%
         \@ifundefined{MT@#1codes@\@tempa}{%
            \edef\@tempa{\MT@encoding/\MT@family//\MT@shape/}%
%<debug>            \MT@info{trying \@tempa}%
            \@ifundefined{MT@#1codes@\@tempa}{%
               \edef\@tempa{\MT@encoding/\MT@family///}%
%<debug>               \MT@info{trying \@tempa}%
               \@ifundefined{MT@#1codes@\@tempa}{%
                  \edef\@tempa{\MT@encoding//\MT@series//}%
%<debug>                  \MT@info{trying \@tempa}%
                  \@ifundefined{MT@#1codes@\@tempa}{%
                     \edef\@tempa{\MT@encoding///\MT@shape/}%
%<debug>                     \MT@info{trying \@tempa}%
                     \@ifundefined{MT@#1codes@\@tempa}{%
                        \edef\@tempa{\MT@encoding////}%
%<debug>                        \MT@info{trying \@tempa}%
                        \@ifundefined{MT@#1codes@\@tempa}{%
                           \edef\@tempa{////}%
%<debug>                           \MT@info{trying \@tempa}%
   }{}}{}}{}}{}}{}}{}}{}}{}%
   \@ifundefined{MT@#1codes@\@tempa}%
      {\expandafter\let\expandafter\@tempb\csname MT@#1codes@name\endcsname
       \expandafter\let\csname MT@#1codes@\@tempb\endcsname\relax
       \MT@warning{I cannot find an #1. list for `\font@name'.\MessageBreak
            Switching off #1. for this font}}%
      {\expandafter\edef\csname MT@#1codes@name\endcsname
         {\csname MT@#1codes@\@tempa\endcsname}%
       \ifMT@verbose
         \MT@info{... Using #1. list `\csname MT@#1codes@name\endcsname'\@gobble}%
       \fi}%
}
%    \end{macrocode}
%\begin{macro}{\MT@get@slot}
% Get the slot number of the character in the current encoding. There are three
% possibilities:
%    \begin{macrocode}
\def\MT@get@slot{%
   \def\@tempc{\@cclvi}%
%    \end{macrocode}
%\begin{enumerate}
% \item The character is either specified as a three-digit number; \dots
%    \begin{macrocode}
   \expandafter\MT@three@digits\@tempa\relax\relax\relax
   \ifnum\@tempc < \@cclvi\else
%    \end{macrocode}
% Well, it may also be a backslash, which would be recognized as a command~\dots
%    \begin{macrocode}
      \expandafter\ifx\@tempa\ \relax
         \edef\@tempc{\number`\\}%
%    \end{macrocode}
% \item as a command declared by \cs{DeclareTextSymbol};
%    \begin{macrocode}
      \else
         \expandafter\ifcat\expandafter\noexpand\@tempa\relax
%    \end{macrocode}
% Fortunately, we can assume that the command actually exists in the current
% encoding. Therefore, we can simply call |\|\meta{encoding}|\|\meta{command}
% instead of |\|\meta{command} itself, which might expand to funny stuff,
% depending on context.
%
% We have to reset the escapechar, since it might be -1. Then we check whether
% the command is defined in the current encoding. We should also test whether it
% has been declared by \cs{DeclareTextSymbol}, i.\,e.\ whether it expands to
% |\char"|\meta{hex number} \dots\ better error handling remains TO DO.
%    \begin{macrocode}
            \begingroup\escapechar=`\\
            \expandafter\expandafter\expandafter
                  \ifx\expandafter\csname\expandafter\MT@encoding
                        \expandafter\string\@tempa\endcsname\relax
               \MT@warning{\expandafter\string\@tempa\space
                           is undefined in encoding `\MT@encoding'}%
            \else
               \xdef\@tempc{\expandafter\number
                     \expandafter\csname\expandafter\MT@encoding
                           \expandafter\string\@tempa\endcsname}%
            \fi
            \endgroup
         \else
%    \end{macrocode}
% \item  or by itself (e.\,g.\ `|A|', or `|\"A|').
%    \begin{macrocode}
            \expandafter\MT@two@tokens\@tempa\relax\relax
            \expandafter\edef\expandafter\@tempc\expandafter
                  {\expandafter\number\expandafter`\@tempa}%
         \fi
      \fi
   \fi
}
%    \end{macrocode}
%\end{enumerate}
%\end{macro}
%\begin{macro}{\MT@two@tokens}
% If we find two tokens, expand them to get the actual character.
%    \begin{macrocode}
\def\MT@two@tokens#1#2\relax{%
   \MT@ifempty{#2}{}%
      {\edef\@tempa{\@tempa}}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@three@digits}
% Check whether it's a three-digit number.
%    \begin{macrocode}
\def\MT@three@digits#1#2#3\relax{%
   \ifx#3\relax\else
      \def\@tempc{\number#1#2#3}%
   \fi
}
%    \end{macrocode}
%\end{macro}
%
% \subsubsection{Changes to \LaTeX's font selection scheme}
% We add \cs{MT@setupfont} to \cs{define@newfont}, which is called by \LaTeX{}
% whenever a font is selected that has previously not been declared. This
% ensures that we will catch all fonts, and that we will not set up fonts more
% than once.
%
% In contrast to the \pkg{pdfcprot} package, there is no need to declare the
% fonts in advance that shall be subject to micro-typography. Also, only those
% fonts that are actually being used will be set up for expansion and
% protrusion, thus saving time and memory.
%
% For my reference:
%\begin{itemize}
%  \item \cs{pickup@font} calls \cs{define@newfont}.
%  \item \cs{define@newfont} may call
%  \begin{itemize}
%     \item \cs{wrong@fontshape}, which in turn will call \cs{pickup@font},
%        and thus \cs{define@newfont} again, or
%     \item \cs{extract@font}.
%  \end{itemize}
%  \item \cs{pickup@font} is called by \cs{wrong@fontshape}, \cs{selectfont},
%     or \cs{getanddefine@fonts} (for math).
%\end{itemize}
%
% It \emph{might} be better to use \cs{pickup@font} for our purposes and check
% for ourselves whether we've seen the font before. I'll wait for bug reports~\dots
%    \begin{macrocode}
\g@addto@macro\define@newfont{%
   \MT@setupfont
}
%    \end{macrocode}
% We make sure that the default font is set up, too.
%    \begin{macrocode}
\AtBeginDocument{%
   \normalfont\MT@setupfont
}
%    \end{macrocode}
%\end{macro}
%
% \subsection{Configuration}
% \subsubsection{Font Sets}
%\begin{macro}{\DeclareMicroTypeSet}
%\begin{macro}{\DeclareMicroTypeSet*}
% Calling this macro will create a list for every font characteristic of the form:
% |\MT|\meta{|expansion|\textbar|protrusion|}|list@|\meta{characteristic}|@|\meta{set name}.
% If the optional macro is empty, lists for both expansion and protrusion will
% be created.
%
% The third argument must be a list of |key=value| pairs. If a font characteristic
% is unspecified, we define the corresponding list to \cs{relax}, so that it
% does not constitute a constraint.
%
% The internal list will be of the form |\MT@lt {|\meta{var1}|} \MT@lt {|\meta{var2}|} ... |,
% where |\MT@lt| acts as the delimiter between the list entries.
%    \begin{macrocode}
\def\DeclareMicroTypeSet{%
   \@ifstar
      {\@ifnextchar[%]
         \MT@DeclareSetAndUseIt
         {\MT@DeclareSetAndUseIt[]}}%
      {\@ifnextchar[%]
         \MT@DeclareSet
         {\MT@DeclareSet[]}}%
}
%    \end{macrocode}
%\end{macro}\end{macro}
%\begin{macro}{\MT@DeclareSet}
%    \begin{macrocode}
\def\MT@DeclareSet[#1]#2#3{%
   \MT@DeclareSet@{#1}{#2}{#3}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@DeclareSetAndUseIt}
%    \begin{macrocode}
\def\MT@DeclareSetAndUseIt[#1]#2#3{%
   \MT@DeclareSet@{#1}{#2}{#3}%
   \UseMicroTypeSet[#1]{#2}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@DeclareSet@}
%    \begin{macrocode}
\def\MT@DeclareSet@#1#2#3{%
  \MT@ifempty{#1}%
    {\MT@declare@sets{expansion}{#2}{#3}%
     \MT@declare@sets{protrusion}{#2}{#3}}%
    {\MT@declare@sets{#1}{#2}{#3}}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@declare@sets}
% Define the current set name and parse the keys.
%    \begin{macrocode}
\def\MT@declare@sets#1#2#3{%
   \def\MT@tmp@setname{#2}%
   \expandafter\let\csname MT@#1list@@\MT@tmp@setname\endcsname\@empty
%<debug>   \MT@info{declaring #1 set `\MT@tmp@setname'}%
   \setkeys{MT#1@set}{#3}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@define@set@keys}
% Define the \pkg{keyval} keys for expansion and protrusion sets.
%    \begin{macrocode}
\def\MT@define@set@keys#1{%
   \MT@define@set@key{#1}{encoding}%
   \MT@define@set@key{#1}{family}%
   \MT@define@set@key{#1}{series}%
   \MT@define@set@key{#1}{shape}%
   \MT@define@set@key@size{#1}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@define@set@key}
% \meta{\#1} = [|expansion|\textbar|protrusion|], \meta{\#2} = font axis,
%    \begin{macrocode}
\def\MT@define@set@key#1#2{%
   \define@key{MT#1@set}{#2}[]{%
      \@for\MT@val:=##1\do{%
%    \end{macrocode}
% Get rid of spaces.
%    \begin{macrocode}
         \expandafter\KV@@sp@def\expandafter\MT@val\expandafter{\MT@val}%
         \MT@get@highlevel{#2}%
         \MT@escapechar{\MT@val}%
         \MT@addto@list{#1}{#2}{\MT@val}%
      }%
%<debug>      \MT@info{-- #2: \csname MT@#1list@#2@\MT@tmp@setname\endcsname\@gobble}%
   }%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@get@highlevel}
% Saying, for instance, |family={rm*}| or |shape={bf*}| will lead to
% \cs{rmdefault} resp.\ \cs{bfdefault} being expanded/protruded.
%    \begin{macrocode}
\def\MT@get@highlevel#1{%
   \MT@getlast{\MT@val}%
   \if*\@tempb
%    \end{macrocode}
% And |family = *| will become \cs{familydefault}.
%    \begin{macrocode}
      \MT@ifempty{\@tempa}%
         {\def\@tempa{#1}}{}%
%    \end{macrocode}
% Beware that |\rmdefault| etc.\ might change after this package has been
% loaded!
%    \begin{macrocode}
      \def\MT@val{\csname \@tempa default\endcsname}%
   \fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@getlast}
%\begin{macro}{\MT@getlast@}
%    \begin{macrocode}
\def\MT@getlast#1{\def\@tempa{}\def\@tempb{}%
   \expandafter\MT@getlast@#1\@nil}
\def\MT@getlast@#1{\ifx#1\@nil \let\next=\relax
   \else \edef\@tempa{\@tempa\@tempb}\def\@tempb{#1}%
      \let\next=\MT@getlast@\fi \next}
%    \end{macrocode}
%\end{macro}\end{macro}
%\begin{macro}{\MT@escapechar}
% Make sure that the escape char is set to -1, and catcodes are the same, as in
% the original font name, so that the comparison doesn't fail.
%    \begin{macrocode}
\def\MT@escapechar#1{%
   \begingroup
   \escapechar\m@ne
   \xdef\MT@val{\expandafter\string\csname #1\endcsname}%
   \endgroup
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@define@set@key@size}
% |size| requires special treatment.
%    \begin{macrocode}
\def\MT@define@set@key@size#1{%
   \define@key{MT#1@set}{size}[]{%
      \@for\MT@val:=##1\do{%
         \expandafter\KV@@sp@def\expandafter\MT@val\expandafter{\MT@val}%
         \MT@get@size
%    \end{macrocode}
% Strip `pt' if necessary.
%    \begin{macrocode}
         \@defaultunits\@tempdima\MT@val pt\relax\@nnil
         \edef\MT@val{\strip@pt\@tempdima}%
%         \MT@escapechar{\MT@val}%
         \MT@addto@list{#1}{size}{\MT@val}%
      }%
%<debug>      \MT@info{-- size: \csname MT@#1list@size@\MT@tmp@setname\endcsname\@gobble}%
   }%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@get@size}
% If it's not specified as a dimension, we tackle the size selection command
% here.
%    \begin{macrocode}
\def\MT@get@size{%
%    \end{macrocode}
% A single star means \cs{sizedefault}, which doesn't exist, so we define it to
% be \cs{normalsize}.
%    \begin{macrocode}
   \if*\MT@val
      \def\@tempa{\normalsize}%
   \else
      \expandafter\let\expandafter\@tempa\csname\MT@val\endcsname
   \fi
   \ifx\@tempa\relax\else
      \begingroup
         \def\@setfontsize##1##2##3##4\@nil{\gdef\MT@val{##2}}%
         \@tempa\@nil
      \endgroup
   \fi
}
%\def\MT@get@size{%
%   \expandafter\let\expandafter\@tempa\csname\MT@val\endcsname
%   \ifx\@tempa\relax\else
%    \end{macrocode}
% % This does not work with the AMS classes.
% %    \begin{macrocode}
% %      \expandafter\MT@get@size@\@tempa\MT@size@delim{\@tempa}%
% %    \end{macrocode}
% % I hope it is safe to use this instead.
%    \begin{macrocode}
%      \begingroup
%         \def\@setfontsize##1##2##3##4\@nil{\gdef\MT@val{##2}}%
%         \csname#1\endcsname\@nil
%      \endgroup
%   \fi
%}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@get@size@}
% To get the actual size, we parse the command, looking for \cs{@setfontsize},
% and get its second argument (stolen from |relsize|).
%    \begin{macrocode}
%\def\MT@get@size@#1#2#3#4\MT@size@delim#5{%
%   \def\@tempa{}%
%   \ifx\@setfontsize#1\relax\ifx#5#2\@firstofone\relax
%      \def\@tempa{#3}%
%   \fi\fi
%   \MT@ifempty{\@tempa}%
%      {\MT@warning{Could not parse size `\MT@val'\MessageBreak
%            for font set `\MT@tmp@setname'}}%
%      {\def\MT@val{\@tempa}}%
%}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@addto@list}
% Append the value \meta{\#3} to the expansion or protrusion (= \meta{\#1}) list
% for font axis \meta{\#2}.
%    \begin{macrocode}
\def\MT@addto@list#1#2#3{%
   \expandafter\MT@xadd\csname MT@#1list@#2@\MT@tmp@setname\endcsname
      {\noexpand\MT@lt{#3}}%
}
%    \end{macrocode}
%\end{macro}
%    \begin{macrocode}
\def\MT@tmp@setname{}
\MT@define@set@keys{expansion}
\MT@define@set@keys{protrusion}
%    \end{macrocode}
%\begin{macro}{\UseMicroTypeSet}
% To use a particular set we simply redefine
% |\MT@|\meta{|expansion|\textbar|protrusion|}|@setname|. If the optional
% argument is empty, both \cs{MT@expansion@setname} and
% \cs{MT@protrusion@setname} will be redefined.
%    \begin{macrocode}
\renewcommand{\UseMicroTypeSet}[2][]{%
  \MT@ifempty{#1}%
   {\MT@use@sets{expansion}{#2}%
    \MT@use@sets{protrusion}{#2}}%
   {\MT@use@sets{#1}{#2}}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@use@sets}
% The set might be defined later on.
%    \begin{macrocode}
\def\MT@use@sets#1#2{%
   \expandafter\edef\csname MT@#1@setname\endcsname{#2}%
   \expandafter\ifx\csname MT@#1list@@#2\endcsname\relax
      \MT@warning{#1 set `#2' currently not defined.\MessageBreak Using it anyway}%
      \else\MT@info{Using #1 set `#2'}\fi
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\DeclareMicroTypeAlias}
% This can be used to set an alias name for a font, so that the file (and the
% settings) for the aliased font will be loaded.
%    \begin{macrocode}
\renewcommand{\DeclareMicroTypeAlias}[2]{%
   \expandafter\def\csname MT@#1@alias\endcsname{#2}%
}
%</package>
%    \end{macrocode}
%\end{macro}
%
% \subsubsection{Declarations}
% We now set up some default sets (in the configuration file).
%    \begin{macrocode}
%<*config>

\DeclareMicroTypeSet{all}{}

\DeclareMicroTypeSet{alltext}
   { encoding = {T1,OT1,LY1,TS1} }

\DeclareMicroTypeSet{basictext}
   { encoding = {T1,OT1,LY1},
     family   = {rm*,sf*},
     series   = {m},
     shape    = {},
     size     = {normalsize,footnotesize,small,large}
   }

\DeclareMicroTypeSet{normalfont}
   { encoding = *,
     family   = *,
     series   = *,
     shape    = *,
     size     = *
   }

%    \end{macrocode}
% The Latin Modern Fonts inherit the settings from Computer Modern.
%    \begin{macrocode}
\DeclareMicroTypeAlias{lmr}{cmr}
%</config>
%    \end{macrocode}
% Make sure that font sets are defined at the end of the package. If the user
% hasn't activated any, we use the `|alltext|' sets. They can be overridden
% later on, of course.
%    \begin{macrocode}
%<*package>
\AtEndOfPackage{%
   \@ifundefined{MT@expansion@setname}%
      {\UseMicroTypeSet[expansion]{basictext}}{}%
   \@ifundefined{MT@protrusion@setname}%
      {\UseMicroTypeSet[protrusion]{alltext}}{}%
}
%    \end{macrocode}
%
% \subsubsection{Fine Tuning}
% The macros \cs{SetExpansion} and \cs{SetProtrusion} provide a similar
% interface for setting the character protrusion resp. expansion factors for a
% set of fonts.
%
%\begin{macro}{\SetExpansion}
% This macro accepts three arguments: [options,] set of font characteristics and
% list of character protrusion factors.
%
% A new macro called |\MT@expcodes@|\meta{name} will be defined to be \meta{\#3}
% (i.e. the list of characters).
%    \begin{macrocode}
\renewcommand{\SetExpansion}[3][]{%
   \let\MT@expcodes@name\relax
%    \end{macrocode}
% Parse the first argument:
%    \begin{macrocode}
   \setkeys{MT@expcodes}{#1}%
%    \end{macrocode}
% If the user hasn't specified a name we will create one.
%    \begin{macrocode}
   \MT@get@codes@name{exp}%
%<debug>   \MT@info{creating expansion list `\MT@expcodes@name'}%
%    \end{macrocode}
% Now we can define the macro to be \meta{\#3}. Here, as elsewhere, we have to
% make the definitions global, since they may occur inside a group.
%    \begin{macrocode}
   \expandafter\gdef\csname MT@expcodes@\MT@expcodes@name\endcsname{#3}%
%    \end{macrocode}
% The second argument:
% We define macros for all permutations of the font characteristics to point to
% this macro.
%    \begin{macrocode}
   \setkeys{MT@expcodes}{#2}%
   \def\MT@permutelist{exp}%
   \MT@permute
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\SetProtrusion}
% |\SetProtrusion| is just the same.
%    \begin{macrocode}
\renewcommand{\SetProtrusion}[3][]{%
   \let\MT@protcodes@name\relax
   \setkeys{MT@protcodes}{#1}%
   \MT@get@codes@name{prot}%
%<debug>   \MT@info{creating protrusion list `\MT@protcodes@name'}%
   \expandafter\gdef\csname MT@protcodes@\MT@protcodes@name\endcsname{#3}%
   \setkeys{MT@protcodes}{#2}%
   \def\MT@permutelist{prot}%
   \MT@permute
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@get@codes@name}
% Simply use a roman number as the list name.
%    \begin{macrocode}
\def\MT@get@codes@name#1{%
   \@ifundefined{MT@#1codes@name}%
      {\@tempcnta=\@ne
       \loop
         \@ifundefined{MT@#1codes@#1-\romannumeral\@tempcnta}%
            {\expandafter\edef\csname MT@#1codes@name\endcsname
                  {#1-\romannumeral\@tempcnta}%
             \@tempcnta=\z@ }%
            {\advance \@tempcnta \@ne}%
          \ifnum\@tempcnta > \z@ \repeat}%
      {\@ifundefined{MT@#1codes@\csname MT@#1codes@name\endcsname}{}{%
         \MT@warning{Redefining list `\csname MT@#1codes@name\endcsname'}}}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@declare@codes}
% Define the keys for expansion and protrusion character code lists.
%    \begin{macrocode}
\def\MT@declare@codes#1{%
   \define@key{MT@#1codes}{name}[]{%
      \MT@ifempty{##1}{}{%
         \expandafter\gdef\csname MT@#1codes@name\endcsname{##1}%
      }%
   }%
   \define@key{MT@#1codes}{load}[]{%
      \MT@ifempty{##1}{}{%
         \expandafter\let\expandafter\@tempa\csname MT@#1codes@name\endcsname
         \expandafter\gdef\csname MT@#1codes@\@tempa load\endcsname{##1}%
      }%
   }%
   \MT@define@code@key{#1}{encoding}%
   \MT@define@code@key{#1}{family}%
   \MT@define@code@key{#1}{series}%
   \MT@define@code@key{#1}{shape}%
   \MT@define@code@key@size{#1}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@define@code@key}
%    \begin{macrocode}
\def\MT@define@code@key#1#2{%
   \define@key{MT@#1codes}{#2}[]{%
      \@tempcnta=\@ne
      \@for\MT@val:=##1\do{%
         \expandafter\KV@@sp@def\expandafter\MT@val\expandafter{\MT@val}%
%    \end{macrocode}
% Here, too, we allow for something like |bf*|. It will expanded immediately.
%    \begin{macrocode}
         \MT@get@highlevel{#2}%
         \expandafter\edef\csname MT@temp#2\romannumeral\@tempcnta\endcsname{\MT@val}%
         \advance\@tempcnta \@ne
      }%
   }%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@define@code@key@size}
%    \begin{macrocode}
\def\MT@define@code@key@size#1{%
   \define@key{MT@#1codes}{size}[]{%
      \@tempcnta=\@ne
      \@for\MT@val:=##1\do{%
         \expandafter\KV@@sp@def\expandafter\MT@val\expandafter{\MT@val}%
         \MT@get@size
         \expandafter\edef\csname MT@tempsize\romannumeral\@tempcnta\endcsname{\MT@val}%
         \advance\@tempcnta \@ne
      }%
   }%
}
%    \end{macrocode}
%\end{macro}
%    \begin{macrocode}
\MT@declare@codes{prot}
\MT@declare@codes{exp}
%    \end{macrocode}
%\begin{macro}{\MT@define@expcodes@key}
% Some more options for the first argument to \cs{SetExpansion}.
%    \begin{macrocode}
\def\MT@define@expcodes@key#1{%
   \define@key{MT@expcodes}{#1}[]{%
      \MT@ifempty{##1}{}{%
         \expandafter\let\expandafter\@tempa\csname MT@expcodes@name\endcsname
%    \end{macrocode}
% A space terminates the number.
%    \begin{macrocode}
         \expandafter\gdef\csname MT@expcodes@\@tempa #1\endcsname{##1 }%
      }%
   }
}
%    \end{macrocode}
%\end{macro}
%    \begin{macrocode}
\MT@define@expcodes@key{stretch}
\MT@define@expcodes@key{shrink}
\MT@define@expcodes@key{step}
\define@key{MT@expcodes}{auto}[]{%
   \MT@ifempty{#1}{\def\@tempb{true}}{\def\@tempb{#1}}%
   \csname if\@tempb\endcsname
      \def\@tempb{autoexpand }%
   \else
      \def\@tempb{\relax}%
   \fi
   \expandafter\let\expandafter\@tempa\csname MT@expcodes@name\endcsname
   \expandafter\xdef\csname MT@expcodes@\@tempa auto\endcsname{\@tempb}%
}
%    \end{macrocode}
%\begin{macro}{\MT@permute}
%\begin{macro}{\MT@permute@}
%\begin{macro}{\MT@permute@@}
%\begin{macro}{\MT@permute@@@}
%\begin{macro}{\MT@permute@@@@}
%\begin{macro}{\MT@permute@@@@@}
% This permutation can surely be done in a more elegant way.
%    \begin{macrocode}
\newcount\MT@cnta
\newcount\MT@cntb
\newcount\MT@cntc
\newcount\MT@cntd
\newcount\MT@cnte
\def\MT@permute{%
   \MT@cnta=\@ne
   \MT@permute@
%    \end{macrocode}
% Set commands back to \cs{relax} for the next round.
%    \begin{macrocode}
   \MT@permute@reset
}
\def\MT@permute@{%
   \MT@cntb=\@ne
   \MT@permute@@
   \advance\MT@cnta\@ne
   \@ifundefined{MT@tempencoding\romannumeral\MT@cnta}{}%
      {\MT@permute@}%
}
\def\MT@permute@@{%
   \MT@cntc=\@ne
   \MT@permute@@@
   \advance\MT@cntb\@ne
   \@ifundefined{MT@tempfamily\romannumeral\MT@cntb}{}%
      {\MT@permute@@}%
}
\def\MT@permute@@@{%
   \MT@cntd=\@ne
   \MT@permute@@@@
   \advance\MT@cntc\@ne
   \@ifundefined{MT@tempseries\romannumeral\MT@cntc}{}%
      {\MT@permute@@@}%
}
\def\MT@permute@@@@{%
   \MT@cnte=\@ne
   \MT@permute@@@@@
   \advance\MT@cntd\@ne
   \@ifundefined{MT@tempshape\romannumeral\MT@cntd}{}%
      {\MT@permute@@@@}%
}
\def\MT@permute@@@@@{%
   \MT@permute@define{a}{encoding}%
   \MT@permute@define{b}{family}%
   \MT@permute@define{c}{series}%
   \MT@permute@define{d}{shape}%
   \MT@permute@define{e}{size}%
   \def\@tempa{\MT@tempencoding/\MT@tempfamily/\MT@tempseries/\MT@tempshape/\MT@tempsize}%
   \@ifundefined{MT@\MT@permutelist codes@\@tempa}{}%
      {\MT@warning{\MT@permutelist. list
            `\csname MT@\MT@permutelist codes@name\endcsname' will override list\MessageBreak
            `\csname MT@\MT@permutelist codes@\@tempa\endcsname' for font `\@tempa'}}%
   \expandafter\xdef\csname MT@\MT@permutelist codes@\@tempa\endcsname
      {\csname MT@\MT@permutelist codes@name\endcsname}%
%<debug>   \MT@info{initializing: use list for font \@tempa\@gobble}%
   \advance\MT@cnte\@ne
   \@ifundefined{MT@tempsize\romannumeral\MT@cnte}{}%
      {\MT@permute@@@@@}%
}
%    \end{macrocode}
%\end{macro}\end{macro}\end{macro}\end{macro}\end{macro}\end{macro}
%\begin{macro}{\MT@permute@define}
% Defining and resetting the commands.
%    \begin{macrocode}
\def\MT@permute@define#1#2{%
   \expandafter\@tempcnta\csname MT@cnt#1\endcsname
   \@ifundefined{MT@temp#2\romannumeral\@tempcnta}%
      {\expandafter\def\csname MT@temp#2\endcsname{}}%
      {\expandafter\edef\csname MT@temp#2\endcsname
         {\csname MT@temp#2\romannumeral\@tempcnta\endcsname}}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@permute@reset}
%    \begin{macrocode}
\def\MT@permute@reset{%
   \MT@permute@reset@{encoding}%
   \MT@permute@reset@{family}%
   \MT@permute@reset@{series}%
   \MT@permute@reset@{shape}%
   \MT@permute@reset@{size}%
}
%    \end{macrocode}
%\end{macro}
%\begin{macro}{\MT@permute@reset@}
%    \begin{macrocode}
\def\MT@permute@reset@#1{%
   \@tempcnta\@ne
   \loop
      \expandafter\let\csname MT@temp#1\romannumeral\@tempcnta\endcsname\relax
      \advance\@tempcnta\@ne
      \expandafter\ifx\csname MT@temp#1\romannumeral\@tempcnta\endcsname\relax\else\repeat
}
%</package>
%    \end{macrocode}
%\end{macro}
% \subsubsection{Declarations}
% We will now set up some default expansion and protrusion lists, and write them
% into the config files.
%    \begin{macrocode}
%<*config|cmr-config|pad-config|ppl-config|ptm-config>
% TO DO for the other fonts...
%<*config>

%% EXPANSION SETTINGS

%    \end{macrocode}
% These are the original settings from \thanh. They are default for \otOne{}
% encoding.
%    \begin{macrocode}
\SetExpansion
%<config>   [ name     = default ]
%<cmr-config>   [ name     = cmr-default ]
%<pad-config>   [ name     = pad-default ]
%<ppl-config>   [ name     = ppl-default ]
%<ptm-config>   [ name     = ptm-default ]
%<cmr-config>   { family   = cmr,
%<pad-config>   { family   = {pad,padx,padj},
%<ppl-config>   { family   = {ppl,pplx,pplj},
%<ptm-config>   { family   = {ptm,ptmx,ptmj},
%<config>   { encoding = OT1     }
%<!config>     encoding = {T1,LY1}    }
   {
     A = 500,     a = 700,
%<!config>     Ä = 500,     À = 500,    Á = 500,    Â = 500,    Ã = 500,    Å = 500,    Æ = 500,
%<!config>     ä = 700,     à = 700,    á = 700,    â = 700,    ã = 700,    å = 700,    æ = 700,
     B = 700,     b = 700,
     C = 700,     c = 700,
%<!config>     Ç = 700,     ç = 700,
     D = 500,     d = 700,
     E = 700,     e = 700,
%<!config>     Ë = 700,     È = 700,    É = 700,    Ê = 700,
%<!config>     ë = 700,     è = 700,    é = 700,    ê = 700,
     F = 700,
     G = 500,     g = 700,
     H = 700,     h = 700,
     K = 700,     k = 700,
     M = 700,     m = 700,
     N = 700,     n = 700,
%<!config>     Ñ = 700,     ñ = 700,
     O = 500,     o = 700,
%<!config>     Ö = 500,     Ò = 500,    Ó = 500,    Ô = 500,    Õ = 500,
%<!config>     ö = 700,     ò = 700,    ó = 700,    ô = 700,    õ = 700,
%<!config>      = 500,      = 700,
     P = 700,     p = 700,
     Q = 500,     q = 700,
     R = 700,
     S = 700,     s = 700,
     U = 700,     u = 700,
%<!config>     Ü = 700,     Ù = 700,    Ú = 700,    Û = 700,
%<!config>     ü = 700,     ù = 700,    ú = 700,    û = 700,
     W = 700,     w = 700,
     Z = 700,     z = 700,
     2 = 700,
     3 = 700,
     6 = 700,
     8 = 700,
     9 = 700,
   }
%</config>

%    \end{macrocode}
% Some additional characters for \tOne{} (and \lyOne) encoding. In \otOne{}
% encoding, they are composed of an accent and the base character, whose value
% they will inherit.
%    \begin{macrocode}
%<*config>
\SetExpansion
   [ name     = T1extra,
     load     = default  ]
   { encoding = {T1,LY1} }
   {
     Ä = 500,   À = 500,   Á = 500,   Â = 500,   Ã = 500,   Å = 500,   Æ = 500,
     ä = 700,   à = 700,   á = 700,   â = 700,   ã = 700,   å = 700,   æ = 700,
     Ë = 700,   È = 700,   É = 700,   Ê = 700,
     ë = 700,   è = 700,   é = 700,   ê = 700,
     Ö = 500,   Ò = 500,   Ó = 500,   Ô = 500,   Õ = 500,
     ö = 700,   ò = 700,   ó = 700,   ô = 700,   õ = 700,
     Ü = 700,   Ù = 700,   Ú = 700,   Û = 700,
     ü = 700,   ù = 700,   ú = 700,   û = 700,
     Ç = 700,   ç = 700,
     Ñ = 700,   ñ = 700,
      = 500,    = 700,
   }

%% PROTRUSION SETTINGS

%    \end{macrocode}
% Again, the original settings from \thanh.
%    \begin{macrocode}
\SetProtrusion
   [ name     = thanh ]
   { encoding = OT1   }
   {
     A = {50,50},
     F = { 0,50},
     J = {50, 0},
     K = { 0,50},     k = { 0,50},
     L = { 0,50},
                      r = { 0,50},
     T = {50,50},     t = { 0,50},
     V = {50,50},     v = {50,50},
     W = {50,50},     w = {50,50},
     X = {50,50},     x = {50,50},
     Y = {50,50},     y = {50,50},
     . = {0,700},    {,}= {0,700},
     : = {0,500},     ; = {0,500},
     ! = {0,200},     ? = {0,200},
     ( = {50,0},      ) = {0,50},
     - = {0,700},
     \textendash        = {0,300},     \textemdash        = {0,200},
     \textquoteleft     = {700,0},     \textquoteright    = {0,700},
     \textquotedblleft  = {500,0},     \textquotedblright = {0,500},
   }
%</config>
%<!config>%% PROTRUSION SETTINGS
%    \end{macrocode}
% Settings for fonts in \tOne{} or \lyOne{} encoding. We also create
% configuration files for the fonts Computer Modern Roman (\nfss{} code |cmr|),
% Palatino (|ppl|, |pplx|, |pplj|), Times New Roman (|ptm|, |ptmx|, |ptmj|) and
% Adobe Garamond (|pad|, |padx|, |padj|).
%
% The default settings always use the most moderate value.
%    \begin{macrocode}

\SetProtrusion
%<config>   [ name     = T1-default ]
%<cmr-config>   [ name     = cmr-default ]
%<pad-config>   [ name     = pad-default ]
%<ppl-config>   [ name     = ppl-default ]
%<ptm-config>   [ name     = ptm-default ]
%<config>   { encoding = {T1,LY1}   }
%<cmr-config>   { family   = cmr,
%<pad-config>   { family   = {pad,padx,padj},
%<ppl-config>   { family   = {ppl,pplx,pplj},
%<ptm-config>   { family   = {ptm,ptmx,ptmj},
%<!config>     encoding = {T1,LY1}    }
   {
     A = {50,50},     Ä = {50,50},     À = {50,50},     Á = {50,50},
     Â = {50,50},     Ã = {50,50},     Å = {50,50},     Æ = {50, 0},
%<pad-config>     C = {50, 0},     Ç = {50, 0},
%<pad-config>     D = { 0,50},
%<config|cmr-config|pad-config|ptm-config>     F = { 0,50},
%<pad-config>     G = {50, 0},
     J = {50, 0},
     K = { 0,50},     k = { 0,50},
%<config|cmr-config|pad-config|ppl-config>     L = { 0,50},
%<ptm-config>     L = { 0,80},
%<pad-config>     O = {50,50},     Ö = {50,50},     Ò = {50,50},     Ó = {50,50},
%<pad-config>     Ô = {50,50},     Õ = {50,50},     Ø = {50,50},      = {50, 0},
%<pad-config|ppl-config>                      p = {50,50},
%<pad-config>     Q = {50,70},     q = {50, 0},
%<ppl-config>                      q = {50, 0},
                      r = { 0,50},
%<cmr-config|pad-config>     T = {50,50},     t = { 0,70},
%<config|ppl-config|ptm-config>     T = {50,50},
     V = {50,50},     v = {50,50},
     W = {50,50},     w = {50,50},
     X = {50,50},     x = {50,50},
%<cmr-config|ppl-config>     Y = {50,50},     y = {50,70},
%<config|pad-config>     Y = {50,50},     y = { 0,50},
%<ptm-config>     Y = {80,80},     y = {50,70},
%<cmr-config|ppl-config>     7 = {0,100},
%<pad-config>     3 = {50, 0},     4 = {50, 0},     7 = {50,80},
%<ptm-config>     1 = {100,100},   4 = {50,0},      7 = {0,100},
%<cmr-config|ppl-config|ptm-config>     . = {0,700},    {,}= {0,700},
%<config|pad-config>     . = {0,700},    {,}= {0,500},
%<cmr-config|ppl-config>     : = {0,500},     ; = {0,500},
%<config|pad-config|ptm-config>     : = {0,500},     ; = {0,300},
%<cmr-config|ppl-config>     ! = {0,100},     ? = {0,200},
%<config|pad-config|ptm-config>     ! = {0,100},     ? = {0,100},
%<cmr-config|ppl-config>     ( = {100,0},     ) = {0,300},
%<config|pad-config|ptm-config>     ( = {100,0},     ) = {0,200},
%<cmr-config|ppl-config>     \ = {200,300},   / = {200,300},
%<config|pad-config|ptm-config>     \ = {100,200},   / = {100,200},
%<cmr-config|ppl-config>     - = {0,700},
%<config|pad-config|ptm-config>     - = {0,500},
     \textendash       = {300,300},   \textemdash        = {200,200},
%    \end{macrocode}
% Why settings for left \emph{and} right quotes? Because in some languages they
% might be used like that (see the \pkg{csquotes} package for example).
%    \begin{macrocode}
%<cmr-config|pad-config|ppl-config>     \textquoteleft    = {500,700},   \textquoteright    = {500,700},
%<config|ptm-config>     \textquoteleft    = {400,500},   \textquoteright    = {300,500},
%<cmr-config|ppl-config>     \textquotedblleft = {300,500},   \textquotedblright = {300,500},
%<pad-config>     \textquotedblleft = {400,500},   \textquotedblright = {400,500},
%<config|ptm-config>     \textquotedblleft = {300,400},   \textquotedblright = {300,400},
     \quotesinglbase   = {400,  0},   \quotedblbase      = {400,  0},
     \guilsinglleft    = {400,400},   \guilsinglright    = {300,500},
%<config>     \guillemotleft    = {300,300},   \guillemotright    = {300,300},
%<cmr-config>     \guillemotleft    = {300,200},   \guillemotright    = {100,400},
%<pad-config>     \guillemotleft    = {300,300},   \guillemotright    = {200,400},
%<ppl-config|ptm-config>     \guillemotleft    = {300,300},   \guillemotright    = {200,400},
   }

%    \end{macrocode}
% To find default settings for italic is difficult, since the character shapes
% and their behaviour at the beginning or end of line may be wildly different
% for different fonts. Therefore, we leave the letters away, and only set up the
% punctuation characters.
%    \begin{macrocode}
\SetProtrusion
%<config>   [ name     = T1-it    ]
%<cmr-config>   [ name     = cmr-it   ]
%<pad-config>   [ name     = pad-it   ]
%<ppl-config>   [ name     = ppl-it   ]
%<ptm-config>   [ name     = ptm-it   ]
   { shape    = it,
%<cmr-config>     family   = cmr,
%<pad-config>     family   = {pad,padx,padj},
%<ppl-config>     family   = {ppl,pplx,pplj},
%<ptm-config>     family   = {ptm,ptmx,ptmj},
     encoding = {T1,LY1} }
   {
%<cmr-config|ptm-config>     A = {100,50},    Ä = {100,50},    À = {100,50},    Á = {100,50},
%<cmr-config|ptm-config>     Â = {100,50},    Ã = {100,50},    Å = {100,50},    Æ = {100, 0},
%<pad-config>     A = {50, 0},     Ä = {50, 0},     À = {50, 0},     Á = {50, 0},
%<pad-config>     Â = {50, 0},     Ã = {50, 0},     Å = {50, 0},     Æ = {50, 0},
%<ppl-config>     A = {50,50},     Ä = {50,50},     À = {50,50},     Á = {50,50},
%<ppl-config>     Â = {50,50},     Ã = {50,50},     Å = {50,50},     Æ = {50, 0},
%<!config>     B = {50, 0},
%<cmr-config|pad-config>     C = {100,0},     Ç = {100,0},
%<ppl-config|ptm-config>     C = {50, 0},     Ç = {100,0},
%<!config>     D = {50,50},
%<!config>     E = {50, 0},     È = {50, 0},     É = {50, 0},     Ê = {50, 0},     Ë = {50, 0},
%<cmr-config|pad-config|ptm-config>     F = {100,0},
%<ppl-config>     F = {50,0},
%<cmr-config|pad-config>     G = {100,0},
%<ppl-config|ptm-config>     G = {50,0},
%<!config>     H = {50, 0},
%<cmr-config|pad-config|ptm-config>     I = {50, 0},     Ì = {50, 0},     Í = {50, 0},     Î = {50, 0},     Ï = {50, 0},
%<pad-config>     J = {50,0},
%<cmr-config|ptm-config>     J = {100,0},
%<!config>     K = {50, 0},
%<!config>     L = {50, 0},
%<cmr-config|ptm-config>     M = {50, 0},
%<cmr-config|ptm-config>     N = {50, 0},     Ñ = {50, 0},
%<cmr-config|pad-config>     O = {100,0},     Ö = {100,0},     Ò = {100,0},     Ó = {100,0},
%<cmr-config|pad-config>     Ô = {100,0},     Õ = {100,0},     Ø = {100,0},      = {100,0},
%<ppl-config|ptm-config>     O = {50, 0},     Ö = {50, 0},     Ò = {50, 0},     Ó = {50, 0},
%<ppl-config|ptm-config>     Ô = {50, 0},     Õ = {50, 0},     Ø = {50, 0},      = {50, 0},
%<!config>     P = {50, 0},
%<cmr-config|pad-config>     Q = {100,0},
%<ppl-config|ptm-config>     Q = {50, 0},
%<!config>     R = {50, 0},
%<!config>     S = {50, 0},
%<!config>     T = {100,0},
%<!config>     U = {50, 0},     Ü = {50, 0},     Ù = {50, 0},     Ú = {50, 0},     Û = {50, 0},
%<cmr-config|pad-config>     V = {100,0},
%<ppl-config|ptm-config>     V = {100,50},
%<cmr-config|pad-config>     W = {100,0},
%<ppl-config>     W = {50, 0},
%<ptm-config>     W = {100,50},
%<cmr-config|ppl-config|ptm-config>     X = {50, 0},
%<cmr-config|ptm-config>     Y = {100,0},
%<ppl-config>     Y = {100,50},
%<ptm-config>     1 = {100,50},
%<cmr-config|pad-config|ppl-config>     1 = {100,0},
%<!config>     2 = {50, 0},
%<ptm-config>     3 = {50, 0},
%<!config>     4 = {50, 0},
%<cmr-config|ptm-config>     7 = {100,0},
%<pad-config>     7 = {50, 0},
%<ppl-config>     7 = {50,50},
%<ppl-config>     ? = {0,300},
%<config|cmr-config|pad-config|ppl-config>     . = {0,500},    {,}= {0,500},
%<ptm-config>     . = {0,700},    {,}= {0,700},
%<config|cmr-config|pad-config|ppl-config>     : = {0,300},     ; = {0,300},
%<ptm-config>     : = {0,500},     ; = {0,500},
%<ptm-config>     ?  = {0,100},    ! = {0,100},
     ( = {200,0},     ) = {0,200},
     \ = {100,200},   / = {100,200},
%<cmr-config|ppl-config|ptm-config>     - = {0,500},
%<config|pad-config>     - = {0,300},
     \textendash        = {300,300},   \textemdash        = {200,200},
%<cmr-config|pad-config>     \textquoteleft     = {800,200},   \textquoteright    = {800,200},
%<config|ppl-config>     \textquoteleft     = {700,400},   \textquoteright    = {700,400},
%<ptm-config>     \textquoteleft     = {800,500},   \textquoteright    = {800,500},
%<cmr-config|pad-config>     \textquotedblleft  = {700,200},   \textquotedblright = {700,200},
%<config|ppl-config>     \textquotedblleft  = {500,300},   \textquotedblright = {500,300},
%<ptm-config>     \textquotedblleft  = {700,400},   \textquotedblright = {700,400},
%<config|cmr-config|ptm-config>     \quotesinglbase    = {300,  0},   \quotedblbase      = {400,  0},
%<pad-config|ppl-config>     \quotesinglbase    = {500,  0},   \quotedblbase      = {400,  0},
%<cmr-config>     \guilsinglleft     = {500,300},   \guilsinglright    = {400,400},
%<pad-config>     \guilsinglleft     = {500,400},   \guilsinglright    = {300,500},
%<config|ppl-config|ptm-config>     \guilsinglleft     = {400,400},   \guilsinglright    = {300,500},
%<cmr-config>     \guillemotleft     = {400,100},   \guillemotright    = {200,300},
%<pad-config>     \guillemotleft     = {300,300},   \guillemotright    = {200,400},
%<config|ppl-config>     \guillemotleft     = {300,300},   \guillemotright    = {300,300},
%<ptm-config>     \guillemotleft     = {300,400},   \guillemotright    = {200,400},
   }

%    \end{macrocode}
% Small caps should inherit the values from their big brothers. Since values are
% relative to character width, we don't need to adjust them.
%    \begin{macrocode}
\SetProtrusion
%<config>   [ name     = T1-sc,
%<cmr-config>   [ name     = cmr-sc,
%<pad-config>   [ name     = pad-sc,
%<ppl-config>   [ name     = ppl-sc,
%<ptm-config>   [ name     = ptm-sc,
%<config>     load     = T1-default ]
%<cmr-config>     load     = cmr-default ]
%<pad-config>     load     = pad-default ]
%<ppl-config>     load     = ppl-default ]
%<ptm-config>     load     = ptm-default ]
   { shape    = sc,
%<cmr-config>     family   = cmr,
%<pad-config>     family   = {pad,padx,padj},
%<ppl-config>     family   = {ppl,pplx,pplj},
%<ptm-config>     family   = {ptm,ptmx,ptmj},
     encoding = {T1,LY1} }
   {
     a = {50,50},     ä = {50,50},     à = {50,50},     á = {50,50},
     â = {50,50},     ã = {50,50},     å = {50,50},     æ = {50, 0},
%<pad-config>     d = { 0,50},
%<config|cmr-config|pad-config|ptm-config>     f = { 0,50},
%<pad-config>     g = {50, 0},
     j = {50, 0},
%<config|cmr-config|pad-config|ppl-config>     l = { 0,50},
%<ptm-config>     l = { 0,80},
%<pad-config>     o = {50,50},     ö = {50,50},     ò = {50,50},     ó = {50,50},
%<pad-config>     ô = {50,50},     õ = {50,50},     ø = {50,50},      = {50, 0},
%<ppl-config>     p = { 0, 0},
%<pad-config>     q = {50,70},
%<ppl-config>     q = { 0, 0},
     r = { 0, 0},
     t = {50,50},
%<config|cmr-config|pad-config|ppl-config>     y = {50,50},
%<ptm-config>     y = {80,80},
   }

\SetProtrusion
%<config>   [ name     = textcomp ]
%<cmr-config>   [ name     = cmr-textcomp ]
%<pad-config>   [ name     = pad-textcomp ]
%<ppl-config>   [ name     = ppl-textcomp ]
%<ptm-config>   [ name     = ptm-textcomp ]
%<config>   { encoding = TS1      }
%<cmr-config>   { family   = cmr,
%<pad-config>   { family   = {pad,padx,padj},
%<ppl-config>   { family   = {ppl,pplx,pplj},
%<ptm-config>   { family   = {ptm,ptmx,ptmj},
%<!config>     encoding = TS1  }
   {
%<cmr-config|pad-config|ppl-config>     \textminus      = {300,300},
%<config|ptm-config>     \textminus      = {200,200},
%<cmr-config|ppl-config>     \textcopyright  = {200,200},
%<config|pad-config|ptm-config>     \textcopyright  = {100,100},
%<cmr-config|ppl-config>     \texttrademark  = {200,200},
%<config|pad-config|ptm-config>     \texttrademark  = {100,100},
%<cmr-config|ppl-config>     \textregistered = {200,200},
%<config|pad-config|ptm-config>     \textregistered = {100,100},
%<cmr-config>     \textlangle     = {400,  0},
%<cmr-config>     \textrangle     = {  0,400},
%<cmr-config>     \textdegree     = {600,600},
%<pad-config>     \textdegree     = {500,500},
%<config|ppl-config|ptm-config>     \textdegree     = {300,300},
   }

%</config|cmr-config|pad-config|ppl-config|ptm-config>
%    \end{macrocode}
% We provide settings for \otOne{} encoding for Computer Modern Roman only.
% Why? Because `O' stands for `obsolete'.
%    \begin{macrocode}
%<*cmr-config>
\SetProtrusion
   [ name = cmr-OT1 ]
   { encoding = OT1,
     family   = cmr }
   {
     A = {50,50},
     F = { 0,50},
     J = {50, 0},
     K = { 0,50},     k = { 0,50},
     L = { 0,50},
                      r = { 0,50},
     T = {50,50},     t = { 0,70},
     V = {50,50},     v = {50,50},
     W = {50,50},     w = {50,50},
     X = {50,50},     x = {50,50},
     Y = {50,50},     y = {50,70},
     7 = {0,100},
     . = {0,700},    {,}= {0,700},
     : = {0,500},     ; = {0,500},
     ! = {0,100},     ? = {0,200},
     ( = {100,0},     ) = {0,300},
     \ = {200,300},   / = {200,300},
     - = {0,700},
     \textendash       = {300,300},   \textemdash        = {200,200},
     \textquoteleft    = {500,700},   \textquoteright    = {500,700},
     \textquotedblleft = {300,500},   \textquotedblright = {300,500},
   }

\SetProtrusion
   [ name = cmr-OT1-it ]
   { encoding = OT1,
     family   = cmr,
     shape    = it     }
   {
     A = {100,50},
     B = {50, 0},
     C = {100,0},
     D = {50,50},
     E = {50, 0},
     F = {100,0},
     G = {100,0},
     H = {50, 0},
     I = {50, 0},
     J = {100,0},
     K = {50, 0},
     L = {50, 0},
     M = {50, 0},
     N = {50, 0},
     O = {100,0},
     P = {50, 0},
     Q = {100,0},
     R = {50, 0},
     S = {50, 0},
     T = {100,0},
     U = {50, 0},
     V = {100,0},
     W = {100,0},
     X = {50, 0},
     Y = {100,0},
     1 = {100,0},
     2 = {50, 0},
     4 = {50, 0},
     7 = {100,0},
     . = {0,500},    {,}= {0,500},
     : = {0,300},     ; = {0,300},
     ( = {200,0},     ) = {0,200},
     \ = {100,200},   / = {100,200},
     - = {0,500},
     \textendash        = {300,300},   \textemdash        = {200,200},
     \textquoteleft     = {800,200},   \textquoteright    = {800,200},
     \textquotedblleft  = {700,200},   \textquotedblright = {700,200},
   }

\SetProtrusion
   [ name = cmr-OT1-sc,
     load = cmr-OT1    ]
   { encoding = OT1,
     family   = cmr,
     shape    = sc     }
   {
     a = {50,50},
     f = { 0,50},
     j = {50, 0},
     l = { 0,50},
     r = { 0, 0},
     t = {50,50},
     y = {50,50},
   }

%</cmr-config>
%    \end{macrocode}
%
% \subsection{User Command}
%\begin{macro}{\microtypesetup}
% This command may be used anywhere in the document. It accepts the options:
% |protrusion|, |expansion| and |activate|. Specifying font sets is not
% allowed.
%    \begin{macrocode}
%<*package>
\def\microtypesetup{\setkeys{MTX}}
\def\MT@define@optionX#1{%
   \define@key{MTX}{#1}[true]{%
      \@for\MT@val:=##1\do{%
         \expandafter\KV@@sp@def\expandafter\MT@val\expandafter{\MT@val}%
         \MT@ifempty{\MT@val}{}{%
            \@tempcnta\m@ne
            \def\@tempa{true}%
            \ifx\MT@val\@tempa
               \@tempcnta\MT@expansionlevel
               \MT@info{#1 enabled}%
               \let\MT@val\relax
            \fi
            \def\@tempa{false}%
            \ifx\MT@val\@tempa
               \@tempcnta\z@
               \MT@info{#1 disabled}%
               \let\MT@val\relax
            \fi
            \def\@tempa{compatibility}%
            \ifx\MT@val\@tempa
               \@tempcnta\@ne
               \MT@info{#1 set to level 1}%
               \let\MT@val\relax
            \fi
            \def\@tempa{nocompatibility}
            \ifx\MT@val\@tempa
               \@tempcnta\tw@
               \MT@info{#1 set to level 2}%
               \let\MT@val\relax
            \fi
            \ifx\MT@val\relax\else
               \MT@warning{Value `\MT@val' not recognized}%
            \fi
            \ifnum\@tempcnta>\m@ne
               \def\@tempa{expansion}%
               \def\@tempb{#1}%
               \ifx\@tempa\@tempb
                  \pdfadjustspacing\@tempcnta
               \else
                  \pdfprotrudechars\@tempcnta
               \fi
            \fi
         }%
      }%
   }%
}
\MT@define@optionX{protrusion}
\MT@define@optionX{expansion}
\define@key{MTX}{activate}[]{%
   \setkeys{MTX}{protrusion={#1}}%
   \setkeys{MTX}{expansion={#1}}%
}
%    \end{macrocode}
%\end{macro}
%
% \subsection{Package Options}
%\begin{macro}{\MT@define@option}
% |expansion| and |protrusion| may be |true|, |false|, |compatibility|,
% |nocompatibility| and/or a \meta{set name}.
%    \begin{macrocode}
\def\MT@define@option#1{%
   \define@key{MT}{#1}[]{%
      \@for\MT@val:=##1\do{%
         \expandafter\KV@@sp@def\expandafter\MT@val\expandafter{\MT@val}%
         \MT@ifempty{\MT@val}{}{%
            \def\@tempa{false}%
            \ifx\MT@val\@tempa
               \csname MT@#1false\endcsname
               \let\MT@val\relax
            \fi
            \def\@tempa{compatibility}%
            \ifx\MT@val\@tempa
               \expandafter\def\csname MT@#1level\endcsname{1}%
               \let\MT@val\relax
            \fi
            \def\@tempa{nocompatibility}
            \ifx\MT@val\@tempa
               \expandafter\def\csname MT@#1level\endcsname{2}%
               \let\MT@val\relax
            \fi
            \ifx\MT@val\relax\else
               \csname MT@#1true\endcsname
               \def\@tempa{true}%
               \ifx\MT@val\@tempa
               \else\MT@use@sets{#1}{\MT@val}\fi
            \fi
         }%
      }%
   }%
}
%    \end{macrocode}
%\end{macro}
%    \begin{macrocode}
\MT@define@option{protrusion}
\MT@define@option{expansion}
%    \end{macrocode}
% |activate| is a shortcut.
%    \begin{macrocode}
\define@key{MT}{activate}[]{%
   \setkeys{MT}{protrusion={#1}}%
   \setkeys{MT}{expansion={#1}}%
}
%    \end{macrocode}
% |stretch|, etc., have to end with a space to terminate the number.
%    \begin{macrocode}
\define@key{MT}{stretch}[20]{\def\MT@stretch{#1 }}
\define@key{MT}{shrink}[20]{\def\MT@shrink{#1 }}
\define@key{MT}{step}[2]{\def\MT@step{#1 }}
\define@key{MT}{auto}[true]{\csname MT@auto#1\endcsname}
\define@key{MT}{DVIoutput}[true]{\csname MT@DVIoutput#1\endcsname}
\define@key{MT}{verbose}[true]{\csname MT@verbose#1\endcsname}
%    \end{macrocode}
% |draft| may be inherited from the class options.
%    \begin{macrocode}
\define@key{MT}{draft}[true]{\csname MT@draft#1\endcsname}
%    \end{macrocode}
% Load the local configuration file before executing the package options.
%    \begin{macrocode}
\MT@info{%
  Trying to load local config file `microtype.cfg' ..\@gobble}
\InputIfFileExists{microtype.cfg}
  {\MT@info{%
    ... local config file loaded successfully\@gobble}}
  {\MT@info{%
    ... local config file not used\@gobble}}
%    \end{macrocode}
% Parse options.
%    \begin{macrocode}
\def\ProcessOptionsWithKV#1{%
  \let\@tempc\relax
  \let\KVo@tempa\@empty
  \@for\CurrentOption:=\@classoptionslist\do{%
    \@ifundefined{KV@#1@\CurrentOption}%
    {}%
    {%
      \edef\KVo@tempa{\KVo@tempa,\CurrentOption,}%
      \@expandtwoargs\@removeelement\CurrentOption
         \@unusedoptionlist\@unusedoptionlist
    }%
  }%
  \edef\KVo@tempa{%
    \noexpand\setkeys{#1}{%
      \KVo@tempa\@ptionlist{\@currname.\@currext}%
    }%
  }%
  \KVo@tempa
  \AtEndOfPackage{\let\@unprocessedoptions\relax}%
  \let\CurrentOption\@empty
}
\ProcessOptionsWithKV{MT}%
%    \end{macrocode}
% Now we can process the options:
%
% \pdftex{} can create \dvi{} output, too. However, both the \dvi{} viewer and
% dvips need to find actual fonts (in the form of |tfm| files). Therefore, this
% does not make too much sense unless one only wants the protrusion feature, or
% fonts for different degrees of expansion are readily available.
%    \begin{macrocode}
\ifMT@DVIoutput
   \ifMT@pdf
      \pdfoutput\z@
   \fi
\fi
%    \end{macrocode}
% Set up the numbers for font expansion: If |stretch| has not been specified, we
% take the default value of 20. If |shrink| has not been specified, it will get
% the same value as |stretch|.
% If both values have been set to 0, we will switch off expansion.
%
% If |step| has not been specified, we will set it to min(|stretch|,|shrink|)/10,
% rounded off, minimum value 1.
%    \begin{macrocode}
\ifMT@expansion
   \ifnum\MT@stretch=\m@ne
      \def\MT@stretch{20 }%
   \fi
   \ifnum\MT@shrink=\m@ne
      \ifnum\MT@stretch>\z@
         \let\MT@shrink\MT@stretch
      \else
         \def\MT@shrink{20 }%
      \fi
   \fi
   \ifnum\MT@stretch=\z@
      \ifnum\MT@shrink=\z@
         \MT@expansionfalse
      \fi
   \fi
   \ifnum\MT@step=\m@ne
      \ifnum\MT@stretch>\MT@shrink
         \ifnum\MT@shrink=\z@
            \@tempcnta=\MT@stretch
         \else
            \@tempcnta=\MT@shrink
         \fi
      \else
         \ifnum\MT@stretch=\z@
            \@tempcnta=\MT@shrink
         \else
            \@tempcnta=\MT@stretch
         \fi
      \fi
      \divide\@tempcnta by 10
   \else
      \@tempcnta=\MT@step
   \fi
   \ifnum\@tempcnta=\z@ \@tempcnta=\@ne\fi
   \edef\MT@step{\the\@tempcnta\space}%
\fi
%    \end{macrocode}
%\begin{macro}{\MT@auto}
% Automatic expansion of the font? This new feature of \pdftex{} 1.20a makes the
% \textit{hz}-algorithm really usable.
%
% Should we turn it off for |DVIoutput|?
%    \begin{macrocode}
\ifMT@auto
   \def\MT@auto{autoexpand}
\else
   \def\MT@auto{\relax}
\fi
%    \end{macrocode}
%\end{macro}
% Tell the log file which options the user has chosen (in case it's interested):
%    \begin{macrocode}
\ifMT@draft
   \MT@info{%
      `draft' option active.\MessageBreak
      Disabling all micro-typographic features\@gobble}
   \MT@protrusionfalse
   \MT@expansionfalse
\else
   \MT@info{%
      \ifMT@protrusion Character protrusion enabled (level \MT@protrusionlevel)%
      \else No character protrusion\fi\@gobble}
   \MT@info{%
      \ifMT@expansion\ifMT@auto Automatic f\else F\fi
         ont expansion enabled (level \MT@expansionlevel),\MessageBreak
         stretch: \MT@stretch, shrink: \MT@shrink, step: \MT@step
      \else No character expansion\fi\@gobble}
\fi
\MT@info{%
   Generating \ifnum\pdfoutput=\z@ DVI \else PDF \fi output\@gobble}
%    \end{macrocode}
% Finally, we enable the micro-typographic extensions, or we don't.
%    \begin{macrocode}
\ifMT@protrusion
   \pdfprotrudechars\MT@protrusionlevel
\fi
\ifMT@expansion
   \pdfadjustspacing\MT@expansionlevel
\fi
%</package>
%    \end{macrocode}
% That was it.
%
% ^^A From now on, don't bother indexing:
%\makeatletter\let\special@index\@gobble\makeatother
%
% \subsection{Auxiliary file for micro-fine tuning}
% This file can be used to test protrusion and expansion settings.
%    \begin{macrocode}
%<*auxiliary>
\documentclass{article}

%% Here you can set the font you want to test, using
%% the commands \fontfamily, \fontseries, and \fontshape.
%% Make sure to end all lines with a comment character!
\newcommand{\TestFont}{%
   \fontfamily{ppl}%
%%   \fontseries{b}%
%%   \fontshape{it}% sc, sl
}

\usepackage{ifthen}
\usepackage[T1]{fontenc}
\usepackage[ansinew]{inputenc}
\usepackage[verbose,expansion=normalfont,stretch=50]{microtype}

\pagestyle{empty}
\setlength{\parindent}{0pt}
\newcommand{\crulefill}{\cleaders\hbox{$\mkern-2mu\smash-\mkern-2mu$}\hfill}
\newcommand{\testprotrusion}[2][]{%
  \ifthenelse{\equal{#1}{r}}{}{#2}%
   lorem ipsum dolor sit amet,
     \ifthenelse{\equal{#1}{r}}{\crulefill}{\leftarrowfill} #2
     \ifthenelse{\equal{#1}{l}}{\crulefill}{\rightarrowfill}
   you know the rest%
  \ifthenelse{\equal{#1}{l}}{}{#2}%
   \linebreak
  {\fontencoding{\encodingdefault}\fontseries{\seriesdefault}\fontshape{\shapedefault}\selectfont
   Better not write anything that might \dotfill attract too much attention}\linebreak
}
\newcommand{\showTestFont}{\expandafter\stripprefix\meaning\TestFont}
\def\stripprefix#1>{}
\newcount\charcount
\begin{document}
\pdfadjustspacing=0

{\centering The font in this document is called by:\\
 \texttt{\showTestFont}\par}\bigskip

\TestFont\selectfont
 This line intentionally left empty\linebreak
%% A -- Z
\charcount=65
\loop
   \testprotrusion{\char\charcount}
   \advance\charcount 1
   \ifnum\charcount < 91 \repeat
%% a -- z
\charcount=97
\loop
   \testprotrusion{\char\charcount}
   \advance\charcount 1
   \ifnum\charcount < 123 \repeat
%% 0 -- 9
\charcount=48
\loop
   \testprotrusion{\char\charcount}
   \advance\charcount 1
   \ifnum\charcount < 58 \repeat
%%
 \testprotrusion[r]{,}
 \testprotrusion[r]{-}
 \testprotrusion[r]{.}
 \testprotrusion[r]{;}
 \testprotrusion[r]{:}
 \testprotrusion[r]{?}
 \testprotrusion[r]{!}
 \testprotrusion[r]{)}
 \testprotrusion[l]{(}
 \testprotrusion{/}
 \testprotrusion{\textbackslash}
 \testprotrusion{\textendash}
 \testprotrusion{\textemdash}
 \testprotrusion{\textquoteleft}
 \testprotrusion{\textquoteright}
 \testprotrusion{\textquotedblleft}
 \testprotrusion{\textquotedblright}
 \testprotrusion[l]{\quotesinglbase}
 \testprotrusion[l]{\quotedblbase}
 \testprotrusion{\guilsinglleft}
 \testprotrusion{\guilsinglright}
 \testprotrusion{\guillemotleft}
 \testprotrusion{\guillemotright}

\bigskip

The following displays the current font stretched by 5\%, normal, and shrunk by 5\%:

\bigskip

\newlength{\MTln}
\newcommand{\teststring}{ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789}
\settowidth{\MTln}{\teststring}
\pdfadjustspacing=2
\parbox{1.05\MTln}{\teststring\linebreak\\
                   \teststring}\par\bigskip
\parbox{0.95\MTln}{\teststring}
\end{document}
%</auxiliary>
%    \end{macrocode}
%
% ^^A -------------------------------------------------------------------------
% \CheckSum{2215}
% \CharacterTable
%  {Upper-case    \A\B\C\D\E\F\G\H\I\J\K\L\M\N\O\P\Q\R\S\T\U\V\W\X\Y\Z
%   Lower-case    \a\b\c\d\e\f\g\h\i\j\k\l\m\n\o\p\q\r\s\t\u\v\w\x\y\z
%   Digits        \0\1\2\3\4\5\6\7\8\9
%   Exclamation   \!     Double quote  \"     Hash (number) \#
%   Dollar        \$     Percent       \%     Ampersand     \&
%   Acute accent  \'     Left paren    \(     Right paren   \)
%   Asterisk      \*     Plus          \+     Comma         \,
%   Minus         \-     Point         \.     Solidus       \/
%   Colon         \:     Semicolon     \;     Less than     \<
%   Equals        \=     Greater than  \>     Question mark \?
%   Commercial at \@     Left bracket  \[     Backslash     \\
%   Right bracket \]     Circumflex    \^     Underscore    \_
%   Grave accent  \`     Left brace    \{     Vertical bar  \|
%   Right brace   \}     Tilde         \~}
% \Finale
\endinput
%
